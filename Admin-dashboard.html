<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SkyUltimate â€” Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex bg-gray-100 h-screen">

  <!-- Sidebar -->
  <aside class="w-64 bg-red-700 text-white flex flex-col p-4">
    <h2 class="text-2xl font-bold mb-6">Admin Panel</h2>
    <nav class="flex-1">
      <ul>
        <li><button onclick="showSection('orders')" class="w-full text-left py-2 hover:bg-red-800 rounded">Orders</button></li>
        <li><button onclick="showSection('agents')" class="w-full text-left py-2 hover:bg-red-800 rounded">Agents</button></li>
        <li><button onclick="showSection('customers')" class="w-full text-left py-2 hover:bg-red-800 rounded">Customers</button></li>
        <li><button onclick="showSection('support')" class="w-full text-left py-2 hover:bg-red-800 rounded">Support</button></li>
        <li><button onclick="showSection('profile')" class="w-full text-left py-2 hover:bg-red-800 rounded">Profile</button></li>
      </ul>
    </nav>
    <button onclick="logout()" class="bg-black py-2 rounded">Logout</button>
  </aside>

  <!-- Main content -->
  <main class="flex-1 p-6 overflow-y-auto">

    <!-- Orders Section -->
    <section id="orders" class="hidden">
      <h2 class="text-xl font-bold mb-4">Orders</h2>
      <div class="mb-2">
        <label class="mr-2">Filter by Status:</label>
        <select id="orderStatusFilter" class="p-2 border rounded" onchange="fetchOrders()">
          <option value="">All</option>
          <option value="PendingPaymentConfirmation">Pending Payment</option>
          <option value="PaymentConfirmed">Payment Confirmed</option>
          <option value="PickedUp">Picked Up</option>
          <option value="Delivered">Delivered</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>
      <table class="w-full bg-white rounded shadow mt-4">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="p-2">Customer</th>
            <th class="p-2">Pickup</th>
            <th class="p-2">Delivery</th>
            <th class="p-2">Status</th>
            <th class="p-2">Actions</th>
          </tr>
        </thead>
        <tbody id="ordersTable"></tbody>
      </table>
    </section>

    <!-- Agents Section -->
    <section id="agents" class="hidden">
      <h2 class="text-xl font-bold mb-4">Agents</h2>
      <table class="w-full bg-white rounded shadow">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="p-2">Name</th>
            <th class="p-2">Email</th>
            <th class="p-2">Availability</th>
            <th class="p-2">Revenue</th>
          </tr>
        </thead>
        <tbody id="agentsTable"></tbody>
      </table>
    </section>

    <!-- Customers Section -->
    <section id="customers" class="hidden">
      <h2 class="text-xl font-bold mb-4">Customers</h2>
      <table class="w-full bg-white rounded shadow">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="p-2">Name</th>
            <th class="p-2">Email</th>
            <th class="p-2">Orders Count</th>
          </tr>
        </thead>
        <tbody id="customersTable"></tbody>
      </table>
    </section>

    <!-- Support Section -->
    <section id="support" class="hidden">
      <h2 class="text-xl font-bold mb-4">Support Requests</h2>
      <p class="text-gray-600">Coming soon: Support tickets integration.</p>
    </section>

    <!-- Profile Section -->
    <section id="profile" class="hidden">
      <h2 class="text-xl font-bold mb-4">My Profile</h2>
      <form id="bankForm" class="bg-white p-4 rounded shadow w-full max-w-md">
        <label class="block mb-2">Bank Details</label>
        <input type="text" id="bankDetails" class="w-full p-2 border rounded mb-4" />
        <button type="submit" class="bg-red-700 text-white py-2 px-4 rounded">Update</button>
      </form>
    </section>
  </main>

  <script>
    const API_BASE = "https://skyultimate-backend-api-structure.onrender.com";
    const token = localStorage.getItem("token");

    if (!token) window.location.href = "index.html"; // Not logged in

    // Section toggle
    function showSection(id) {
      document.querySelectorAll("main section").forEach(s => s.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");

      if (id === "orders") fetchOrders();
      if (id === "agents") fetchAgents();
      if (id === "customers") fetchCustomers();
      if (id === "profile") fetchProfile();
    }

    // Fetch Orders
    async function fetchOrders() {
      const status = document.getElementById("orderStatusFilter").value;
      const res = await fetch(`${API_BASE}/orders`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      const filtered = status ? data.filter(o => o.status === status) : data;
      const tbody = document.getElementById("ordersTable");
      tbody.innerHTML = filtered.map(o => `
        <tr class="border-t">
          <td class="p-2">${o.customer?.name || "N/A"}</td>
          <td class="p-2">${o.pickupAddress}</td>
          <td class="p-2">${o.deliveryAddress}</td>
          <td class="p-2">${o.status}</td>
          <td class="p-2">
            ${o.status === "PendingPaymentConfirmation" 
              ? `<button onclick="confirmPayment('${o._id}')" class="bg-green-600 text-white px-3 py-1 rounded">Confirm</button>` 
              : ""}
          </td>
        </tr>
      `).join("");
    }

    // Confirm Payment
    async function confirmPayment(orderId) {
      await fetch(`${API_BASE}/orders/${orderId}/confirm-payment`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` }
      });
      fetchOrders();
    }

    // Fetch Agents
    async function fetchAgents() {
      const res = await fetch(`${API_BASE}/users?role=Agent`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      const tbody = document.getElementById("agentsTable");
      tbody.innerHTML = data.map(a => `
        <tr class="border-t">
          <td class="p-2">${a.name}</td>
          <td class="p-2">${a.email}</td>
          <td class="p-2">${a.isAvailable ? "Available" : "Unavailable"}</td>
          <td class="p-2">$${a.revenue || 0}</td>
        </tr>
      `).join("");
    }

    // Fetch Customers
    async function fetchCustomers() {
      const res = await fetch(`${API_BASE}/users?role=Customer`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      const tbody = document.getElementById("customersTable");
      tbody.innerHTML = data.map(c => `
        <tr class="border-t">
          <td class="p-2">${c.name}</td>
          <td class="p-2">${c.email}</td>
          <td class="p-2">${c.orderCount || 0}</td>
        </tr>
      `).join("");
    }

    // Profile
    async function fetchProfile() {
      const res = await fetch(`${API_BASE}/users/profile`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const profile = await res.json();
      document.getElementById("bankDetails").value = profile.bankDetails || "";
    }

    document.getElementById("bankForm").addEventListener("submit", async e => {
      e.preventDefault();
      const bank = document.getElementById("bankDetails").value;
      await fetch(`${API_BASE}/users/me/bank`, {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify({ bankDetails: bank })
      });
      alert("Bank details updated");
    });

    // Logout
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }

    // Default load orders
    showSection('orders');
  </script>
</body>
</html>

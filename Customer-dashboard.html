<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SkyUltimate — Customer Dashboard</title>

  <!-- Tailwind CDN for utility styles -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Embedded premium styling */
    :root{
      --brand-red: #C00000;
      --brand-red-dark: #940000;
      --glass: rgba(255,255,255,0.92);
      --card-radius: 18px;
      --shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    html,body { height:100%; margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    body.light { background: linear-gradient(180deg,#fff 0%, #fff 100%); color:#111; }
    body.dark { background: linear-gradient(180deg,#0b1020 0%, #071029 100%); color:#e6eefb; }
    .app-bg { background: linear-gradient(180deg,var(--brand-red) 0%, #9a0000 100%); min-height:100vh; padding-bottom: 100px; }
    .card { background: var(--glass); border-radius: var(--card-radius); box-shadow: var(--shadow); padding: 16px; }
    .rounded-logo { width:56px; height:56px; border-radius:999px; object-fit:cover; box-shadow: 0 8px 24px rgba(0,0,0,0.24); }
    .btn { background:var(--brand-red); color:#fff; padding:10px 14px; border-radius:12px; font-weight:700; }
    .btn-outline { background:transparent; color:var(--brand-red); border:2px solid rgba(255,255,255,0.12); padding:8px 12px; border-radius:10px; font-weight:700; }
    .glass-soft { background: rgba(255,255,255,0.06); border-radius:14px; padding:10px; }
    .toast { position: fixed; right: 20px; bottom: 20px; z-index:10000; min-width:260px; border-radius:12px; padding:12px 16px; box-shadow:0 8px 30px rgba(0,0,0,0.24); color:#fff; }
    .toast.success{ background:#16a34a } .toast.error{ background:#b91c1c } .toast.info{ background:#0ea5e9 }
    .overlay-full { position: fixed; inset:0; background: rgba(3,7,18,0.6); z-index:2000; display:flex; align-items:center; justify-content:center; }
    .hidden { display:none; }
    /* map container */
    #map { width:100%; height:260px; border-radius:12px; overflow:hidden; }
    /* hamburger overlay screens take full content area */
    .panel-screen { position: fixed; inset: 72px 12px 12px 12px; z-index:1500; overflow:auto; border-radius:14px; padding:18px; box-shadow: var(--shadow); background: rgba(255,255,255,0.96); }
    .dark .panel-screen { background: rgba(8,10,20,0.95); color:#e6eefb; }
    .chip { background: rgba(255,255,255,0.85); padding:6px 10px; border-radius:999px; font-weight:600; }
    .muted { color: #6b7280; }
    /* small screens adjustments */
    @media (max-width:640px){
      .panel-screen { inset: 72px 8px 8px 8px; padding:12px; }
    }
  </style>
</head>
<body class="app-bg light">

  <!-- APP SHELL -->
  <div class="max-w-4xl mx-auto pt-6">

    <!-- HEADER -->
    <header class="flex items-center justify-between px-3 mb-6">
      <div class="flex items-center gap-3">
        <img class="rounded-logo" src="https://github.com/Nelson192006/SkyUltimate-/blob/62343ff3e5e556aa02ecece40e2c006fa9161c0a/logo.png?raw=true" alt="logo">
        <!-- No text beside logo as requested -->
        <div id="welcomeWrap" class="ml-2">
          <div id="welcomeMsg" class="text-white text-lg font-semibold">Welcome!</div>
          <div id="welcomeSub" class="text-white/90 text-sm muted">Your hub</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="themeToggle" class="btn-outline">Dark</button>
        <button id="menuBtn" class="btn-outline">Menu</button>
        <button id="logoutBtn" class="btn" title="Logout">Logout</button>
      </div>
    </header>

    <!-- MAIN GRID -->
    <main id="mainContent" class="grid grid-cols-1 gap-4 px-3">

      <!-- ANNOUNCEMENT (dynamic) -->
      <section id="announcementBox" class="card hidden">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div id="announceTitle" class="text-red-700 font-bold"></div>
            <div id="announceBody" class="text-sm mt-1 muted"></div>
          </div>
          <div>
            <button id="dismissAnnouncement" class="btn-outline">Dismiss</button>
          </div>
        </div>
      </section>

      <!-- HERO/REFERRAL -->
      <section class="card flex items-center justify-between gap-4">
        <div>
          <h2 id="heroGreeting" class="text-xl font-bold">Hello, <span id="firstName">there</span> 👋</h2>
          <p class="muted text-sm mt-1">Ready to send something? Place an order or view your history.</p>
        </div>
        <div class="text-right">
          <div class="muted text-xs">Your Referral</div>
          <div id="refCode" class="font-mono text-lg font-bold">—</div>
          <div class="mt-2 flex gap-2 justify-end">
            <button id="copyRef" class="btn-outline">Copy</button>
            <button id="shareRef" class="btn">Share</button>
          </div>
        </div>
      </section>

      <!-- ORDER PLACEMENT -->
      <section id="placementCard" class="card">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Place a New Order</h3>
          <div class="muted text-sm">Choose service & details</div>
        </div>

        <div class="mt-3 grid grid-cols-1 gap-3">
          <input id="pickup" placeholder="Pickup address" class="w-full border rounded px-3 py-2" />
          <input id="pickupContact" placeholder="Pickup contact name & phone" class="w-full border rounded px-3 py-2" />
          <input id="dropoff" placeholder="Delivery address" class="w-full border rounded px-3 py-2" />
          <input id="dropoffContact" placeholder="Recipient name & phone" class="w-full border rounded px-3 py-2" />
          <div class="flex gap-2">
            <input id="itemType" placeholder="Item type (Documents, Parcel)" class="flex-1 border rounded px-3 py-2" />
            <input id="weight" type="number" min="0" placeholder="Weight (kg)" class="w-40 border rounded px-3 py-2" />
          </div>
          <div class="flex gap-2 items-center">
            <select id="serviceType" class="border rounded px-3 py-2">
              <option value="standard">Standard</option>
              <option value="express">Express</option>
              <option value="same-day">Same-day</option>
            </select>

            <button id="calcPrice" class="btn ml-auto">Calculate Final Price</button>
            <button id="submitOrder" class="btn-outline">Confirm & Await Admin Approval</button>
          </div>
          <div id="calcMsg" class="text-sm text-red-600 mt-1"></div>
        </div>
      </section>

      <!-- PRICE MODAL (hidden) -->
      <div id="priceModal" class="overlay-full hidden">
        <div class="card w-full max-w-xl">
          <h3 class="text-xl font-semibold">Final Price</h3>
          <div class="mt-3">
            <div id="finalPrice" class="text-3xl font-bold">₦0</div>
            <div class="muted text-sm mt-2">Pay via bank transfer to:</div>
            <div class="mt-2">
              <div id="bankName" class="font-bold">SkyUltimate Bank</div>
              <div id="bankAccount" class="muted">0000000000</div>
              <div id="bankHolder" class="muted">SkyUltimate</div>
            </div>
            <div class="mt-3 text-sm muted">After payment, the Admin will confirm and your order will move to tracking.</div>
          </div>
          <div class="mt-4 flex gap-2">
            <button id="closePrice" class="btn-outline flex-1">Close</button>
            <button id="iPaid" class="btn flex-1">I have Paid (Simulate)</button>
          </div>
        </div>
      </div>

      <!-- TRACKING HUB -->
      <section id="trackingCard" class="card hidden">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold">Order Tracking</h3>
            <div class="muted text-sm" id="trackSub">Realtime updates below</div>
          </div>
          <div>
            <button id="closeTracking" class="btn-outline">Close</button>
          </div>
        </div>

        <div class="mt-3 grid grid-cols-1 gap-3">
          <div id="map" class="rounded-lg"></div>
          <div class="flex items-center justify-between">
            <div>
              <div class="muted text-xs">Order ID</div>
              <div id="trackId" class="font-mono font-semibold">—</div>
            </div>
            <div>
              <div class="muted text-xs">Status</div>
              <div id="trackStatus" class="font-semibold">—</div>
            </div>
            <div>
              <button id="callAgent" class="btn-outline hidden">Call Agent</button>
            </div>
          </div>
          <div id="timeline" class="mt-2"></div>
        </div>
      </section>

      <!-- ORDER HISTORY (compact list) -->
      <section id="historyCard" class="card">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Order History</h3>
          <div class="muted text-sm">Recent orders</div>
        </div>
        <div id="historyList" class="mt-3 space-y-3 text-sm">
          Loading...
        </div>
      </section>

      <!-- INFO: Mission / Vision / FAQ -->
      <section class="card">
        <h3 class="text-lg font-semibold">About SkyUltimate</h3>
        <p class="muted mt-2">Welcome to SkyUltimate Delivery Services — your trusted partner for swift, secure, and reliable delivery solutions in Lagos.</p>

        <div class="mt-4 grid grid-cols-1 gap-3">
          <div>
            <h4 class="font-semibold">Our Mission</h4>
            <p class="muted text-sm mt-1">Provide the most efficient, transparent, and reliable delivery services in Lagos — empowering businesses and individuals.</p>
          </div>
          <div>
            <h4 class="font-semibold">Our Vision</h4>
            <p class="muted text-sm mt-1">To be the leading and most preferred delivery service provider in Nigeria, known for reliability and technological excellence.</p>
          </div>

          <div>
            <h4 class="font-semibold mb-2">FAQ / Support</h4>

            <div class="space-y-2">
              <details class="border rounded p-3">
                <summary class="font-medium">What are your operating hours?</summary>
                <div class="mt-2 muted text-sm">We operate from 8:00 AM to 6:00 PM, Monday to Saturday.</div>
              </details>

              <details class="border rounded p-3">
                <summary class="font-medium">What areas in Lagos do you cover?</summary>
                <div class="mt-2 muted text-sm">Coverage across Ikeja, Victoria Island, Lekki, Surulere and many mainland areas. Contact support if unsure.</div>
              </details>

              <details class="border rounded p-3">
                <summary class="font-medium">How can I place a delivery order?</summary>
                <div class="mt-2 muted text-sm">Use the "Place a New Order" section above or call our support hotline with pickup/drop details.</div>
              </details>

              <details class="border rounded p-3">
                <summary class="font-medium">What payment methods do you accept?</summary>
                <div class="mt-2 muted text-sm">Currently Transfer (bank transfer). You'll see bank details at checkout.</div>
              </details>

              <details class="border rounded p-3">
                <summary class="font-medium">How can I track my delivery?</summary>
                <div class="mt-2 muted text-sm">After payment confirmation, tracking appears on this page with live agent location (if assigned).</div>
              </details>

              <details class="border rounded p-3">
                <summary class="font-medium">What if my package is delayed or missing?</summary>
                <div class="mt-2 muted text-sm">Contact support immediately with your tracking number. We'll investigate and work on a solution.</div>
              </details>

              <details class="border rounded p-3">
                <summary class="font-medium">How do you calculate delivery fees?</summary>
                <div class="mt-2 muted text-sm">Fees are based on distance, weight and service type. Use "Calculate Final Price" to preview fees.</div>
              </details>
            </div>
          </div>
        </div>

      </section>

      <!-- FOOTER CONTACT -->
      <footer class="mt-6 text-center muted">
        <div>Contact: <a id="phoneLink" class="underline" href="tel:+2349128884830">+234 912 888 4830</a> · <a id="whatsappLink" class="underline" target="_blank" href="https://wa.me/2349128884830">WhatsApp</a> · <a id="emailLink" class="underline" href="mailto:nelsongodspower24@gmail.com">Email</a></div>
      </footer>

    </main>
  </div>

  <!-- HAMBURGER OVERLAY / PANEL (replaces main content when open) -->
  <div id="panelOverlay" class="hidden">
    <div class="panel-screen max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <img class="w-12 h-12 rounded-full" src="https://github.com/Nelson192006/SkyUltimate-/blob/62343ff3e5e556aa02ecece40e2c006fa9161c0a/logo.png?raw=true" alt="logo">
          <div>
            <div id="panelUserName" class="font-bold">User</div>
            <div id="panelUserRole" class="text-sm muted">Role</div>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="closePanel" class="btn-outline">Close</button>
          <button id="panelLogout" class="btn">Logout</button>
        </div>
      </div>

      <nav class="grid grid-cols-1 gap-3">
        <button class="p-3 text-left border rounded" data-panel="profile">My Profile</button>
        <button class="p-3 text-left border rounded" data-panel="history">Order History</button>
        <button class="p-3 text-left border rounded" data-panel="referrals">Refer & Earn</button>
        <button class="p-3 text-left border rounded" data-panel="announcements">Announcements</button>
        <button class="p-3 text-left border rounded" data-panel="rate">Rate Agent</button>
        <button class="p-3 text-left border rounded" data-panel="report">Report Agent</button>
        <button class="p-3 text-left border rounded" data-panel="support">Support</button>
        <button class="p-3 text-left border rounded" data-panel="settings">Settings</button>
      </nav>

      <div id="panelContent" class="mt-6"></div>
    </div>
  </div>

  <!-- PROFILE MODAL (simple) -->
  <div id="profileModal" class="overlay-full hidden">
    <div class="card w-full max-w-lg">
      <h3 class="text-lg font-semibold">My Profile</h3>
      <div class="mt-3 grid gap-2">
        <input id="profileName" class="border rounded px-3 py-2" placeholder="Full name" />
        <input id="profileEmail" class="border rounded px-3 py-2" placeholder="Email" readonly />
        <input id="profilePhone" class="border rounded px-3 py-2" placeholder="Phone" />
        <div id="profileBankFields" class="hidden">
          <input id="profileBankName" class="border rounded px-3 py-2" placeholder="Bank name" />
          <input id="profileAccountNumber" class="border rounded px-3 py-2" placeholder="Account number" />
          <input id="profileAccountHolder" class="border rounded px-3 py-2" placeholder="Account holder" />
        </div>
        <div class="flex gap-2">
          <button id="saveProfile" class="btn flex-1">Save</button>
          <button id="closeProfile" class="btn-outline flex-1">Close</button>
        </div>
        <div id="profileMsg" class="text-sm text-green-600"></div>
      </div>
    </div>
  </div>

  <!-- RATE / REPORT MODALS -->
  <div id="rateModal" class="overlay-full hidden">
    <div class="card w-full max-w-md">
      <h3 class="text-lg font-semibold">Rate Agent</h3>
      <div class="mt-3">
        <div id="starRow" class="flex gap-1 text-2xl">⭐⭐⭐⭐⭐</div>
        <textarea id="rateComment" placeholder="Add a comment (optional)" class="w-full border rounded px-3 py-2 mt-3"></textarea>
        <div class="flex gap-2 mt-3">
          <button id="submitRating" class="btn flex-1">Submit Rating</button>
          <button id="closeRate" class="btn-outline flex-1">Close</button>
        </div>
        <div id="rateMsg" class="text-sm text-green-600 mt-2"></div>
      </div>
    </div>
  </div>

  <div id="reportModal" class="overlay-full hidden">
    <div class="card w-full max-w-md">
      <h3 class="text-lg font-semibold">Report Agent</h3>
      <div class="mt-3">
        <select id="reportType" class="border rounded px-3 py-2 w-full">
          <option value="late">Late Delivery</option>
          <option value="rude">Rude Behavior</option>
          <option value="lost">Lost Package</option>
          <option value="other">Other</option>
        </select>
        <textarea id="reportDetails" placeholder="Describe the issue" class="w-full border rounded px-3 py-2 mt-3"></textarea>
        <div class="flex gap-2 mt-3">
          <button id="submitReport" class="btn flex-1">Send Report</button>
          <button id="closeReport" class="btn-outline flex-1">Close</button>
        </div>
        <div id="reportMsg" class="text-sm text-green-600 mt-2"></div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toastContainer"></div>

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDu1dptqgTwWWD6568jhf_tal7uYfdyMlQ&libraries=places"></script>

<script>
/*
  Full single-file Customer Dashboard
  - Wires to your API_BASE (change if needed)
  - Uses localStorage.su_token and localStorage.su_user
  - All buttons are functional and call appropriate endpoints (per earlier chat)
  - If an endpoint is not yet implemented server-side, the UI will surface the error
*/

const API_BASE = "https://skyultimate-backend-api-structure.onrender.com";
const token = localStorage.getItem('su_token');
let currentUser = null;
try { currentUser = JSON.parse(localStorage.getItem('su_user') || 'null'); } catch(e){ currentUser = null; }

if (!token || !currentUser) {
  // not authenticated -> redirect to login
  window.location.href = 'index.html';
}

// ---------- helper: toast ----------
function showToast(type='info', msg='', timeout=3500) {
  const id = 't'+Date.now();
  const el = document.createElement('div');
  el.id = id;
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=> el.classList.add('visible'), 50);
  setTimeout(()=> { el.remove(); }, timeout);
}

// ---------- helper: apiFetch ----------
async function apiFetch(path, opts = {}) {
  const headers = (opts.headers || {});
  headers['Content-Type'] = headers['Content-Type'] || 'application/json';
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(API_BASE + path, { ...opts, headers });
  if (res.status === 401) {
    showToast('error', 'Session expired. Redirecting to login...');
    localStorage.removeItem('su_token');
    localStorage.removeItem('su_user');
    setTimeout(()=> window.location.href='index.html', 900);
    throw new Error('Unauthorized');
  }
  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch(e) { data = text; }
  if (!res.ok) {
    const errMsg = data && (data.message || data.error) ? (data.message || data.error) : `HTTP ${res.status}`;
    throw new Error(errMsg);
  }
  return data;
}

// ---------- UI refs ----------
const firstNameEl = document.getElementById('firstName');
const heroGreeting = document.getElementById('heroGreeting');
const refCodeEl = document.getElementById('refCode');
const copyRef = document.getElementById('copyRef');
const shareRef = document.getElementById('shareRef');

const calcPriceBtn = document.getElementById('calcPrice');
const submitOrderBtn = document.getElementById('submitOrder');
const priceModal = document.getElementById('priceModal');
const finalPriceEl = document.getElementById('finalPrice');
const bankNameEl = document.getElementById('bankName');
const bankAccountEl = document.getElementById('bankAccount');
const bankHolderEl = document.getElementById('bankHolder');
const closePrice = document.getElementById('closePrice');
const iPaidBtn = document.getElementById('iPaid');
const calcMsg = document.getElementById('calcMsg');

const trackingCard = document.getElementById('trackingCard');
const trackingMapEl = document.getElementById('map');
const trackIdEl = document.getElementById('trackId');
const trackStatusEl = document.getElementById('trackStatus');
const timelineEl = document.getElementById('timeline');
const closeTracking = document.getElementById('closeTracking');
const callAgentBtn = document.getElementById('callAgent');

const historyList = document.getElementById('historyList');

const announcementBox = document.getElementById('announcementBox');
const announceTitle = document.getElementById('announceTitle');
const announceBody = document.getElementById('announceBody');
const dismissAnnouncement = document.getElementById('dismissAnnouncement');

const menuBtn = document.getElementById('menuBtn');
const panelOverlay = document.getElementById('panelOverlay');
const closePanel = document.getElementById('closePanel');
const panelContent = document.getElementById('panelContent');
const panelUserName = document.getElementById('panelUserName');
const panelUserRole = document.getElementById('panelUserRole');
const panelLogout = document.getElementById('panelLogout');

const logoutBtn = document.getElementById('logoutBtn');

const themeToggle = document.getElementById('themeToggle');

const profileModal = document.getElementById('profileModal');
const profileName = document.getElementById('profileName');
const profileEmail = document.getElementById('profileEmail');
const profilePhone = document.getElementById('profilePhone');
const profileBankFields = document.getElementById('profileBankFields');
const profileBankName = document.getElementById('profileBankName');
const profileAccountNumber = document.getElementById('profileAccountNumber');
const profileAccountHolder = document.getElementById('profileAccountHolder');
const saveProfile = document.getElementById('saveProfile');
const closeProfile = document.getElementById('closeProfile');
const profileMsg = document.getElementById('profileMsg');

const rateModal = document.getElementById('rateModal');
const rateComment = document.getElementById('rateComment');
const submitRating = document.getElementById('submitRating');
const closeRate = document.getElementById('closeRate');
const starRow = document.getElementById('starRow');
const rateMsg = document.getElementById('rateMsg');

const reportModal = document.getElementById('reportModal');
const reportType = document.getElementById('reportType');
const reportDetails = document.getElementById('reportDetails');
const submitReport = document.getElementById('submitReport');
const closeReport = document.getElementById('closeReport');
const reportMsg = document.getElementById('reportMsg');

const placementCard = document.getElementById('placementCard');

// order form fields
const pickupInput = document.getElementById('pickup');
const pickupContactInput = document.getElementById('pickupContact');
const dropoffInput = document.getElementById('dropoff');
const dropoffContactInput = document.getElementById('dropoffContact');
const itemTypeInput = document.getElementById('itemType');
const weightInput = document.getElementById('weight');
const serviceInput = document.getElementById('serviceType');

// ---------- state ----------
let lastCalc = null;
let activeOrder = null;
let map = null;
let agentMarker = null;
let pollingInterval = null;
let selectedRating = 5;

// ---------- initialize UI ----------
function initUI() {
  // set first name
  const name = currentUser.name || (currentUser.fullName) || "there";
  const first = String(name).split(' ')[0] || 'there';
  firstNameEl.innerText = first;
  heroGreeting.innerText = `Hello, ${first}!`;

  // referral code
  const referralCode = currentUser.referralCode || (currentUser._id ? ('REF'+String(currentUser._id).slice(-6)) : 'REF-UNKNOWN');
  refCodeEl.innerText = referralCode;

  // panel user info
  panelUserName.innerText = name;
  panelUserRole.innerText = (currentUser.role || 'Customer');

  // profile modal populate
  profileName.value = currentUser.name || '';
  profileEmail.value = currentUser.email || '';
  profilePhone.value = currentUser.phone || '';
  if ((currentUser.role || '').toLowerCase() === 'agent' || (currentUser.role || '').toLowerCase() === 'admin') {
    profileBankFields.classList.remove('hidden');
    profileBankName.value = (currentUser.bankDetails || {}).bankName || '';
    profileAccountNumber.value = (currentUser.bankDetails || {}).accountNumber || '';
    profileAccountHolder.value = (currentUser.bankDetails || {}).accountHolderName || '';
  } else {
    profileBankFields.classList.add('hidden');
  }

  // events
  copyRef.addEventListener('click', async ()=> {
    try { await navigator.clipboard.writeText(`${location.origin}/signup?ref=${referralCode}`); showToast('success','Referral link copied'); }
    catch(e){ showToast('error','Copy failed'); }
  });
  shareRef.addEventListener('click', async ()=> {
    const link = `${location.origin}/signup?ref=${referralCode}`;
    try {
      if (navigator.share) await navigator.share({ title:'Join SkyUltimate', text:'Use my link', url:link});
      else { await navigator.clipboard.writeText(link); showToast('success','Referral link copied'); }
    } catch(e){ showToast('error','Share failed'); }
  });

  // price & order
  calcPriceBtn.addEventListener('click', onCalcPrice);
  closePrice.addEventListener('click', ()=> priceModal.classList.add('hidden'));
  iPaidBtn.addEventListener('click', onIPaid);
  submitOrderBtn.addEventListener('click', onSubmitOrder);

  // tracking
  closeTracking.addEventListener('click', ()=> {
    trackingCard.classList.add('hidden');
    if (pollingInterval) clearInterval(pollingInterval);
    pollingInterval = null;
  });

  // menu
  menuBtn.addEventListener('click', openPanel);
  closePanel.addEventListener('click', closePanelFunc);
  panelLogout.addEventListener('click', ()=> { doLogout(); });

  logoutBtn.addEventListener('click', ()=> { doLogout(); });

  themeToggle.addEventListener('click', toggleTheme);

  // profile modal
  document.getElementById('panelContent'); // used later
  document.querySelectorAll('[data-panel]').forEach(btn => {
    btn.addEventListener('click', ()=> openPanelSection(btn.getAttribute('data-panel')));
  });

  closeProfile.addEventListener('click', ()=> profileModal.classList.add('hidden'));
  saveProfile.addEventListener('click', onSaveProfile);

  // rate/report modals
  closeRate.addEventListener('click', ()=> rateModal.classList.add('hidden'));
  submitRating.addEventListener('click', onSubmitRating);

  document.querySelectorAll('#starRow, #starRow *').forEach(el=>{
    // star click handled inside function
  });
  renderStars();

  closeReport.addEventListener('click', ()=> reportModal.classList.add('hidden'));
  submitReport.addEventListener('click', onSubmitReport);

  // announcements
  dismissAnnouncement.addEventListener('click', ()=> announcementBox.classList.add('hidden'));

  // populate history
  loadHistory();

  // announcements
  loadAnnouncement();

  // try to fetch fresh profile & update referral code if backend has more data
  fetchProfile();
}

// ---------- Fetch profile (fresh from server) ----------
async function fetchProfile() {
  try {
    const p = await apiFetch('/api/users/profile');
    if (p) {
      currentUser = p;
      localStorage.setItem('su_user', JSON.stringify(p));
      initUI(); // refresh UI
    }
  } catch (err) {
    console.warn('Could not refresh profile:', err.message);
  }
}

// ---------- Announcement ----------
async function loadAnnouncement() {
  try {
    const a = await apiFetch('/api/announcements/latest');
    if (a && a.isActive) {
      announcementBox.classList.remove('hidden');
      announceTitle.innerText = a.title || 'Announcement';
      announceBody.innerText = a.message || '';
    } else {
      announcementBox.classList.add('hidden');
    }
  } catch (err) {
    console.info('No announcement:', err.message);
    announcementBox.classList.add('hidden');
  }
}

// ---------- Calculate price ----------
async function onCalcPrice(){
  calcMsg.innerText = '';
  const items = [{ itemType: itemTypeInput.value || 'Item', weight: Number(weightInput.value || 0), quantity: 1 }];
  const payload = {
    items,
    pickup: pickupInput.value || '',
    dropoff: dropoffInput.value || '',
    serviceType: serviceInput.value || 'standard'
  };
  try {
    const res = await apiFetch('/api/orders/calc-price', { method: 'POST', body: JSON.stringify(payload) });
    lastCalc = res;
    const price = res.finalPrice || res.finalprice || 0;
    finalPriceEl.innerText = `₦${Number(price).toLocaleString()}`;
    const b = res.superAdminBankDetails || res.bankDetails || { bankName:'SkyUltimate Bank', accountNumber:'0000000000', accountHolderName:'SkyUltimate' };
    bankNameEl.innerText = b.bankName || b.bank || 'SkyUltimate Bank';
    bankAccountEl.innerText = b.accountNumber || b.account || '0000000000';
    bankHolderEl.innerText = b.accountHolderName || b.accountHolder || 'SkyUltimate';
    priceModal.classList.remove('hidden');
  } catch (err) {
    calcMsg.innerText = err.message || 'Could not calculate price.';
    showToast('error', err.message || 'Calc failed');
  }
}

// ---------- Confirm "I Paid" (simulate) ----------
async function onIPaid(){
  if (!lastCalc) { showToast('error', 'No price calculated'); return; }
  // create order with same payload used earlier in calc
  const items = [{ itemType: itemTypeInput.value || 'Item', weight: Number(weightInput.value || 0), quantity: 1 }];
  const payload = {
    items,
    pickupAddress: pickupInput.value || '',
    deliveryAddress: dropoffInput.value || '',
    paymentMethod: 'Bank Transfer'
  };
  try {
    const created = await apiFetch('/api/orders', { method: 'POST', body: JSON.stringify(payload) });
    const order = created.order || created;
    localStorage.setItem('su_active_order', JSON.stringify(order));
    activeOrder = order;
    priceModal.classList.add('hidden');
    showToast('success', 'Order created. Await admin confirmation.');
    await loadHistory();
    openTracking(order._id || order.id || order._doc?._id || order._doc?._id || '');
  } catch (err) {
    showToast('error', err.message || 'Order creation failed');
  }
}

// ---------- Submit order directly (without modal) ----------
async function onSubmitOrder(){
  const items = [{ itemType: itemTypeInput.value || 'Item', weight: Number(weightInput.value || 0), quantity: 1 }];
  const payload = {
    items,
    pickupAddress: pickupInput.value || '',
    deliveryAddress: dropoffInput.value || '',
    paymentMethod: 'Bank Transfer'
  };
  try {
    const created = await apiFetch('/api/orders', { method: 'POST', body: JSON.stringify(payload) });
    const order = created.order || created;
    localStorage.setItem('su_active_order', JSON.stringify(order));
    activeOrder = order;
    showToast('success', 'Order created. Await admin confirmation.');
    await loadHistory();
    openTracking(order._id || order.id || '');
  } catch (err) {
    showToast('error', err.message || 'Could not submit order.');
  }
}

// ---------- Load order history ----------
async function loadHistory() {
  historyList.innerHTML = 'Loading...';
  try {
    const userId = currentUser.id || currentUser._id;
    // try /api/orders?customerId=<id>
    const res = await apiFetch(`/api/orders?customerId=${userId}`);
    const list = Array.isArray(res) ? res : (res.orders || res.items || []);
    if (!list || list.length === 0) {
      historyList.innerHTML = '<div class="muted">No orders yet.</div>';
      return;
    }
    historyList.innerHTML = list.slice().reverse().map(o => {
      const id = o._id || o.id || (o.order && (o.order._id || o.order.id)) || '—';
      const status = o.status || o.order?.status || 'Unknown';
      const price = o.finalPrice || o.finalprice || (o.order && o.order.finalPrice) || 0;
      return `<div class="border rounded p-3 flex justify-between items-center">
        <div>
          <div class="font-medium">${id}</div>
          <div class="text-sm muted">${o.pickupAddress || ''} → ${o.deliveryAddress || ''}</div>
        </div>
        <div class="text-right">
          <div class="font-semibold">${status}</div>
          <div class="muted">₦${Number(price).toLocaleString()}</div>
          <div class="mt-2">
            <button data-order="${id}" class="btn-outline open-order">Open</button>
          </div>
        </div>
      </div>`;
    }).join('');
    // wire up open-order buttons
    document.querySelectorAll('.open-order').forEach(b => {
      b.addEventListener('click', async (ev) => {
        const id = ev.currentTarget.getAttribute('data-order');
        try {
          const order = await apiFetch(`/api/orders/${id}`);
          if (order) {
            openTracking(id, order);
          } else {
            showToast('error','Order not found');
          }
        } catch (err) {
          showToast('error', err.message || 'Could not open order');
        }
      });
    });
  } catch (err) {
    historyList.innerHTML = '<div class="muted">Failed to load history</div>';
    console.error(err);
  }
}

// ---------- Tracking: open tracking UI and start polling ----------
function openTracking(orderId, orderData) {
  trackingCard.classList.remove('hidden');
  trackIdEl.innerText = orderId;
  if (orderData) {
    renderTracking(orderData);
  } else {
    pollOrder(orderId);
  }
  if (pollingInterval) clearInterval(pollingInterval);
  pollingInterval = setInterval(()=> pollOrder(orderId), 5000);
}

// poll order
async function pollOrder(orderId) {
  try {
    const order = await apiFetch(`/api/orders/${orderId}`);
    if (order) renderTracking(order);
  } catch (err) {
    console.info('pollOrder error', err.message);
  }
}

// render tracking info & map
function renderTracking(order) {
  activeOrder = order;
  const status = order.status || order.order?.status || 'Unknown';
  trackStatusEl.innerText = status;
  // timeline
  const steps = [
    { key:'PendingPayment', label:'Pending Payment' },
    { key:'PaymentConfirmed', label:'Payment Confirmed' },
    { key:'EnRouteToPickup', label:'Agent en route to pickup' },
    { key:'EnRouteToDelivery', label:'Agent en route to delivery' },
    { key:'Completed', label:'Delivered' },
    { key:'Delivered', label:'Delivered' }
  ];
  timelineEl.innerHTML = steps.map(s => {
    const active = (status === s.key || (s.key==='Completed' && status==='Delivered'));
    return `<div class="${active ? 'font-semibold text-green-600' : 'muted'}">${s.label}</div>`;
  }).join('');

  // update map if agent location provided
  // we expect backend to include agentLocation: { lat, lng } when order assigned/agent moving
  const loc = order.agentLocation || order.order?.agentLocation || null;
  if (loc && loc.lat && loc.lng) {
    showAgentOnMap({ lat: Number(loc.lat), lng: Number(loc.lng) }, order.agent || null, order.agentContact || null);
  } else {
    // if no agent location, but customer/pickup/dropoff exist, show route markers
    const pickup = order.pickupAddress || order.order?.pickupAddress || null;
    const drop = order.deliveryAddress || order.order?.deliveryAddress || null;
    showRouteOnMap(pickup, drop);
  }

  // if agent contact available, show call button
  const agentPhone = order.agentPhone || order.agentContact || order.agent?.phone;
  if (agentPhone) {
    callAgentBtn.classList.remove('hidden');
    callAgentBtn.onclick = ()=> { window.open(`tel:${agentPhone}`); };
  } else {
    callAgentBtn.classList.add('hidden');
  }
}

// ---------- Map helpers (Google Maps) ----------
function ensureMap(center={lat:6.5244,lng:3.3792}, zoom=12) {
  if (!map) {
    map = new google.maps.Map(trackingMapEl, { center, zoom });
  } else {
    map.setCenter(center);
    map.setZoom(zoom);
  }
}

function showAgentOnMap(latlng, agentId=null, agentContact=null) {
  ensureMap(latlng, 14);
  if (!agentMarker) {
    agentMarker = new google.maps.Marker({ map, position: latlng, title: 'Agent' });
  } else {
    agentMarker.setPosition(latlng);
  }
  // optionally: place pickup/delivery markers if available
}

function showRouteOnMap(pickupAddress, dropAddress) {
  // if addresses are strings, try to geocode (best-effort). If not possible, just show default.
  ensureMap();
  // A more complete implementation would call PlacesService/Geocoder to place markers.
}

// ---------- Panel (hamburger) ----------
function openPanel(){
  panelOverlay.classList.remove('hidden');
  panelOverlay.style.display = 'block';
  // keep main content accessible behind semi-transparent overlay if wanted
}

function closePanelFunc(){
  panelOverlay.classList.add('hidden');
  panelOverlay.style.display = 'none';
  panelContent.innerHTML = '';
}

// when panel nav clicked
async function openPanelSection(section) {
  panelContent.innerHTML = '<div class="muted">Loading...</div>';
  if (section === 'profile') {
    panelContent.innerHTML = `
      <div>
        <h4 class="font-semibold">Profile</h4>
        <div class="mt-3 space-y-2">
          <div><b>Name:</b> ${currentUser.name || ''}</div>
          <div><b>Email:</b> ${currentUser.email || ''}</div>
          <div><b>Phone:</b> ${currentUser.phone || ''}</div>
          <div class="mt-3"><button id="editProfileBtn" class="btn">Edit Profile</button></div>
        </div>
      </div>`;
    document.getElementById('editProfileBtn').addEventListener('click', ()=> { profileModal.classList.remove('hidden'); });
  } else if (section === 'history') {
    // full-screen history overlay
    try {
      const userId = currentUser.id || currentUser._id;
      const res = await apiFetch(`/api/orders?customerId=${userId}`);
      const list = Array.isArray(res) ? res : (res.orders || []);
      if (!list || list.length === 0) {
        panelContent.innerHTML = '<div class="muted">No order history yet.</div>';
      } else {
        panelContent.innerHTML = list.slice().reverse().map(o => {
          const id = o._id || o.id || '—';
          const status = o.status || 'Unknown';
          const price = o.finalPrice || 0;
          return `<div class="border rounded p-3 mb-2">
            <div class="flex justify-between"><div class="font-medium">${id}</div><div class="muted">${status}</div></div>
            <div class="text-sm muted mt-1">${o.pickupAddress || ''} → ${o.deliveryAddress || ''}</div>
            <div class="mt-2"><button data-order="${id}" class="btn-outline open-order-panel">Open</button></div>
          </div>`;
        }).join('');
        // wire buttons
        document.querySelectorAll('.open-order-panel').forEach(b => b.addEventListener('click', async (ev)=>{
          const id = ev.currentTarget.getAttribute('data-order');
          closePanelFunc();
          openTracking(id);
        }));
      }
    } catch (err) {
      panelContent.innerHTML = `<div class="muted">Failed to load history: ${err.message}</div>`;
    }
  } else if (section === 'referrals') {
    // show referral & sharing controls + progress if backend has endpoint
    try {
      const res = await apiFetch('/api/referrals/my').catch(()=> null);
      const myRef = (res && res.code) ? res.code : (currentUser.referralCode || ('REF'+String(currentUser._id||'').slice(-6)));
      panelContent.innerHTML = `<div>
        <h4 class="font-semibold">Refer & Earn</h4>
        <div class="mt-3">Your code: <div class="font-mono font-bold mt-1">${myRef}</div></div>
        <div class="mt-3 flex gap-2">
          <button id="panelCopyRef" class="btn-outline">Copy</button>
          <button id="panelShareRef" class="btn">Share</button>
        </div>
      </div>`;
      document.getElementById('panelCopyRef').addEventListener('click', async ()=> {
        await navigator.clipboard.writeText(`${location.origin}/signup?ref=${myRef}`);
        showToast('success','Referral link copied');
      });
      document.getElementById('panelShareRef').addEventListener('click', async ()=> {
        try {
          if (navigator.share) await navigator.share({ title:'Join SkyUltimate', url:`${location.origin}/signup?ref=${myRef}` });
          else { await navigator.clipboard.writeText(`${location.origin}/signup?ref=${myRef}`); showToast('success','Referral copied'); }
        } catch(e){ showToast('error','Share failed'); }
      });
    } catch (err) {
      panelContent.innerHTML = `<div class="muted">Referrals not available yet.</div>`;
    }
  } else if (section === 'announcements') {
    try {
      const a = await apiFetch('/api/announcements/latest');
      if (!a) panelContent.innerHTML = '<div class="muted">No announcement.</div>';
      else panelContent.innerHTML = `<div><h4 class="font-semibold">${a.title}</h4><div class="muted mt-2">${a.message}</div></div>`;
    } catch (err) { panelContent.innerHTML = `<div class="muted">Failed to fetch announcement</div>`; }
  } else if (section === 'rate') {
    panelContent.innerHTML = `<div>
      <h4 class="font-semibold">Rate an Agent</h4>
      <div class="mt-3"><button id="openRatePanelBtn" class="btn">Open Rate Modal</button></div>
    </div>`;
    document.getElementById('openRatePanelBtn').addEventListener('click', ()=> { rateModal.classList.remove('hidden'); });
  } else if (section === 'report') {
    panelContent.innerHTML = `<div><h4 class="font-semibold">Report an Issue</h4>
      <div class="mt-3"><button id="openReportPanelBtn" class="btn">Open Report Form</button></div></div>`;
    document.getElementById('openReportPanelBtn').addEventListener('click', ()=> { reportModal.classList.remove('hidden'); });
  } else if (section === 'support') {
    panelContent.innerHTML = `<div><h4 class="font-semibold">Support</h4>
      <div class="muted mt-2">Call: <a class="underline" href="tel:+2349128884830">+234 912 888 4830</a></div>
      <div class="muted mt-1">Email: <a class="underline" href="mailto:nelsongodspower24@gmail.com">nelsongodspower24@gmail.com</a></div>
      <div class="muted mt-3">Or use the report form to send a ticket to admins.</div>
    </div>`;
  } else if (section === 'settings') {
    panelContent.innerHTML = `<div><h4 class="font-semibold">Settings</h4><div class="mt-3">Theme: <button id="panelThemeToggle" class="btn-outline">Toggle</button></div></div>`;
    document.getElementById('panelThemeToggle').addEventListener('click', toggleTheme);
  } else {
    panelContent.innerHTML = `<div class="muted">Not implemented</div>`;
  }
  }
  // ---------- Profile save ----------
async function onSaveProfile(){
  const payload = { phone: profilePhone.value };
  if (profileBankName.value || profileAccountNumber.value || profileAccountHolder.value) {
    payload.bankName = profileBankName.value;
    payload.accountNumber = profileAccountNumber.value;
    payload.accountHolderName = profileAccountHolder.value;
  }
  try {
    await apiFetch('/api/users/me/bank', { method: 'PUT', body: JSON.stringify(payload) });
    // update local copy
    const user = { ...(currentUser || {}) };
    user.phone = profilePhone.value || user.phone;
    user.bankDetails = user.bankDetails || {};
    if (profileBankName.value) user.bankDetails.bankName = profileBankName.value;
    if (profileAccountNumber.value) user.bankDetails.accountNumber = profileAccountNumber.value;
    if (profileAccountHolder.value) user.bankDetails.accountHolderName = profileAccountHolder.value;
    localStorage.setItem('su_user', JSON.stringify(user));
    currentUser = user;
    profileMsg.innerText = 'Saved';
    setTimeout(()=>{ profileModal.classList.add('hidden'); profileMsg.innerText = ''; }, 900);
    showToast('success','Profile updated');
  } catch (err) {
    profileMsg.innerText = err.message || 'Update failed';
    showToast('error', err.message || 'Update failed');
  }
}

// ---------- Rate submit ----------
function renderStars(){
  starRow.innerHTML = '';
  for (let i=1;i<=5;i++){
    const s = document.createElement('span');
    s.textContent = (i <= selectedRating) ? '★' : '☆';
    s.style.cursor='pointer';
    s.style.color = i <= selectedRating ? '#f59e0b' : '#9ca3af';
    s.dataset.value = i;
    s.addEventListener('click', ()=> {
      selectedRating = Number(s.dataset.value);
      renderStars();
    });
    starRow.appendChild(s);
  }
}

async function onSubmitRating(){
  if (!activeOrder || !activeOrder._id) {
    rateMsg.innerText = 'No order selected for rating';
    showToast('error','No active order');
    return;
  }
  const payload = { rating: selectedRating, comment: rateComment.value || '' };
  try {
    await apiFetch(`/api/orders/${activeOrder._id}/rate`, { method: 'POST', body: JSON.stringify(payload) });
    rateMsg.innerText = 'Thanks for rating!';
    showToast('success','Rating submitted');
    rateModal.classList.add('hidden');
    await loadHistory();
  } catch (err) {
    rateMsg.innerText = err.message || 'Submit failed';
    showToast('error', err.message || 'Submit failed');
  }
}

// ---------- Report submit ----------
async function onSubmitReport(){
  if (!activeOrder || !activeOrder._id) {
    reportMsg.innerText = 'No order associated';
    showToast('error','No order selected');
    return;
  }
  const payload = {
    orderId: activeOrder._id,
    type: reportType.value,
    details: reportDetails.value
  };
  try {
    await apiFetch('/api/reports', { method: 'POST', body: JSON.stringify(payload) });
    reportMsg.innerText = 'Report sent. Admin will review.';
    showToast('success','Report submitted');
    reportModal.classList.add('hidden');
  } catch (err) {
    reportMsg.innerText = err.message || 'Failed to submit';
    showToast('error', err.message || 'Report failed');
  }
}

// ---------- Panel action: logout ----------
function doLogout() {
  localStorage.removeItem('su_token');
  localStorage.removeItem('su_user');
  window.location.href = 'index.html';
}

// ---------- Toggle theme ----------
function toggleTheme(){
  const isDark = document.body.classList.contains('dark');
  if (isDark) {
    document.body.classList.remove('dark');
    document.body.classList.add('light');
    themeToggle.innerText = 'Dark';
  } else {
    document.body.classList.remove('light');
    document.body.classList.add('dark');
    themeToggle.innerText = 'Light';
  }
}

// ---------- init map when tracking visible ----------
function initMapOnce(){
  if (typeof google === 'undefined') {
    console.warn('Google maps not loaded');
    return;
  }
  if (!map) {
    map = new google.maps.Map(trackingMapEl, { center: { lat: 6.5244, lng: 3.3792 }, zoom: 12 });
  }
}

// ---------- initial startup ----------
initUI();
initMapOnce();
loadHistory(); // ensure history shown

// if there is an active order in localStorage, open tracking
try {
  const maybe = JSON.parse(localStorage.getItem('su_active_order') || 'null');
  if (maybe && (maybe._id || maybe.id)) {
    openTracking(maybe._id || maybe.id);
  }
} catch(e){ /* ignore */ }

</script>
</body>
</html>
  

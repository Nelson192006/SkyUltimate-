<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SkyUltimate — Customer Dashboard</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Maps / Places -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDu1dptqgTwWWD6568jhf_tal7uYfdyMlQ&libraries=places" async defer></script>

  <style>
    :root{
      --brand-red: #C00000;
      --brand-red-dark: #900000;
      --glass: rgba(255,255,255,0.92);
      --soft: #f7fafc;
    }
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body{background:linear-gradient(180deg,#fff7f7 0%, #fff 100%); color:#0f172a; -webkit-font-smoothing:antialiased;}
    /* Header */
    .topbar{backdrop-filter: blur(6px); background: linear-gradient(90deg, rgba(255,255,255,0.6), rgba(255,255,255,0.3)); box-shadow: 0 6px 26px rgba(0,0,0,0.08);}
    .logo-round{width:64px;height:64px;border-radius:999px;object-fit:cover;box-shadow:0 8px 28px rgba(0,0,0,0.12);}
    /* Cards */
    .card{background:var(--glass); border-radius:18px; padding:20px; box-shadow: 0 10px 40px rgba(2,6,23,0.06);}
    .chip{display:inline-block;padding:6px 12px;border-radius:999px;background:#fff;border:1px solid #eee;font-weight:600}
    /* Buttons */
    .btn-primary{background:linear-gradient(180deg,var(--brand-red),var(--brand-red-dark));color:#fff;padding:12px 16px;border-radius:14px;font-weight:700;box-shadow:0 8px 30px rgba(192,0,0,0.18)}
    .btn-ghost{background:#fff;border:1px solid #eee;padding:10px 14px;border-radius:12px}
    /* Map */
    .map{height:300px;border-radius:14px;overflow:hidden;border:1px solid #e6eef6}
    /* Overlay */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:80}
    .overlay.show{display:flex}
    .overlay-backdrop{position:absolute;inset:0;background:rgba(6,6,10,0.65)}
    .overlay-panel{position:relative;z-index:82;width:100%;max-width:1020px;margin:16px;}
    /* Toast */
    .toast{position:fixed;right:18px;bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:100}
    .toast.show{display:block}
    /* dark theme */
    .dark body{background:#071026;color:#e6eef8}
    .dark .card{background: rgba(8,12,20,0.6); box-shadow:none}
    .dark .chip{background: rgba(255,255,255,0.04); color:#e6eef8; border-color: rgba(255,255,255,0.04)}
    .dark .btn-ghost{background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.04)}
    .no-scroll{overflow:hidden;height:100%}
    /* responsive */
    @media (max-width:640px){
      .logo-round{width:52px;height:52px}
      .map{height:220px}
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <header class="topbar sticky top-0 z-40">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="hamburger" class="p-2 rounded-md hover:bg-white/30" title="Menu" aria-label="Menu">
          <svg width="22" height="14" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="#111827" stroke-width="1.6" stroke-linecap="round"/></svg>
        </button>
        <img id="siteLogo" class="logo-round" src="https://github.com/Nelson192006/SkyUltimate-/blob/62343ff3e5e556aa02ecece40e2c006fa9161c0a/logo.png?raw=true" alt="SkyUltimate"/>
      </div>

      <!-- only welcome (no text beside logo) -->
      <div class="flex items-center gap-3">
        <div id="welcomeFirst" class="font-semibold text-lg">Welcome!</div>
        <button id="settingsBtn" class="p-2 rounded-md hover:bg-white/30" title="Settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 15.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7zM19.4 12.7l1.1-2.1-2.3-4-2.4.6a8.4 8.4 0 00-1.6-.9l-.4-2.4h-4.4l-.4 2.4c-.5.2-1 .5-1.5.9l-2.4-.6-2.3 4 1.1 2.1c-.1.6-.1 1.3 0 1.9l-1.1 2.1 2.3 4 2.4-.6c.5.4 1 .7 1.5.9l.4 2.4h4.4l.4-2.4c.6-.2 1.1-.5 1.6-.9l2.4.6 2.3-4-1.1-2.1c.1-.6.1-1.3 0-1.9z" stroke="#111827" stroke-width="0.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <!-- Announcement -->
    <div id="announceBanner" class="card hidden">
      <div id="announceTitle" class="text-xl font-semibold text-red-700"></div>
      <div id="announceMsg" class="text-sm mt-1 text-gray-700"></div>
    </div>

    <!-- Hero + placement -->
    <section class="card">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h1 id="greetingLarge" class="text-2xl font-bold">Hello!</h1>
          <p class="text-sm text-gray-600 mt-1">Place a new delivery order — quick, secure and tracked.</p>
        </div>
        <div class="text-right">
          <div class="text-xs text-gray-500">Role</div>
          <div id="roleBadge" class="chip mt-2">Customer</div>
        </div>
      </div>

      <hr class="my-4" />

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-xs text-gray-600">Pickup — full recipient address</label>
          <input id="pickupInput" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="e.g., 12B Allen Ave, Ikeja" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Drop-off — full delivery address</label>
          <input id="dropInput" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="Recipient address" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Recipient name</label>
          <input id="recipientName" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="Recipient full name" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Recipient phone</label>
          <input id="recipientPhone" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="+234 9xxxxxxxxx" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Item category</label>
          <select id="itemCategory" class="w-full mt-1 p-3 rounded-lg border border-gray-100">
            <option value="documents">Documents</option>
            <option value="food">Food</option>
            <option value="groceries">Groceries</option>
            <option value="parcel">Parcel</option>
            <option value="others">Other</option>
          </select>
        </div>

        <div>
          <label class="text-xs text-gray-600">Weight (kg)</label>
          <input id="weightInput" type="number" min="0" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="e.g., 2" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Service</label>
          <select id="serviceSelect" class="w-full mt-1 p-3 rounded-lg border border-gray-100">
            <option value="standard">Standard</option>
            <option value="express">Express</option>
            <option value="same-day">Same-day</option>
          </select>
        </div>

        <div class="md:col-span-2 flex gap-3 mt-2">
          <button id="calcBtn" class="btn-primary flex-1" aria-live="polite">Calculate Final Price</button>
          <button id="submitBtn" class="btn-ghost flex-1">Proceed with Payment</button>
        </div>

        <div id="calcNotice" class="md:col-span-2 text-sm text-red-600 mt-1"></div>
      </div>
    </section>

    <!-- Map / tracking -->
    <section id="trackingCard" class="card hidden">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-semibold">Order Tracking</h3>
          <div class="text-xs text-gray-500 mt-1">Order ID: <span id="trackId">—</span></div>
        </div>
        <div>
          <span id="trackStatus" class="chip">Pending</span>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <div id="map" class="map"></div>
          <div class="text-xs text-gray-500 mt-2">Agent: <span id="agentName">—</span> • <a id="agentPhone" class="underline" href="#">—</a></div>
        </div>

        <div>
          <h4 class="font-semibold">Journey</h4>
          <div id="timeline" class="mt-3 text-sm text-gray-700"></div>

          <div class="mt-6 flex gap-3">
            <button id="btnContactAgent" class="btn-ghost">Contact Agent</button>
            <button id="btnReportAgent" class="btn-primary">Report Agent</button>
          </div>
        </div>
      </div>
    </section>

    <footer class="text-center text-sm text-gray-500">
      Contact: <a id="phoneLink" href="tel:+2349128884830" class="underline">+234 912 888 4830</a> ·
      <a id="whatsappLink" href="https://wa.me/2349128884830" target="_blank" class="underline">WhatsApp</a> ·
      <a id="emailLink" href="mailto:nelsongodspower24@gmail.com" class="underline">Email</a>
    </footer>
  </main>

  <!-- OVERLAY (full-screen) -->
  <div id="overlay" class="overlay">
    <div class="overlay-backdrop" id="overlayBackdrop"></div>
    <div class="overlay-panel card" id="overlayPanel"></div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ====== Config ====== */
const API_BASE = "https://skyultimate-backend-api-structure.onrender.com";
const token = localStorage.getItem('su_token');
const suUser = JSON.parse(localStorage.getItem('su_user') || 'null');
if (!token || !suUser) { location.href = 'index.html'; }

const googleKey = "AIzaSyDu1dptqgTwWWD6568jhf_tal7uYfdyMlQ";

/* ====== DOM refs ====== */
const welcomeFirst = document.getElementById('welcomeFirst');
const greetingLarge = document.getElementById('greetingLarge');
const roleBadge = document.getElementById('roleBadge');

const pickupInput = document.getElementById('pickupInput');
const dropInput = document.getElementById('dropInput');
const recipientName = document.getElementById('recipientName');
const recipientPhone = document.getElementById('recipientPhone');
const itemCategory = document.getElementById('itemCategory');
const weightInput = document.getElementById('weightInput');
const serviceSelect = document.getElementById('serviceSelect');

const calcBtn = document.getElementById('calcBtn');
const submitBtn = document.getElementById('submitBtn');
const calcNotice = document.getElementById('calcNotice');

const announceBanner = document.getElementById('announceBanner');
const announceTitle = document.getElementById('announceTitle');
const announceMsg = document.getElementById('announceMsg');

const overlay = document.getElementById('overlay');
const overlayBackdrop = document.getElementById('overlayBackdrop');
const overlayPanel = document.getElementById('overlayPanel');
const toastEl = document.getElementById('toast');

const hamburger = document.getElementById('hamburger');
const settingsBtn = document.getElementById('settingsBtn');

const trackingCard = document.getElementById('trackingCard');
const trackId = document.getElementById('trackId');
const trackStatus = document.getElementById('trackStatus');
const timelineEl = document.getElementById('timeline');
const agentNameEl = document.getElementById('agentName');
const agentPhoneEl = document.getElementById('agentPhone');
const btnContactAgent = document.getElementById('btnContactAgent');
const btnReportAgent = document.getElementById('btnReportAgent');

const mapContainer = document.getElementById('map');

/* ====== Local state ====== */
let lastCalc = null;
let currentOrder = null;
let pollInterval = null;
let map, agentMarker;

/* ====== Init UI ====== */
(function init(){
  const first = (suUser.name || '').split(' ')[0] || 'there';
  welcomeFirst.innerText = `Hello, ${first}!`;
  greetingLarge.innerText = `Welcome back, ${first}!`;
  roleBadge.innerText = suUser.role || 'Customer';

  hamburger.addEventListener('click', openMenu);
  settingsBtn.addEventListener('click', openSettings);
  overlayBackdrop.addEventListener('click', closeOverlay);

  calcBtn.addEventListener('click', onCalculate);
  submitBtn.addEventListener('click', onProceedPayment);

  btnContactAgent.addEventListener('click', () => {
    if (agentPhoneEl && agentPhoneEl.textContent && agentPhoneEl.href) location.href = agentPhoneEl.href;
  });
  btnReportAgent.addEventListener('click', openReport);

  initPlaces();
  loadAnnouncement();
  applyTheme(!!localStorage.getItem('su_theme_dark'));
})();

/* ====== Utilities ====== */
function showToast(msg, timeout=3500){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=> toastEl.classList.remove('show'), timeout);
}
function openOverlay(htmlOrNode){
  if (typeof htmlOrNode === 'string') overlayPanel.innerHTML = htmlOrNode;
  else { overlayPanel.innerHTML = ''; overlayPanel.appendChild(htmlOrNode); }
  overlay.classList.add('show');
  document.documentElement.classList.add('no-scroll');
}
function closeOverlay(){ overlay.classList.remove('show'); overlayPanel.innerHTML = ''; document.documentElement.classList.remove('no-scroll'); }
function setLoading(btn, yes=true){ if (yes) { btn.dataset.prev = btn.innerHTML; btn.disabled=true; btn.innerHTML = 'Please wait...'; } else { btn.disabled=false; if (btn.dataset.prev) btn.innerHTML = btn.dataset.prev; } }

/* Robust POST helper with a list of candidate paths (tries each until success).
   Accepts array of path strings (leading slash), options: method, body.
   Returns the JSON for the first 2xx response, otherwise throws last error.
*/
async function tryPaths(paths, opts={}) {
  let lastErr = null;
  for (const p of paths) {
    try {
      const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(API_BASE + p, { method: opts.method || 'POST', headers, body: opts.body });
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch(e){ data = text; }
      if (res.ok) return data ?? {};
      // if 404 try next path; gather message
      lastErr = new Error((data && data.message) || `HTTP ${res.status} (${p})`);
      // continue trying other paths
    } catch (err) {
      lastErr = err;
    }
  }
  // none succeeded
  throw lastErr || new Error('No paths succeeded');
}

/* GET helper with auth, throws on non-2xx */
async function getJSON(path) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(API_BASE + path, { headers });
  const txt = await res.text();
  let data = null;
  try { data = txt ? JSON.parse(txt) : null; } catch(e){ data = txt; }
  if (!res.ok) throw new Error((data && data.message) || `HTTP ${res.status}`);
  return data;
}

/* ====== Announcement ====== */
async function loadAnnouncement(){
  try {
    const res = await fetch(API_BASE + '/api/announcements/latest');
    if (!res.ok) return;
    const a = await res.json();
    if (a && a.isActive) {
      announceTitle.textContent = a.title || 'Announcement';
      announceMsg.textContent = a.message || '';
      announceBanner.classList.remove('hidden');
    }
  } catch(e){ console.info('announcement load failed:', e.message); }
}

/* ====== Google Places Autocomplete ====== */
function initPlaces(){
  // wait for google
  if (!window.google || !google.maps || !google.maps.places) {
    // retry a few times then show guidance
    setTimeout(initPlaces, 700);
    return;
  }
  try {
    const p = new google.maps.places.Autocomplete(pickupInput, { types:['address'] });
    const d = new google.maps.places.Autocomplete(dropInput, { types:['address'] });
    // optionally bias to Nigeria
    // p.setComponentRestrictions({ country: 'ng' });
    // d.setComponentRestrictions({ country: 'ng' });
  } catch(e){
    console.warn('places init failed', e.message);
  }
}

/* ====== Pricing & Payment flows ====== */

// candidate paths to try for price calculation
const calcPaths = ['/api/orders/calc-price', '/api/orders/calculate-price', '/api/orders/estimate'];
// candidate paths to try for create order
const createPaths = ['/api/orders', '/api/orders/submit', '/api/orders/create'];

function buildItems(){
  return [{ itemType: itemCategory.value || 'parcel', weight: Number(weightInput.value || 0), quantity: 1 }];
}

async function onCalculate(){
  calcNotice.textContent = '';
  lastCalc = null;
  setLoading(calcBtn,true);
  try {
    const payload = { items: buildItems(), serviceType: serviceSelect.value, pickup: pickupInput.value, dropoff: dropInput.value };
    const res = await tryPaths(calcPaths, { method:'POST', body: JSON.stringify(payload) });
    lastCalc = res;
    showPriceOverlay(res);
  } catch (err) {
    console.error('Price calc failed:', err);
    calcNotice.textContent = err.message || 'Failed to calculate price';
    showToast(err.message || 'Calculation error');
  } finally {
    setLoading(calcBtn,false);
  }
}

function showPriceOverlay(res){
  const final = res.finalPrice ?? res.finalprice ?? 0;
  const bankInfo = res.superAdminBankDetails || {}; // backend may return this; we still show your provided accounts
  const html = document.createElement('div');
  html.innerHTML = `
    <h3 class="text-xl font-semibold mb-2">Final Price</h3>
    <div class="text-3xl font-bold mb-2">₦${Number(final).toLocaleString()}</div>
    <div class="text-sm text-gray-600 mb-4">Choose any of the accounts below to pay. After payment click <strong>I have paid</strong>.</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
      <div class="p-3 rounded border"> <div class="font-semibold">Moniepoint</div><div class="text-sm">Acct: 9128884830 • Nelson Emmanuel Godspower</div></div>
      <div class="p-3 rounded border"> <div class="font-semibold">Opay</div><div class="text-sm">Acct: 9128884830 • Nelson Emmanuel Godspower</div></div>
      <div class="p-3 rounded border"> <div class="font-semibold">Palmpay</div><div class="text-sm">Acct: 9128884830 • Nelson Emmanuel Godspower</div></div>
      <div class="p-3 rounded border"> <div class="font-semibold">UBA</div><div class="text-sm">Acct: 234 2 835 397 • Nelson Emmanuel Godspower</div></div>
      <div class="p-3 rounded border"> <div class="font-semibold">GTB</div><div class="text-sm">Acct: 0734090626 • Nelson Emmanuel Godspower</div></div>
    </div>
    <div class="flex gap-3">
      <button id="iPaidBtn" class="btn-primary flex-1">I have paid</button>
      <button id="closePrice" class="btn-ghost flex-1">Close</button>
    </div>
  `;
  openOverlay(html);
  document.getElementById('closePrice').addEventListener('click', closeOverlay);
  document.getElementById('iPaidBtn').addEventListener('click', onConfirmPaidCreateOrder);
}

// proceed with payment - if no calc yet, do calc then show overlay (calc code will show overlay)
async function onProceedPayment(){
  if (!lastCalc) {
    await onCalculate();
    return;
  }
  showPriceOverlay(lastCalc);
}

// Create order after user confirms payment
async function onConfirmPaidCreateOrder(){
  const btn = document.getElementById('iPaidBtn');
  setLoading(btn,true);
  try {
    if (!pickupInput.value || !dropInput.value) { showToast('Please fill pickup & dropoff addresses'); return; }
    const payload = {
      items: buildItems(),
      pickupAddress: pickupInput.value,
      deliveryAddress: dropInput.value,
      paymentMethod: 'Bank Transfer',
      recipientName: recipientName.value || '',
      recipientPhone: recipientPhone.value || ''
    };
    const res = await tryPaths(createPaths, { method:'POST', body: JSON.stringify(payload) });
    // server returns order (try different shapes)
    const order = res.order || res;
    currentOrder = order;
    localStorage.setItem('su_active_order', JSON.stringify(order));
        showToast('Order created. Awaiting admin confirmation.');
    closeOverlay();
    openTracking(order._id || order.id || order._doc?._id || '');
    await refreshHistory(); // best-effort refresh
  } catch (err) {
    console.error('Order create failed', err);
    showToast(err.message || 'Order creation failed');
    document.getElementById('calcNotice').textContent = err.message || 'Order creation failed';
  } finally {
    setLoading(btn,false);
  }
}

/* ====== Tracking polling ====== */
function openTracking(orderId){
  if (!orderId) return;
  trackingCard.classList.remove('hidden');
  trackId.textContent = orderId;
  startPolling(orderId);
  initMap();
}

function startPolling(orderId){
  if (pollInterval) clearInterval(pollInterval);
  pollInterval = setInterval(()=> pollOrder(orderId), 5000);
  pollOrder(orderId); // immediate
}

async function pollOrder(orderId){
  try {
    const data = await getJSON(`/api/orders/${orderId}`);
    const order = data.order || data;
    currentOrder = order;
    const status = order.status || 'Pending';
    trackStatus.textContent = status;
    renderTimeline(status, order);
    // agent info
    const agent = order.agentDetails || order.agentProfile || order.agent;
    if (agent && typeof agent === 'object') {
      agentNameEl.textContent = agent.name || 'Agent';
      agentPhoneEl.textContent = agent.phone || agent.contact || '';
      agentPhoneEl.href = `tel:${agent.phone || agent.contact || ''}`;
    } else {
      agentNameEl.textContent = order.agent || '—';
    }
    // update map if agent location included
    if (order.agentLocation && order.agentLocation.lat && order.agentLocation.lng) {
      updateAgentMarker(Number(order.agentLocation.lat), Number(order.agentLocation.lng));
    }
    if (status === 'Completed' || status === 'Delivered') {
      showToast('Order delivered');
      clearInterval(pollInterval); pollInterval = null;
    }
  } catch (err) {
    console.info('poll error', err.message);
  }
}

function renderTimeline(status, order){
  const steps = [
    { key:'PendingPayment', label:'Pending Payment' },
    { key:'PaymentConfirmed', label:'Payment Confirmed' },
    { key:'EnRouteToPickup', label:'Agent en route to pickup' },
    { key:'EnRouteToDelivery', label:'Agent en route to delivery' },
    { key:'Completed', label:'Delivered / Completed' },
    { key:'Delivered', label:'Delivered' },
  ];
  timelineEl.innerHTML = steps.map(s=>{
    const active = (s.key === status || (s.key==='Completed' && status==='Delivered'));
    return `<div class="py-1"><span class="${active ? 'font-bold text-green-600' : 'text-gray-600'}">${s.label}</span></div>`;
  }).join('');
}

/* ====== Map helpers ====== */
function initMap(){
  if (map) return;
  if (!window.google || !google.maps) {
    console.warn('Google maps not ready');
    return;
  }
  map = new google.maps.Map(mapContainer, { center:{lat:6.5244,lng:3.3792}, zoom:12, disableDefaultUI:true });
}
function updateAgentMarker(lat, lng){
  if (!map) initMap();
  const pos = { lat, lng };
  if (!agentMarker) {
    agentMarker = new google.maps.Marker({ position: pos, map, title:'Agent' });
    map.setCenter(pos);
  } else agentMarker.setPosition(pos);
}

/* ====== Menu / overlays ====== */
function openMenu(){
  const html = document.createElement('div');
  html.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <img src="${document.getElementById('siteLogo').src}" class="w-14 h-14 rounded-full" />
        <div>
          <div class="font-semibold">${suUser.name || 'User'}</div>
          <div class="text-sm text-gray-500">${suUser.email || ''}</div>
        </div>
      </div>
      <div><button id="closeMenuBtn" class="btn-ghost">Close</button></div>
    </div>
    <div class="grid gap-2">
      <button id="menuOrders" class="btn-ghost w-full text-left">Order History</button>
      <button id="menuReferral" class="btn-ghost w-full text-left">Refer & Earn</button>
      <button id="menuProfile" class="btn-ghost w-full text-left">My Profile</button>
      <button id="menuAnnouncements" class="btn-ghost w-full text-left">Announcements</button>
      <button id="menuRate" class="btn-ghost w-full text-left">Rate Delivered Order</button>
      <button id="menuReport" class="btn-ghost w-full text-left">Report an Issue</button>
      <button id="menuSettings" class="btn-ghost w-full text-left">Settings</button>
      <button id="menuLogout" class="btn-ghost w-full text-left text-red-600">Logout</button>
    </div>
  `;
  openOverlay(html);
  document.getElementById('closeMenuBtn').onclick = closeOverlay;
  document.getElementById('menuOrders').onclick = openHistory;
  document.getElementById('menuReferral').onclick = openReferral;
  document.getElementById('menuProfile').onclick = openProfile;
  document.getElementById('menuAnnouncements').onclick = openAnnouncements;
  document.getElementById('menuRate').onclick = openRate;
  document.getElementById('menuReport').onclick = openReport;
  document.getElementById('menuSettings').onclick = openSettings;
  document.getElementById('menuLogout').onclick = ()=> { localStorage.removeItem('su_token'); localStorage.removeItem('su_user'); location.href='index.html' };
}

/* Order history overlay */
async function openHistory(){
  openOverlay('<div>Loading order history...</div>');
  try {
    const res = await getJSON(`/api/orders?customerId=${suUser.id || suUser._id || suUser._id}`);
    const list = Array.isArray(res) ? res : (res.orders || res.data || []);
    const container = document.createElement('div');
    container.innerHTML = `<h3 class="text-xl font-semibold mb-2">Order History</h3>`;
    if (!list || list.length === 0) {
      container.innerHTML += `<div class="text-sm">No orders yet.</div>`;
    } else {
      container.innerHTML += list.map(o=>{
        const id = o._id || o.id;
        const status = o.status || 'Unknown';
        const created = new Date(o.createdAt || Date.now()).toLocaleString();
        return `<div class="p-3 border rounded mb-2">
          <div class="font-medium">Order ${id}</div>
          <div class="text-sm text-gray-500">Status: ${status} • ${created}</div>
          <div class="text-sm mt-2">Pickup: ${o.pickupAddress || ''}</div>
          <div class="text-sm">Drop: ${o.deliveryAddress || ''}</div>
          <div class="mt-2"><button data-id="${id}" class="btn-primary viewOrder">View</button></div>
        </div>`;
      }).join('');
    }
    overlayPanel.innerHTML = ''; overlayPanel.appendChild(container);
    overlay.querySelectorAll('.viewOrder').forEach(b=>{
      b.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        closeOverlay();
        openTracking(id);
      });
    });
  } catch(e){
    overlayPanel.innerHTML = `<div class="text-sm text-red-600">Failed to load history: ${e.message}</div>`;
  }
}

/* Referral */
function openReferral(){
  const code = suUser.referralCode || (suUser._id ? 'REF'+String(suUser._id).slice(-6) : 'REF-UNKNOWN');
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Refer & Earn</h3>
    <div class="p-3 border rounded mb-3"><div class="font-medium">Your referral code</div><div class="font-mono mt-2 text-lg">${code}</div>
    <div class="text-sm mt-2">Share: <a href="${location.origin}/signup?ref=${code}">${location.origin}/signup?ref=${code}</a></div>
    <div class="mt-3 flex gap-2"><button id="copyRef" class="btn-primary">Copy</button><button id="shareRef" class="btn-ghost">Share</button></div></div>`;
  openOverlay(node);
  document.getElementById('copyRef').onclick = async ()=> {
    try { await navigator.clipboard.writeText(`${location.origin}/signup?ref=${code}`); showToast('Copied referral link'); } catch(e){ showToast('Copy failed'); }
  };
  document.getElementById('shareRef').onclick = async ()=> {
    try { if (navigator.share) await navigator.share({ title:'Join SkyUltimate', text:'Use my referral link', url:`${location.origin}/signup?ref=${code}` }); else { await navigator.clipboard.writeText(`${location.origin}/signup?ref=${code}`); showToast('Link copied'); } } catch(e){ showToast('Share failed'); }
  };
}

/* Profile */
function openProfile(){
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">My Profile</h3>
    <label class="text-xs">Full name</label><input id="pf_name" class="w-full p-3 rounded mt-1" value="${escapeHtml(suUser.name||'')}" />
    <label class="text-xs mt-2">Email</label><input class="w-full p-3 rounded mt-1" value="${escapeHtml(suUser.email||'')}" readonly />
    <label class="text-xs mt-2">Phone</label><input id="pf_phone" class="w-full p-3 rounded mt-1" value="${escapeHtml(suUser.phone||'')}" />
    <div class="flex gap-2 mt-3"><button id="saveProfile" class="btn-primary flex-1">Save</button><button id="closeProfile" class="btn-ghost flex-1">Close</button></div>
    <div id="profileMsg" class="text-sm text-green-600 mt-2"></div>`;
  openOverlay(node);
  document.getElementById('closeProfile').onclick = closeOverlay;
  document.getElementById('saveProfile').onclick = async ()=>{
    const phone = document.getElementById('pf_phone').value.trim();
    try {
      await fetch(API_BASE + '/api/users/me/bank', { method:'PUT', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ phone }) });
      suUser.phone = phone; localStorage.setItem('su_user', JSON.stringify(suUser));
      document.getElementById('profileMsg').textContent = 'Saved';
      setTimeout(closeOverlay,800);
    } catch(e){ document.getElementById('profileMsg').textContent = e.message || 'Save failed'; }
  };
}

/* Announcements overlay */
function openAnnouncements(){ openOverlay('<div>Loading announcement...</div>'); loadAnnouncement(); setTimeout(()=> { overlayPanel.innerHTML = `<h3 class="text-xl font-semibold">Announcements</h3><div class="text-sm">${announceTitle.textContent || 'No announcements'}</div><div class="text-sm mt-2">${announceMsg.textContent || ''}</div>`; }, 300); }

/* Rate delivered order */
function openRate(){ openOverlay('<div>Loading delivered orders...</div>'); openHistoryForRating(); }
async function openHistoryForRating(){
  try {
    const res = await getJSON(`/api/orders?customerId=${suUser.id||suUser._id}`);
    const list = Array.isArray(res) ? res : (res.orders || []);
    const delivered = list.filter(o => (o.status === 'Completed' || o.status === 'Delivered'));
    const node = document.createElement('div');
    node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Rate Delivered Order</h3>`;
    if (!delivered.length) node.innerHTML += `<div class="text-sm">No delivered orders available to rate.</div>`;
    else node.innerHTML += delivered.map(o => `<div class="p-3 border rounded mb-2"><div class="font-medium">Order ${o._id || o.id}</div><div class="text-sm">${o.pickupAddress || ''} → ${o.deliveryAddress || ''}</div><div class="mt-2"><button data-id="${o._id||o.id}" class="btn-primary doRate">Rate</button></div></div>`).join('');
    overlayPanel.innerHTML = ''; overlayPanel.appendChild(node);
    overlay.querySelectorAll('.doRate').forEach(b => b.addEventListener('click', e=> openRatingModal(e.currentTarget.dataset.id)));
  } catch(e){ overlayPanel.innerHTML = `<div class="text-sm text-red-600">Failed: ${e.message}</div>`; }
}
function openRatingModal(orderId){
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Rate Order ${orderId}</h3><div id="starRow" class="text-2xl mb-3">★★★★★</div><textarea id="ratingComment" class="w-full p-3 rounded" placeholder="Comment (optional)"></textarea><div class="flex gap-2 mt-3"><button id="submitRating" class="btn-primary">Submit</button><button id="closeRating" class="btn-ghost">Close</button></div>`;
  openOverlay(node);
  let rating = 5;
  document.getElementById('starRow').addEventListener('click', (ev) => {
    const idx = Math.ceil((ev.offsetX / ev.currentTarget.clientWidth) * 5);
    rating = Math.max(1, Math.min(5, idx));
    ev.currentTarget.textContent = '★★★★★'.slice(0, rating) + '☆☆☆☆☆'.slice(rating);
  });
  document.getElementById('submitRating').addEventListener('click', async ()=>{
    const comment = document.getElementById('ratingComment').value;
    try {
      await fetch(API_BASE + `/api/orders/${orderId}/rate`, { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${token}` }, body: JSON.stringify({ rating, comment })});
      showToast('Thanks for rating!');
      closeOverlay();
    } catch(e){ showToast(e.message || 'Rating failed'); }
  });
  document.getElementById('closeRating').addEventListener('click', closeOverlay);
}

/* Report */
function openReport(){
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Report an Issue</h3><label class="text-xs">Order ID (optional)</label><input id="rOrder" class="w-full p-3 rounded mt-1" /><label class="text-xs mt-2">Message</label><textarea id="rMsg" class="w-full p-3 rounded mt-1"></textarea><div class="flex gap-2 mt-3"><button id="sendReport" class="btn-primary">Send Report</button><button id="closeReport" class="btn-ghost">Close</button></div>`;
  openOverlay(node);
  document.getElementById('closeReport').onclick = closeOverlay;
  document.getElementById('sendReport').onclick = async ()=>{
    const orderId = document.getElementById('rOrder').value.trim();
    const message = document.getElementById('rMsg').value.trim();
    if (!message) { showToast('Please write a message'); return; }
    try {
      await fetch(API_BASE + '/api/admin-requests', { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${token}` }, body: JSON.stringify({ orderId: orderId || null, message })});
      showToast('Report sent to admin.');
      closeOverlay();
    } catch(e){ showToast(e.message || 'Failed to send report'); }
  };
}

/* Settings */
function openSettings(){
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Settings</h3><div class="flex items-center justify-between"><div><div class="font-medium">Theme</div><div class="text-sm text-gray-500">Toggle dark mode</div></div><label class="inline-flex items-center"><input id="themeToggle" type="checkbox" class="mr-2" />Dark</label></div><div class="flex gap-2 mt-4"><button id="closeSet" class="btn-ghost">Close</button><button id="logoutBtn" class="btn-ghost text-red-600">Logout</button></div>`;
  openOverlay(node);
  const t = document.getElementById('themeToggle');
  t.checked = !!localStorage.getItem('su_theme_dark');
  t.addEventListener('change', (e)=> { applyTheme(e.target.checked); if (e.target.checked) localStorage.setItem('su_theme_dark','1'); else localStorage.removeItem('su_theme_dark'); });
  document.getElementById('closeSet').onclick = closeOverlay;
  document.getElementById('logoutBtn').onclick = ()=> { localStorage.removeItem('su_token'); localStorage.removeItem('su_user'); location.href='index.html' };
}

/* ====== misc helpers ====== */
function escapeHtml(s){ return String(s || '').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
async function refreshHistory(){ try { await getJSON(`/api/orders?customerId=${suUser.id||suUser._id}`); } catch(e){} }

/* theme */
function applyTheme(dark){ if (dark) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }

/* ====== Guidance for Google Maps message ======
 If you see "This page can't load Google Maps correctly. Do you own this website?" in the map, that typically means:
  - the API key is restricted to certain domains and your current host isn't allowed, OR
  - Google billing isn't enabled for the key, OR
  - the key is invalid.
 Steps:
 1) In Google Cloud Console, enable Maps JavaScript API and Places API for the project
 2) Ensure billing is enabled.
 3) If you restricted the key by HTTP referrers, add your host (or remove restriction during dev).
 I can't change your Google key or billing — please check those if you see that dialog.
*/

/* ====== Log network falling back behavior to console (for debugging) ====== */
/* The tryPaths helper logs to console when a path fails (so you'll see which exact endpoints are 404).
   If after deploying you still see "Not found" errors, open DevTools > Network and copy a sample response here
   so I can wire the exact expected fields (order id property names etc). */
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SkyUltimate — Customer Dashboard</title>

  <!-- Hardcoded config -->
  <script>
    // ** HARD-CODED (as requested) **
    const BACKEND = "https://skyultimate-backend-api-structure.onrender.com";
    const GOOGLE_MAPS_KEY = "AIzaSyAXZf0hfz_eiyAD5rnVEzmTgWmxIYmODiE";
    const LOGO = "https://github.com/Nelson192006/SkyUltimate-/blob/4e77ffc850e3621ae15902180075ad00958f4491/logo.png?raw=true";
    const TOKEN_KEY = "token"; // your login page must store auth token here
    const WS_PATH = "/ws"; // attempted WebSocket path (wss://.../ws)
  </script>

  <style>
    /* Minimal reset + premium red/white theme */
    :root{
      --red:#C00000;
      --bg:#fff;
      --muted:#6b7280;
      --card-radius:14px;
      --glass: rgba(255,255,255,0.85);
      --shadow: 0 6px 18px rgba(0,0,0,0.08);
      --maxw:1100px;
    }
    [data-theme="dark"]{
      --bg:#0b0b0c;
      --muted:#9ca3af;
      --glass: rgba(10,10,10,0.65);
    }
    *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;}
    body{margin:0;background:linear-gradient(180deg, #fff 0%, #fff 60%);color:#111;min-height:100vh;}
    .app{max-width:var(--maxw);margin:18px auto;padding:18px;}
    .header{height:68px;display:flex;align-items:center;justify-content:space-between;gap:12px;position:sticky;top:0;background:var(--glass);backdrop-filter:blur(6px);padding:8px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:40}
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:52px;height:52px;border-radius:50%;object-fit:cover;border:2px solid var(--red)}
    .brand h1{font-size:20px;margin:0}
    .hamburger{position:relative}
    .menu-btn{background:transparent;border:0;padding:8px;border-radius:8px;cursor:pointer}
    .menu{position:absolute;right:0;top:54px;background:white;border-radius:10px;min-width:220px;box-shadow:0 10px 30px rgba(0,0,0,0.12);overflow:hidden}
    .menu a{display:block;padding:10px 12px;color:#111;text-decoration:none;font-weight:600}
    .menu a:hover{background:#f8f8f8}
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-top:18px}
    .card{background:var(--bg);border-radius:var(--card-radius);padding:18px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px 0}
    .form-row{display:flex;gap:10px;margin-top:10px}
    input[type="text"], input[type="number"], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e6e6;font-size:14px}
    .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:0;background:var(--red);color:white;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--red);border:1px solid rgba(192,0,0,0.12)}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    #map { height:360px;border-radius:12px;margin-top:12px;border:1px solid #eee }
    .toast-wrap{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    .toast{padding:10px 14px;border-radius:10px;background:#111;color:white;box-shadow:0 8px 30px rgba(0,0,0,0.22)}
    .price-box{display:inline-flex;align-items:center;gap:12px;padding:8px 12px;border-radius:10px;background:#fff3f3;border:1px solid rgba(192,0,0,0.08)}
    .order-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .order-item{display:flex;justify-content:space-between;padding:10px;border-radius:10px;border:1px solid #f0f0f0}
    .sublabel{font-size:12px;color:var(--muted)}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:999}
    .modal{width:100%;max-width:760px;background:var(--bg);padding:18px;border-radius:12px;box-shadow:var(--shadow)}
    .top-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .chip{padding:6px 10px;border-radius:999px;background:#fff4f4;color:var(--red);font-weight:700;border:1px solid rgba(192,0,0,0.08)}
    .footer-note{margin-top:18px;color:var(--muted);font-size:13px}
    .skeleton{height:14px;background:#f3f3f3;border-radius:6px}
    .hidden{display:none}
  </style>
</head>
<body>
  <!-- Splashscreen -->
  <div id="splash" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--red),#ffefef);z-index:9999;flex-direction:column">
    <img src="" id="splashLogo" style="width:110px;height:110px;border-radius:50%;box-shadow:0 10px 30px rgba(0,0,0,0.12)" alt="logo">
    <h2 style="color:white;margin-top:16px">SkyUltimate</h2>
  </div>

  <div class="app" id="app" style="opacity:0">
    <div class="header card" role="banner">
      <div class="brand">
        <img id="topLogo" src="" alt="logo">
        <div>
          <h1>SkyUltimate</h1>
          <div class="sublabel">Fast & Reliable Delivery</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div id="userName" class="sublabel"></div>
        <div class="hamburger">
          <button class="menu-btn" id="menuToggle" title="Menu">☰</button>
          <div id="menu" class="menu hidden" role="menu" aria-hidden="true">
            <a href="#" id="menuProfile">Profile</a>
            <a href="#" id="menuOrders">My Orders</a>
            <a href="#" id="menuAnalytics">Service Analytics</a>
            <a href="#" id="menuSupport">Support</a>
            <a href="#" id="menuTheme">Toggle Theme</a>
            <a href="#" id="menuLogout">Logout</a>
          </div>
        </div>
      </div>
    </div>

    <main class="grid">
      <!-- Main column -->
      <section class="card">
        <h2>Place a New Order</h2>
        <div class="muted">Fill pickup & drop-off details, calculate price, then pay via bank transfer.</div>

        <div style="margin-top:12px">
          <label class="sublabel">Pickup address</label>
          <input id="pickup" type="text" placeholder="Pickup address" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="useMyLocation" class="btn ghost">Use My Location</button>
            <button id="locatePickup" class="btn ghost">Locate Pickup</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <label class="sublabel">Dropoff address</label>
          <input id="dropoff" type="text" placeholder="Dropoff address" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="locateDropoff" class="btn ghost">Locate Dropoff</button>
          </div>
        </div>

        <div class="form-row" style="margin-top:12px">
          <div style="flex:1">
            <label class="sublabel">Weight (kg)</label>
            <input id="weight" type="number" min="0.1" step="0.1" placeholder="1.0" value="1" />
          </div>
          <div style="width:200px">
            <label class="sublabel">Service type</label>
            <select id="service">
              <option value="standard">Standard</option>
              <option value="express">Express</option>
              <option value="priority">Priority</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px">
          <label class="sublabel">Description</label>
          <textarea id="description" rows="3" placeholder="Short description of items"></textarea>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
          <button id="calcPrice" class="btn">Calculate Price</button>
          <div id="priceWrap" class="price-box hidden"><span class="small">Price</span><strong id="priceValue">₦0</strong></div>
          <div style="flex:1"></div>
          <button id="proceedPayment" class="btn ghost hidden">Proceed to Payment</button>
        </div>

        <div id="map" ></div>

        <div class="footer-note">After payment, click <strong>I Have Paid</strong> inside the payment dialog. Super Admin will confirm payment and agents will be notified.</div>
      </section>

      <!-- Right column -->
      <aside class="card">
        <h3>My Profile</h3>
        <div id="profileArea" style="margin-top:10px">
          <label class="sublabel">Name</label>
          <input id="name" type="text" />
          <label class="sublabel" style="margin-top:8px">Email</label>
          <input id="email" type="text" disabled />
          <label class="sublabel" style="margin-top:8px">Phone</label>
          <input id="phone" type="text" />
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="saveProfile" class="btn">Save Profile</button>
            <button id="refreshProfile" class="btn ghost">Refresh</button>
          </div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid #f0f0f0" />

        <h3>My Orders</h3>
        <div id="ordersList" class="order-list">
          <!-- orders injected here -->
        </div>

        <div style="margin-top:12px">
          <button id="refreshOrders" class="btn ghost">Refresh Orders</button>
        </div>
      </aside>
    </main>
  </div>

  <!-- Payment modal -->
  <div id="paymentModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Manual Payment — Bank Details</h3>
        <button id="closePayModal" class="menu-btn">✕</button>
      </div>
      <div id="bankDetailsWrap" style="margin-top:12px"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="iHavePaid" class="btn">I Have Paid</button>
        <button id="cancelPay" class="btn ghost">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-wrap" id="toasts"></div>

  <script>
  /************* Utilities & App State *************/
  const token = localStorage.getItem(TOKEN_KEY);
  const authHeaders = token ? { "Authorization": "Bearer " + token } : {};
  const toastsEl = document.getElementById('toasts');
  const showToast = (msg, ttl=3500) => {
    const div = document.createElement('div'); div.className='toast'; div.textContent = msg; toastsEl.appendChild(div);
    setTimeout(()=>{ div.style.transition='all .3s'; div.style.opacity = '0'; setTimeout(()=>div.remove(),300); }, ttl);
  };

  // DOM elements
  const splash = document.getElementById('splash');
  document.getElementById('splashLogo').src = LOGO;
  document.getElementById('topLogo').src = LOGO;

  const app = document.getElementById('app');
  const menuToggle = document.getElementById('menuToggle');
  const menu = document.getElementById('menu');
  const menuProfile = document.getElementById('menuProfile');
  const menuOrders = document.getElementById('menuOrders');
  const menuAnalytics = document.getElementById('menuAnalytics');
  const menuSupport = document.getElementById('menuSupport');
  const menuTheme = document.getElementById('menuTheme');
  const menuLogout = document.getElementById('menuLogout');

  // order form elements
  const pickupEl = document.getElementById('pickup');
  const dropoffEl = document.getElementById('dropoff');
  const weightEl = document.getElementById('weight');
  const serviceEl = document.getElementById('service');
  const descEl = document.getElementById('description');
  const calcBtn = document.getElementById('calcPrice');
  const priceWrap = document.getElementById('priceWrap');
  const priceValue = document.getElementById('priceValue');
  const proceedPaymentBtn = document.getElementById('proceedPayment');
  const mapEl = document.getElementById('map');

  // profile
  const nameEl = document.getElementById('name');
  const emailEl = document.getElementById('email');
  const phoneEl = document.getElementById('phone');
  const saveProfileBtn = document.getElementById('saveProfile');
  const refreshProfileBtn = document.getElementById('refreshProfile');
  const userNameBadge = document.getElementById('userName');

  // orders
  const ordersListEl = document.getElementById('ordersList');
  const refreshOrdersBtn = document.getElementById('refreshOrders');

  // payment modal
  const paymentModal = document.getElementById('paymentModal');
  const closePayModal = document.getElementById('closePayModal');
  const cancelPay = document.getElementById('cancelPay');
  const bankDetailsWrap = document.getElementById('bankDetailsWrap');
  const iHavePaidBtn = document.getElementById('iHavePaid');

  // other controls
  const useMyLocationBtn = document.getElementById('useMyLocation');
  const locatePickupBtn = document.getElementById('locatePickup');
  const locateDropoffBtn = document.getElementById('locateDropoff');

  // runtime state
  let profile = null;
  let map, geocoder, pickupMarker, dropoffMarker, agentMarker;
  let lastCalculatedPrice = null;
  let currentCreatedOrder = null;
  let orders = [];
  let ws = null;
  let selectedOrderForPayment = null;

  /************* Small helpers *************/
  function authFetch(url, opts={}){
    opts.headers = Object.assign(opts.headers || {}, {"Content-Type":"application/json"}, authHeaders);
    if(opts.body && typeof opts.body !== 'string') opts.body = JSON.stringify(opts.body);
    return fetch(url, opts).then(async r => {
      const text = await r.text();
      try { return { ok: r.ok, status: r.status, json: text ? JSON.parse(text) : null }; } catch(e){ return { ok: r.ok, status: r.status, text }; }
    });
  }

  function formatCurrency(n){ try{ return '₦' + Number(n).toLocaleString(); }catch(e){ return '₦' + n; } }

  function toRadians(d){ return d * Math.PI / 180; }
  function haversine(lat1, lon1, lat2, lon2){
    const R=6371000; const dLat=toRadians(lat2-lat1); const dLon=toRadians(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRadians(lat1))*Math.cos(toRadians(lat2))*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  /************* Auth guard *************/
  if(!token){
    alert("No auth token found. Please login first.");
    // Redirect to login page (assumes login page path is /login.html)
    // Change as necessary based on your site.
    window.location.href = "/login.html";
  }

  /************* Splashscreen & init *************/
  function hideSplash(){ splash.style.transition='opacity .6s'; splash.style.opacity='0'; setTimeout(()=>splash.remove(),700); app.style.transition='opacity .5s'; app.style.opacity = '1'; }
  setTimeout(()=>{ init(); hideSplash(); }, 1200); // short splash to load resources

  /************* Map & geocoding *************/
  function loadGoogleMaps(cb){
    if(window.google && window.google.maps){ cb(); return; }
    const s = document.createElement('script');
    s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_KEY}&libraries=places`;
    s.async=true; s.defer=true;
    s.onload = cb;
    document.head.appendChild(s);
  }

  function initMap(){
    if(!mapEl) return;
    map = new google.maps.Map(mapEl, { center:{lat:6.5244,lng:3.3792}, zoom:12, disableDefaultUI:true });
    geocoder = new google.maps.Geocoder();
  }

  function setMarker(type, lat, lng){
    const pos = { lat, lng };
    if(type==='pickup'){
      if(!pickupMarker) pickupMarker = new google.maps.Marker({ map, title:'Pickup', label:'P' });
      pickupMarker.setPosition(pos); map.panTo(pos);
    } else if(type==='dropoff'){
      if(!dropoffMarker) dropoffMarker = new google.maps.Marker({ map, title:'Dropoff', label:'D' });
      dropoffMarker.setPosition(pos); map.panTo(pos);
    } else if(type==='agent'){
      if(!agentMarker) agentMarker = new google.maps.Marker({ map, title:'Agent', label:'A' });
      agentMarker.setPosition(pos);
    }
  }

  function geocodeAddress(address, target){
    return new Promise((resolve, reject) => {
      if(!geocoder) return reject('no geocoder');
      geocoder.geocode({ address }, (results, status) => {
        if(status === 'OK' && results[0]){
          const loc = results[0].geometry.location;
          setMarker(target, loc.lat(), loc.lng());
          resolve({ lat: loc.lat(), lng: loc.lng(), formatted: results[0].formatted_address });
        } else reject(status);
      });
    });
  }

  /************* Profile & orders *************/
  async function fetchProfile(){
    try{
      const res = await authFetch(BACKEND + "/api/auth/profile", { method:'GET' });
      if(!res.ok){ showToast("Could not fetch profile — please login again"); return; }
      profile = res.json;
      nameEl.value = profile.name || '';
      emailEl.value = profile.email || '';
      phoneEl.value = profile.phone || '';
      userNameBadge.textContent = profile.name || profile.email || '';
    }catch(e){ console.error(e); showToast("Profile fetch error"); }
  }

  async function saveProfile(){
    try{
      const payload = { name: nameEl.value, phone: phoneEl.value };
      const res = await authFetch(BACKEND + "/api/auth/me/bank", { method:'PUT', body: payload });
      if(!res.ok) { showToast("Could not update profile"); return; }
      showToast("Profile updated");
      await fetchProfile();
    }catch(e){ console.error(e); showToast("Save profile failed"); }
  }

  async function fetchOrders(){
    try{
      // backend GET /api/orders returns orders (possibly all). We'll filter to current user on frontend if necessary.
      const res = await authFetch(BACKEND + "/api/orders", { method:'GET' });
      if(!res.ok){ showToast("Could not load orders"); return; }
      const list = res.json || [];
      // if orders include customer as id property, try to filter
      const myOrders = list.filter(o => {
        if(!profile || !profile._id) return false;
        // many backends use customer field or customerId
        return (o.customer && (o.customer === profile._id || (o.customer._id && o.customer._id === profile._id))) ||
               (o.customerId && o.customerId === profile._id) ||
               (o.customer === profile.email);
      });
      // fallback: if none matched, assume backend returned only user's orders
      orders = myOrders.length ? myOrders : list;
      renderOrders();
    }catch(e){ console.error(e); showToast("Load orders failed"); }
  }

  function renderOrders(){
    ordersListEl.innerHTML = '';
    if(!orders || orders.length === 0){ ordersListEl.innerHTML = '<div class="sublabel">No orders yet</div>'; return; }
    orders.forEach(o => {
      const div = document.createElement('div'); div.className='order-item';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">Order ${o._id || o.id}</div>
                        <div class="small muted">${o.status || '—'}</div>
                        <div class="sublabel">Price: ${formatCurrency(o.finalPrice || o.price || o.total || 0)}</div>`;
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
      const trackBtn = document.createElement('button'); trackBtn.className='btn ghost'; trackBtn.textContent='Track'; trackBtn.onclick = ()=> openLiveTracking(o);
      const detailsBtn = document.createElement('button'); detailsBtn.className='btn'; detailsBtn.textContent='Details'; detailsBtn.onclick = ()=> showOrderDetails(o);
      right.appendChild(trackBtn); right.appendChild(detailsBtn);
      div.appendChild(left); div.appendChild(right);
      ordersListEl.appendChild(div);
    });
  }

  function openLiveTracking(order){
    // switch map view to center on agent or order
    if(order.agent && order.agent.lat && order.agent.lng){
      setMarker('agent', order.agent.lat, order.agent.lng);
      map.setZoom(15);
      showToast('Centered on agent');
    } else {
      showToast('Agent not yet assigned for this order');
    }
  }

  function showOrderDetails(order){
    // quick modal showing details
    const msg = `Order ${order._id || order.id}\nStatus: ${order.status}\nPrice: ${formatCurrency(order.finalPrice || order.price || 0)}\nPickup: ${order.pickupAddress?.line || '—'}\nDelivery: ${order.deliveryAddress?.line || '—'}`;
    alert(msg);
  }

  /************* Price calc, create order & payment flow *************/
  calcBtn.addEventListener('click', async ()=>{
    const pickup = pickupEl.value.trim();
    const dropoff = dropoffEl.value.trim();
    const weight = Number(weightEl.value) || 1;
    const service = serviceEl.value;
    if(!pickup || !dropoff){ showToast('Please provide pickup & dropoff addresses'); return; }

    // Convert weight into a simple items array for backend calc (backend expects items)
    const items = [{ name: 'Parcel', quantity: 1, price: Math.round(weight * 100) }];
    try{
      showToast('Calculating price...');
      const res = await authFetch(BACKEND + "/api/orders/calc-price", { method:'POST', body: { items } });
      if(!res.ok){ showToast('Price calculation failed'); return; }
      const body = res.json;
      const price = body.finalPrice ?? body.price ?? body.finalAmount ?? 0;
      lastCalculatedPrice = price;
      priceWrap.classList.remove('hidden');
      priceValue.textContent = formatCurrency(price);
      proceedPaymentBtn.classList.remove('hidden');
      showToast('Price calculated: ' + formatCurrency(price));
    }catch(e){ console.error(e); showToast('Could not calculate price'); }
  });

  proceedPaymentBtn.addEventListener('click', async ()=>{
    // create the order on backend (status PendingPayment)
    const pickup = pickupEl.value.trim();
    const dropoff = dropoffEl.value.trim();
    const weight = Number(weightEl.value) || 1;
    const desc = descEl.value.trim();
    const items = [{ name: 'Parcel', quantity: 1, price: Math.round(weight * 100), description: desc }];
    const payload = {
      items,
      pickupAddress: { line: pickup },
      deliveryAddress: { line: dropoff },
      paymentMethod: 'Bank Transfer'
    };
    try{
      showToast('Creating order...');
      const res = await authFetch(BACKEND + "/api/orders", { method:'POST', body: payload });
      if(!res.ok){ console.error(res); showToast('Could not create order'); return; }
      const data = res.json;
      currentCreatedOrder = data.order || data;
      selectedOrderForPayment = currentCreatedOrder;
      // bank details may be returned under superAdminBankDetails
      const bankDetails = data.superAdminBankDetails || data.bankDetails || { bank: 'Moniepoint', account: '000000000', name: 'SkyUltimate' };
      showPaymentModal(bankDetails, currentCreatedOrder);
      showToast('Order created. Please complete payment using the shown details.');
      await fetchOrders();
    }catch(e){ console.error(e); showToast('Order creation failed'); }
  });

  function showPaymentModal(bankDetails, order){
    bankDetailsWrap.innerHTML = '';
    bankDetailsWrap.innerHTML += `<div class="sublabel">Order ID: <strong>${order._id || order.id}</strong></div>`;
    bankDetailsWrap.innerHTML += `<div style="margin-top:8px">${bankDetails.bankName || bankDetails.bank || 'Bank'} — ${bankDetails.accountNumber || bankDetails.account || bankDetails.number || '—'}</div>`;
    if(bankDetails.accountHolderName || bankDetails.name) bankDetailsWrap.innerHTML += `<div>${bankDetails.accountHolderName || bankDetails.name}</div>`;
    paymentModal.classList.remove('hidden');
  }

  closePayModal.onclick = cancelPay.onclick = ()=> paymentModal.classList.add('hidden');

  iHavePaidBtn.addEventListener('click', async ()=>{
    if(!selectedOrderForPayment){ showToast('No order selected'); return; }
    const id = selectedOrderForPayment._id || selectedOrderForPayment.id;
    // call a reasonable endpoint to mark 'submitted for confirmation' — backend may need to implement this if missing
    try{
      showToast('Notifying server of payment...');
      const res = await authFetch(BACKEND + "/api/orders/" + id + "/submit-payment", { method:'POST', body: { note: 'Customer marked as paid' } });
      if(!res.ok){
        // fallback: try /api/orders/:id/payment
        const fallback = await authFetch(BACKEND + "/api/orders/" + id + "/payment", { method:'POST', body: { note:'Customer paid (front-end)' } });
        if(!fallback.ok){ showToast('Failed to notify payment — contact support'); paymentModal.classList.add('hidden'); return; }
        showToast('Payment submitted for confirmation');
      } else showToast('Payment submitted for confirmation');
      paymentModal.classList.add('hidden');
      await fetchOrders();
    }catch(e){ console.error(e); showToast('Payment submit failed'); paymentModal.classList.add('hidden'); }
  });

  /************* WebSocket real-time (attempt) *************/
  async function connectWS(){
    try{
      const scheme = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const url = scheme + '//' + (new URL(BACKEND)).host + WS_PATH;
      ws = new WebSocket(url);
      ws.onopen = ()=> { console.log('ws open', url); showToast('Real-time connected'); };
      ws.onmessage = ev => {
        try{
          const msg = JSON.parse(ev.data);
          // expected shapes: { type:'order_update', order } or {type:'agent_location', orderId, agent}
          if(msg.type === 'order_update' && msg.order){
            // update local orders if matching
            const updated = msg.order;
            orders = orders.map(o => (o._id === updated._id || o.id === updated.id) ? updated : o);
            renderOrders();
            if(updated.status === 'PaymentConfirmed') showToast('Payment confirmed for order ' + (updated._id || updated.id));
          }
          if(msg.type === 'agent_location'){
            const orderId = msg.orderId;
            const agent = msg.agent;
            if(agent && agent.lat && agent.lng){
              setMarker('agent', agent.lat, agent.lng);
            }
          }
        }catch(e){ console.warn('ws parse fail', e); }
      };
      ws.onclose = ()=>{ console.log('ws closed — will retry in 8s'); setTimeout(connectWS, 8000); };
      ws.onerror = e => { console.error('ws error', e); ws.close(); };
    }catch(e){ console.error('ws connect', e); }
  }

  /************* UI & Menu *************/
  menuToggle.addEventListener('click', ()=> menu.classList.toggle('hidden'));
  menuProfile.addEventListener('click', (e)=>{ e.preventDefault(); window.scrollTo({top:0,behavior:'smooth'}); nameEl.focus(); menu.classList.add('hidden'); });
  menuOrders.addEventListener('click', (e)=>{ e.preventDefault(); window.scrollTo({top:400,behavior:'smooth'}); menu.classList.add('hidden'); });
  menuAnalytics.addEventListener('click', (e)=>{ e.preventDefault(); alert('Service Analytics: currently minimal — will show totals.'); menu.classList.add('hidden'); });
  menuSupport.addEventListener('click', (e)=>{ e.preventDefault(); alert('Contact support: +234 000 000 000'); menu.classList.add('hidden'); });
  menuTheme.addEventListener('click', (e)=>{ e.preventDefault(); toggleTheme(); menu.classList.add('hidden'); });
  menuLogout.addEventListener('click', (e)=>{ e.preventDefault(); localStorage.removeItem(TOKEN_KEY); window.location.href='/login.html'; });

  saveProfileBtn.addEventListener('click', async ()=> { await saveProfile(); });
  refreshProfileBtn.addEventListener('click', async ()=> { await fetchProfile(); showToast('Profile refreshed'); });

  refreshOrdersBtn.addEventListener('click', async ()=> { await fetchOrders(); showToast('Orders refreshed'); });

  useMyLocationBtn.addEventListener('click', ()=> {
    if(!navigator.geolocation) return showToast('Geolocation unavailable');
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      setMarker('pickup', latitude, longitude);
      pickupEl.value = 'My location';
      showToast('Pickup set to your location');
    }, ()=> showToast('Could not get location'));
  });

  locatePickupBtn.addEventListener('click', async ()=> {
    const a = pickupEl.value.trim(); if(!a) return showToast('Enter pickup address first');
    try{ await geocodeAddress(a,'pickup'); showToast('Pickup located'); }catch(e){ showToast('Could not geocode pickup'); }
  });

  locateDropoffBtn.addEventListener('click', async ()=> {
    const a = dropoffEl.value.trim(); if(!a) return showToast('Enter dropoff address first');
    try{ await geocodeAddress(a,'dropoff'); showToast('Dropoff located'); }catch(e){ showToast('Could not geocode dropoff'); }
  });

  /************* Theme toggle *************/
  function toggleTheme(){
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
  }
  // apply saved theme
  (function(){ const t = localStorage.getItem('theme') || 'light'; document.documentElement.setAttribute('data-theme', t); })();

  /************* Init: load profile, map, orders, ws *************/
  async function init(){
    // load profile
    await fetchProfile();
    // load map
    loadGoogleMaps(()=>{ initMap(); });
    // connect ws
    connectWS();
    // fetch orders
    await fetchOrders();
  }

  /************* Export small helper for other pages (optional) *************/
  window.SkyUltimate = { fetchOrders };

  </script>
</body>
</html>

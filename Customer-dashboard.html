<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SkyUltimate — Customer Dashboard</title>

  <!-- Tailwind (for compact markup) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Maps & Places (uses your provided key) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAXZf0hfz_eiyAD5rnVEzmTgWmxIYmODiE&libraries=places" async defer></script>

  <style>
    :root{
      --brand-red: #C00000;
      --brand-red-dark: #900000;
      --glass: rgba(255,255,255,0.92);
    }
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; -webkit-font-smoothing:antialiased;}
    body{background: linear-gradient(180deg,#fff9f9 0%, #fff 100%); color:#071032;}
    .card{background:var(--glass); border-radius:18px; padding:18px; box-shadow:0 10px 30px rgba(2,6,23,0.06);}
    .logo-round{width:66px;height:66px;border-radius:9999px;object-fit:cover;box-shadow:0 8px 28px rgba(0,0,0,0.12);}
    .btn-primary{background:linear-gradient(180deg,var(--brand-red),var(--brand-red-dark));color:#fff;padding:11px 16px;border-radius:12px;font-weight:700;box-shadow:0 8px 30px rgba(192,0,0,0.18);}
    .btn-ghost{background:#fff;border:1px solid #eee;padding:10px 14px;border-radius:12px;}
    .map{height:320px;border-radius:12px;overflow:hidden;border:1px solid #e6eef6}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:90}
    .overlay.show{display:flex}
    .overlay-backdrop{position:absolute;inset:0;background:rgba(8,12,20,0.6)}
    .overlay-panel{position:relative;z-index:92;width:100%;max-width:980px;margin:24px;}
    .toast{position:fixed;right:18px;bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:110}
    .toast.show{display:block}
    .chip{display:inline-block;padding:6px 12px;border-radius:999px;background:#fff;border:1px solid #eee;font-weight:600}
    .no-scroll{overflow:hidden;height:100%}
    /* Dark theme */
    .dark body{background:#071026;color:#e6eef8}
    .dark .card{background: rgba(8,12,20,0.55); color:#e6eef8; box-shadow:none}
    .dark .btn-ghost{background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.06); color:#e6eef8}
    .dark .chip{background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.06); color:#e6eef8}
    @media (max-width:640px){ .logo-round{width:54px;height:54px} .map{height:220px} .overlay-panel{max-width:96%} }
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="sticky top-0 z-40">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between bg-opacity-60 backdrop-blur-sm">
      <div class="flex items-center gap-3">
        <button id="hamburger" class="p-2 rounded-md hover:bg-white/20" title="Menu" aria-label="Menu">
          <svg width="22" height="14" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="#071032" stroke-width="1.6" stroke-linecap="round"/></svg>
        </button>
        <img id="siteLogo" class="logo-round" src="https://github.com/Nelson192006/SkyUltimate-/blob/4e77ffc850e3621ae15902180075ad00958f4491/logo.png?raw=true" alt="SkyUltimate"/>
      </div>

      <!-- only welcome text (no extra text beside logo) -->
      <div class="flex items-center gap-3">
        <div id="welcomeSmall" class="font-semibold text-lg">Welcome!</div>
        <button id="settingsBtn" class="p-2 rounded-md hover:bg-white/20" title="Settings" aria-label="Settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 15.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7zM19.4 12.7l1.1-2.1-2.3-4-2.4.6a8.4 8.4 0 00-1.6-.9l-.4-2.4h-4.4l-.4 2.4c-.5.2-1 .5-1.5.9l-2.4-.6-2.3 4 1.1 2.1c-.1.6-.1 1.3 0 1.9l-1.1 2.1 2.3 4 2.4-.6c.5.4 1 .7 1.5.9l.4 2.4h4.4l.4-2.4c.6-.2 1.1-.5 1.6-.9l2.4.6 2.3-4-1.1-2.1c.1-.6.1-1.3 0-1.9z" stroke="#071032" stroke-width="0.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <!-- Announcement -->
    <div id="announceBanner" class="card hidden">
      <div id="announceTitle" class="text-xl font-semibold text-red-700"></div>
      <div id="announceMsg" class="text-sm mt-1 text-gray-700"></div>
    </div>

    <!-- Hero & Order placement -->
    <section class="card">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h1 id="greetingBig" class="text-2xl font-bold">Welcome back!</h1>
          <p id="greetingSub" class="text-sm text-gray-600 mt-1">Place a new delivery — secure, fast and tracked.</p>
        </div>
        <div class="text-right">
          <div class="text-xs text-gray-500">Role</div>
          <div id="roleBadge" class="chip mt-2">Customer</div>
        </div>
      </div>

      <hr class="my-4" />

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs text-gray-600">Pickup — full recipient address</label>
          <input id="pickup" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="e.g., 12B Allen Ave, Ikeja" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Drop-off — delivery address</label>
          <input id="dropoff" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="Recipient address" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Recipient full name</label>
          <input id="recipient" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="Recipient full name" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Recipient phone</label>
          <input id="recipientPhone" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="+234 9xxxxxxxxx" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Item category</label>
          <select id="itemCategory" class="w-full mt-1 p-3 rounded-lg border border-gray-100">
            <option value="documents">Documents</option>
            <option value="food">Food</option>
            <option value="groceries">Groceries</option>
            <option value="parcel">Parcel</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div>
          <label class="text-xs text-gray-600">Weight (kg)</label>
          <input id="weight" type="number" min="0" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="e.g., 2" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Service type</label>
          <select id="service" class="w-full mt-1 p-3 rounded-lg border border-gray-100">
            <option value="standard">Standard</option>
            <option value="express">Express</option>
            <option value="same-day">Same-day</option>
          </select>
        </div>

        <div class="md:col-span-2 flex gap-3 mt-2">
          <button id="calcPrice" class="btn-primary flex-1">Calculate Final Price</button>
          <button id="proceedPayment" class="btn-ghost flex-1">Proceed with Payment</button>
        </div>

        <div id="calcFeedback" class="md:col-span-2 text-sm text-red-600 mt-1"></div>
      </div>
    </section>

    <!-- Tracking card (hidden until payment confirmed) -->
    <section id="tracking" class="card hidden">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-semibold">Order Tracking</h3>
          <div class="text-xs text-gray-500 mt-1">Order ID: <span id="orderId">—</span></div>
        </div>
        <div>
          <span id="orderStatus" class="chip">Pending</span>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <div id="map" class="map"></div>
          <div class="text-xs text-gray-500 mt-2">Agent: <span id="agentName">—</span> • <a id="agentPhone" class="underline" href="#">—</a></div>
        </div>

        <div>
          <h4 class="font-semibold">Journey</h4>
          <div id="timeline" class="mt-3 text-sm text-gray-700"></div>
          <div class="mt-6 flex gap-3">
            <button id="contactAgent" class="btn-ghost">Contact Agent</button>
            <button id="reportBtn" class="btn-primary">Report Agent</button>
          </div>
        </div>
      </div>
    </section>

    <footer class="text-center text-sm text-gray-500">
      Contact: <a id="phoneLink" href="tel:+2349128884830" class="underline">+234 912 888 4830</a> ·
      <a id="whatsappLink" href="https://wa.me/2349128884830" target="_blank" class="underline">WhatsApp</a> ·
      <a id="emailLink" href="mailto:nelsongodspower24@gmail.com" class="underline">Email</a>
    </footer>
  </main>

  <!-- Overlay (full-screen) -->
  <div id="overlay" class="overlay">
    <div id="overlayBackdrop" class="overlay-backdrop"></div>
    <div class="overlay-panel card" id="overlayContent"></div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/*
  Customer Dashboard - Full single-file implementation
  - API base
  - Uses token in localStorage.su_token and user in localStorage.su_user
  - Fallback tryPaths for calc/create endpoints
*/
const API_BASE = "https://skyultimate-backend-api-structure.onrender.com";
const token = localStorage.getItem('su_token');
const suUser = JSON.parse(localStorage.getItem('su_user') || 'null');

// Force auth
if (!token || !suUser) {
  // Redirect to login if not authenticated
  window.location.href = 'index.html';
}

/* === DOM refs === */
const welcomeSmall = document.getElementById('welcomeSmall');
const greetingBig = document.getElementById('greetingBig');
const roleBadge = document.getElementById('roleBadge');

const pickupEl = document.getElementById('pickup');
const dropoffEl = document.getElementById('dropoff');
const recipientEl = document.getElementById('recipient');
const recipientPhoneEl = document.getElementById('recipientPhone');
const itemCategoryEl = document.getElementById('itemCategory');
const weightEl = document.getElementById('weight');
const serviceEl = document.getElementById('service');
const calcPriceBtn = document.getElementById('calcPrice');
const proceedPaymentBtn = document.getElementById('proceedPayment');
const calcFeedback = document.getElementById('calcFeedback');

const announceBanner = document.getElementById('announceBanner');
const announceTitle = document.getElementById('announceTitle');
const announceMsg = document.getElementById('announceMsg');

const overlay = document.getElementById('overlay');
const overlayBackdrop = document.getElementById('overlayBackdrop');
const overlayContent = document.getElementById('overlayContent');

const toastEl = document.getElementById('toast');

const trackingCard = document.getElementById('tracking');
const orderIdEl = document.getElementById('orderId');
const orderStatusEl = document.getElementById('orderStatus');
const timelineEl = document.getElementById('timeline');
const agentNameEl = document.getElementById('agentName');
const agentPhoneLink = document.getElementById('agentPhone');
const contactAgentBtn = document.getElementById('contactAgent');
const reportBtn = document.getElementById('reportBtn');

const hamburgerBtn = document.getElementById('hamburger');
const settingsBtn = document.getElementById('settingsBtn');

/* === Local state === */
let lastCalc = null;
let activeOrder = null;
let pollInterval = null;
let map, agentMarker;

/* === Init === */
(function init() {
  const first = (suUser.name || '').split(' ')[0] || 'there';
  welcomeSmall.innerText = `Hello, ${first}!`;
  greetingBig.innerText = `Welcome back, ${first}!`;
  roleBadge.innerText = suUser.role || 'Customer';

  hamburgerBtn.addEventListener('click', openMenu);
  settingsBtn.addEventListener('click', openSettings);
  overlayBackdrop.addEventListener('click', closeOverlay);

  calcPriceBtn.addEventListener('click', onCalculatePrice);
  proceedPaymentBtn.addEventListener('click', onProceedPayment);

  contactAgentBtn.addEventListener('click', () => {
    if (agentPhoneLink && agentPhoneLink.href) location.href = agentPhoneLink.href;
  });
  reportBtn.addEventListener('click', openReportOverlay);

  initPlaces();        // Google Places autocomplete
  loadAnnouncement();  // Fetch announcement from backend
  applyTheme(localStorage.getItem('su_theme') === 'dark');

  // If a previous active order exists locally, resume tracking
  const saved = localStorage.getItem('su_active_order');
  if (saved) {
    try {
      const ord = JSON.parse(saved);
      if (ord && (ord._id || ord.id)) openTracking(ord._id || ord.id);
    } catch(e){}
  }
})();

/* === Helpers: toast & overlay === */
function showToast(msg = '', type = 'info', timeout = 3500) {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  if (type === 'error') toastEl.style.background = '#b91c1c';
  else if (type === 'success') toastEl.style.background = '#047857';
  else toastEl.style.background = '#111827';
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=> { toastEl.classList.remove('show'); toastEl.style.background = ''; }, timeout);
}
function openOverlay(content) {
  if (typeof content === 'string') overlayContent.innerHTML = content;
  else {
    overlayContent.innerHTML = '';
    overlayContent.appendChild(content);
  }
  overlay.classList.add('show');
  document.documentElement.classList.add('no-scroll');
}
function closeOverlay() {
  overlay.classList.remove('show');
  overlayContent.innerHTML = '';
  document.documentElement.classList.remove('no-scroll');
}
function setBtnLoading(btn, isLoading) {
  if (!btn) return;
  if (isLoading) { btn.dataset.prev = btn.innerHTML; btn.disabled = true; btn.innerHTML = 'Please wait...'; }
  else { btn.disabled = false; if (btn.dataset.prev) { btn.innerHTML = btn.dataset.prev; delete btn.dataset.prev; } }
}

/* === HTTP helpers (auth header included) === */
async function getJSON(path) {
  const headers = { 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` };
  const res = await fetch(API_BASE + path, { headers });
  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch(e) { data = text; }
  if (!res.ok) throw new Error((data && data.message) || `HTTP ${res.status}`);
  return data;
}

// tryPaths: attempts multiple endpoints until success
async function tryPaths(paths = [], opts = {}) {
  let lastErr = null;
  for (const p of paths) {
    try {
      const headers = { 'Content-Type':'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(API_BASE + p, { method: opts.method || 'POST', headers, body: opts.body });
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch(e){ data = text; }
      if (res.ok) return data ?? {};
      lastErr = new Error((data && data.message) || `HTTP ${res.status} (${p})`);
    } catch (err) {
      lastErr = err;
    }
  }
  throw lastErr || new Error('No path succeeded');
}

/* === Announcement === */
async function loadAnnouncement() {
  try {
    const res = await fetch(API_BASE + '/api/announcements/latest');
    if (!res.ok) return;
    const a = await res.json();
    if (a && a.isActive) {
      announceTitle.textContent = a.title || 'Announcement';
      announceMsg.textContent = a.message || '';
      announceBanner.classList.remove('hidden');
    }
  } catch (e) {
    console.info('announcement load failed', e.message);
  }
}

/* === Places Autocomplete === */
function initPlaces() {
  // Wait until google maps loaded
  if (!window.google || !google.maps || !google.maps.places) {
    setTimeout(initPlaces, 600);
    return;
  }
  try {
    const pickupAC = new google.maps.places.Autocomplete(pickupEl, { types:['address'] });
    const dropAC = new google.maps.places.Autocomplete(dropoffEl, { types:['address'] });
    // optionally bias to Nigeria:
    // pickupAC.setComponentRestrictions({ country: 'ng' });
    // dropAC.setComponentRestrictions({ country: 'ng' });
  } catch (e) {
    console.warn('Places init failed', e.message);
  }
}

/* === Price Calculation & Payment === */
// candidate endpoints
const calcCandidates = ['/api/orders/calc-price', '/api/orders/calculate-price', '/api/orders/estimate'];
const createCandidates = ['/api/orders', '/api/orders/submit', '/api/orders/create', '/api/orders/submit-for-confirmation'];

function buildItemsForCalc() {
  return [{ itemType: itemCategoryEl.value || 'parcel', weight: Number(weightEl.value || 0), quantity: 1 }];
}

async function onCalculatePrice() {
  calcFeedback.textContent = '';
  setBtnLoading(calcPriceBtn, true);
  lastCalc = null;
  try {
    const payload = { items: buildItemsForCalc(), serviceType: serviceEl.value, pickup: pickupEl.value, dropoff: dropoffEl.value };
    const res = await tryPaths(calcCandidates, { method:'POST', body: JSON.stringify(payload) });
    // backend returns finalPrice & maybe bankDetails
    lastCalc = res;
    showPriceModal(res);
  } catch (err) {
    console.error('calc error', err);
    calcFeedback.textContent = err.message || 'Could not calculate price';
    showToast(err.message || 'Calculation failed', 'error');
  } finally {
    setBtnLoading(calcPriceBtn, false);
  }
}

function showPriceModal(res) {
  const final = (res && (res.finalPrice || res.finalprice || res.final)) || 0;
  const html = document.createElement('div');
  html.innerHTML = `
    <h3 class="text-xl font-semibold mb-2">Final Price</h3>
    <div class="text-3xl font-bold mb-2">₦${Number(final).toLocaleString()}</div>
    <div class="text-sm text-gray-600 mb-4">Choose an account below and complete payment via your banking app. After payment click <strong>I have paid</strong>.</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
      <div class="p-3 rounded border"><div class="font-semibold">Moniepoint</div><div class="text-sm">Acct: 9128884830 • Nelson Emmanuel Godspower</div></div>
      <div class="p-3 rounded border"><div class="font-semibold">Opay</div><div class="text-sm">Acct: 9128884830 • Nelson Emmanuel Godspower</div></div>
      <div class="p-3 rounded border"><div class="font-semibold">Palmpay</div><div class="text-sm">Acct: 9128884830 • Nelson Emmanuel Godspower</div></div>
      <div class="p-3 rounded border"><div class="font-semibold">UBA</div><div class="text-sm">Acct: 234 2 835 397 • Nelson Emmanuel Godspower</div></div>
      <div class="p-3 rounded border"><div class="font-semibold">GTB</div><div class="text-sm">Acct: 0734090626 • Nelson Emmanuel Godspower</div></div>
    </div>
    <div class="flex gap-3">
      <button id="iPaid" class="btn-primary flex-1">I have paid</button>
      <button id="closePay" class="btn-ghost flex-1">Close</button>
    </div>
  `;
  openOverlay(html);
  document.getElementById('closePay').addEventListener('click', closeOverlay);
  document.getElementById('iPaid').addEventListener('click', onIHavePaid);
}

async function onProceedPayment() {
  // If not calculated yet, calculate first and then proceed
  if (!lastCalc) {
    await onCalculatePrice();
    return;
  }
  showPriceModal(lastCalc);
}

async function onIHavePaid() {
  const btn = document.getElementById('iPaid');
  setBtnLoading(btn, true);
  try {
    // Validate required fields
    if (!pickupEl.value || !dropoffEl.value) {
      showToast('Please specify pickup and dropoff addresses', 'error'); return;
    }
    const payload = {
      items: buildItemsForCalc(),
      pickupAddress: pickupEl.value,
      deliveryAddress: dropoffEl.value,
      paymentMethod: 'Bank Transfer',
      recipientName: recipientEl.value || '',
      recipientPhone: recipientPhoneEl.value || ''
    };
    const res = await tryPaths(createCandidates, { method:'POST', body: JSON.stringify(payload) });
    // parse returned order
    const order = res.order || res.data || res;
    activeOrder = order;
    localStorage.setItem('su_active_order', JSON.stringify(order));
    showToast('Order submitted! Awaiting admin verification.', 'success');
    closeOverlay();
    // open tracking
    const id = order._id || order.id || (order.order && (order.order._id || order.order.id));
    if (id) openTracking(id);
    await refreshHistory();
  } catch (err) {
    console.error('create order failed', err);
    showToast(err.message || 'Order submission failed', 'error');
  } finally {
    setBtnLoading(btn, false);
  }
}

/* === Tracking & Polling === */
function openTracking(orderId) {
  if (!orderId) return;
  trackingCard.classList.remove('hidden');
  orderIdEl.textContent = orderId;
  startPolling(orderId);
  initMap();
}
function startPolling(orderId) {
  if (pollInterval) clearInterval(pollInterval);
  pollInterval = setInterval(()=> pollOrder(orderId), 5000);
  pollOrder(orderId);
}
async function pollOrder(orderId) {
  try {
    const data = await getJSON(`/api/orders/${orderId}`);
    const order = data.order || data || {};
    activeOrder = order;
    localStorage.setItem('su_active_order', JSON.stringify(order));
    const status = order.status || 'Pending';
    orderStatusEl.textContent = status;
    renderTimeline(status, order);
    // agent details
    const agent = order.agentDetails || order.agentProfile || order.agent;
    if (agent && typeof agent === 'object') {
      agentNameEl.textContent = agent.name || 'Agent';
      agentPhoneLink.textContent = agent.phone || agent.contact || '';
      agentPhoneLink.href = `tel:${agent.phone || agent.contact || ''}`;
    } else {
      agentNameEl.textContent = order.agent || '—';
    }
    // handle agent location update (if backend populates)
    if (order.agentLocation && order.agentLocation.lat && order.agentLocation.lng) {
      updateAgentMarker(Number(order.agentLocation.lat), Number(order.agentLocation.lng));
    }
    // notify customer when agent assigned
    if (status === 'PaymentConfirmed' && (!trackingCard.classList.contains('show-confirmed'))) {
      showToast('Payment confirmed. Waiting for agent assignment.', 'info');
      trackingCard.classList.add('show-confirmed'); // once
    }
    if (status === 'Completed' || status === 'Delivered') {
      showToast('Order completed. Thank you!', 'success');
      if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
    }
  } catch (err) {
    console.info('poll order err', err.message);
  }
}
function renderTimeline(status, order) {
  const steps = [
    { key:'PendingPayment', label:'Pending Payment' },
    { key:'PaymentConfirmed', label:'Payment Confirmed' },
    { key:'EnRouteToPickup', label:'Agent en route to pickup' },
    { key:'EnRouteToDelivery', label:'Agent en route to delivery' },
    { key:'Completed', label:'Delivered / Completed' }
  ];
  timelineEl.innerHTML = steps.map(s => {
    const active = (s.key === status || (s.key==='Completed' && status==='Delivered'));
    return `<div class="py-1"><span class="${active ? 'font-bold text-green-600' : 'text-gray-600'}">${s.label}</span></div>`;
  }).join('');
}

/* === Map helpers === */
function initMap() {
  if (map) return;
  if (!window.google || !google.maps) {
    console.warn('Google maps not loaded');
    return;
  }
  map = new google.maps.Map(document.getElementById('map'), { center:{lat:6.5244,lng:3.3792}, zoom:12, disableDefaultUI:true });
}
function updateAgentMarker(lat, lng) {
  if (!map) initMap();
  const pos = { lat, lng };
  if (!agentMarker) {
    agentMarker = new google.maps.Marker({ position: pos, map, title:'Agent location' });
    map.setCenter(pos);
  } else agentMarker.setPosition(pos);
}

/* === Hamburger menu overlays === */
function openMenu() {
  const node = document.createElement('div');
  node.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <img src="${document.getElementById('siteLogo').src}" class="w-14 h-14 rounded-full" />
        <div>
          <div class="font-semibold">${escapeHtml(suUser.name || 'User')}</div>
          <div class="text-sm text-gray-500">${escapeHtml(suUser.email || '')}</div>
        </div>
      </div>
      <div><button id="closeMenu" class="btn-ghost">Close</button></div>
    </div>
    <div class="grid gap-2">
      <button id="menuHistory" class="btn-ghost w-full text-left">Order History</button>
      <button id="menuReferral" class="btn-ghost w-full text-left">Refer & Earn</button>
      <button id="menuProfile" class="btn-ghost w-full text-left">My Profile</button>
      <button id="menuAnnouncements" class="btn-ghost w-full text-left">Announcements</button>
      <button id="menuRate" class="btn-ghost w-full text-left">Rate Delivered Order</button>
      <button id="menuReport" class="btn-ghost w-full text-left">Report an Issue</button>
      <button id="menuSettings" class="btn-ghost w-full text-left">Settings</button>
      <button id="menuLogout" class="btn-ghost w-full text-left text-red-600">Logout</button>
    </div>
  `;
  openOverlay(node);
  document.getElementById('closeMenu').onclick = closeOverlay;
  document.getElementById('menuHistory').onclick = openHistoryOverlay;
  document.getElementById('menuReferral').onclick = openReferralOverlay;
  document.getElementById('menuProfile').onclick = openProfileOverlay;
  document.getElementById('menuAnnouncements').onclick = openAnnouncementsOverlay;
  document.getElementById('menuRate').onclick = openRateOverlay;
  document.getElementById('menuReport').onclick = openReportOverlay;
  document.getElementById('menuSettings').onclick = openSettingsOverlay;
  document.getElementById('menuLogout').onclick = () => { localStorage.removeItem('su_token'); localStorage.removeItem('su_user'); location.href = 'index.html'; };
}

/* Order history overlay */
async function openHistoryOverlay() {
  openOverlay('<div>Loading order history...</div>');
  try {
    const data = await getJSON(`/api/orders?customerId=${suUser.id || suUser._id || ''}`);
    const list = Array.isArray(data) ? data : (data.orders || data.data || []);
    const container = document.createElement('div');
    container.innerHTML = `<h3 class="text-xl font-semibold mb-2">Order History</h3>`;
    if (!list || list.length === 0) container.innerHTML += `<div class="text-sm">No orders yet.</div>`;
    else {
      container.innerHTML += list.map(o => {
        const id = o._id || o.id || '';
        const status = o.status || 'Unknown';
        const created = new Date(o.createdAt || o.created || Date.now()).toLocaleString();
        return `<div class="p-3 border rounded mb-2">
          <div class="font-medium">Order ${escapeHtml(String(id))}</div>
          <div class="text-sm text-gray-500">Status: ${escapeHtml(status)} • ${escapeHtml(created)}</div>
          <div class="text-sm mt-2">Pickup: ${escapeHtml(o.pickupAddress || '')}</div>
          <div class="text-sm">Drop: ${escapeHtml(o.deliveryAddress || '')}</div>
          <div class="mt-2"><button data-id="${id}" class="btn-primary viewOrder">View & Track</button></div>
        </div>`;
      }).join('');
    }
    overlayContent.innerHTML = '';
    overlayContent.appendChild(container);
    overlay.querySelectorAll('.viewOrder').forEach(btn => btn.addEventListener('click', (e) => {
      const id = e.currentTarget.dataset.id;
      closeOverlay();
      openTracking(id);
    }));
  } catch (err) {
    overlayContent.innerHTML = `<div class="text-sm text-red-600">Failed to load history: ${err.message}</div>`;
  }
}

/* Referral overlay */
function openReferralOverlay() {
  const code = suUser.referralCode || (suUser._id ? 'REF' + String(suUser._id).slice(-6) : 'REF-UNKNOWN');
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Refer & Earn</h3>
    <div class="p-3 border rounded mb-3"><div class="font-medium">Your referral code</div><div class="font-mono mt-2 text-lg">${escapeHtml(code)}</div>
    <div class="text-sm mt-2">Link: <a href="${location.origin}/signup?ref=${encodeURIComponent(code)}">${location.origin}/signup?ref=${encodeURIComponent(code)}</a></div>
    <div class="mt-3 flex gap-2"><button id="copyRef" class="btn-primary">Copy</button><button id="shareRef" class="btn-ghost">Share</button></div></div>`;
  openOverlay(node);
  document.getElementById('copyRef').onclick = async () => {
    try { await navigator.clipboard.writeText(`${location.origin}/signup?ref=${code}`); showToast('Referral link copied', 'success'); } catch(e){ showToast('Copy failed', 'error'); }
  };
  document.getElementById('shareRef').onclick = async () => {
    const link = `${location.origin}/signup?ref=${code}`;
    try { if (navigator.share) await navigator.share({ title:'Join SkyUltimate', text:'Use my referral link', url: link }); else { await navigator.clipboard.writeText(link); showToast('Link copied', 'success'); } } catch(e){ showToast('Share failed', 'error'); }
  };
}

/* Profile overlay (edit) */
function openProfileOverlay() {
  const node = document.createElement('div');
  node.innerHTML = `
    <h3 class="text-xl font-semibold mb-2">My Profile</h3>
    <label class="text-xs">Full name</label><input id="pf_name" class="w-full p-3 rounded mt-1" value="${escapeHtml(suUser.name||'')}" />
    <label class="text-xs mt-2">Email</label><input class="w-full p-3 rounded mt-1" value="${escapeHtml(suUser.email||'')}" readonly />
    <label class="text-xs mt-2">Phone</label><input id="pf_phone" class="w-full p-3 rounded mt-1" value="${escapeHtml(suUser.phone||'')}" />
    <div class="flex gap-2 mt-3"><button id="saveProfile" class="btn-primary flex-1">Save Changes</button><button id="closeProfile" class="btn-ghost flex-1">Close</button></div>
    <div id="pf_msg" class="text-sm text-green-600 mt-2"></div>
  `;
  openOverlay(node);
  document.getElementById('closeProfile').onclick = closeOverlay;
  document.getElementById('saveProfile').onclick = async () => {
    const phone = document.getElementById('pf_phone').value.trim();
    const name = document.getElementById('pf_name').value.trim();
    const payload = { name, phone };
    // Try several possible profile endpoints
    try {
      await tryPaths(['/api/user/profile','/api/users/profile','/api/users/me','/api/users/me/profile'], { method:'PUT', body: JSON.stringify(payload) });
      // Update local copy
      suUser.name = name || suUser.name;
      suUser.phone = phone || suUser.phone;
      localStorage.setItem('su_user', JSON.stringify(suUser));
      document.getElementById('pf_msg').textContent = 'Profile updated';
      showToast('Profile updated', 'success');
      setTimeout(closeOverlay, 900);
    } catch (err) {
      document.getElementById('pf_msg').textContent = err.message || 'Update failed';
      showToast(err.message || 'Profile update failed', 'error');
    }
  };
}

/* Announcements overlay */
function openAnnouncementsOverlay() {
  const html = `<h3 class="text-xl font-semibold mb-2">Announcements</h3><div class="text-sm">${escapeHtml(announceTitle.textContent || 'No announcement')}</div><div class="mt-2 text-sm">${escapeHtml(announceMsg.textContent || '')}</div><div class="mt-4"><button id="closeAnn" class="btn-ghost">Close</button></div>`;
  openOverlay(html);
  document.getElementById('closeAnn').onclick = closeOverlay;
}

/* Rate overlay - find delivered orders and allow rating */
async function openRateOverlay() {
  openOverlay('<div>Loading delivered orders...</div>');
  try {
    const res = await getJSON(`/api/orders?customerId=${suUser.id || suUser._id || ''}`);
    const list = Array.isArray(res) ? res : (res.orders || res.data || []);
    const delivered = list.filter(o => (o.status === 'Completed' || o.status === 'Delivered'));
    const node = document.createElement('div');
    node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Rate Delivered Orders</h3>`;
    if (!delivered.length) node.innerHTML += `<div class="text-sm">No delivered orders to rate.</div>`;
    else node.innerHTML += delivered.map(o => `<div class="p-3 border rounded mb-2"><div class="font-medium">Order ${escapeHtml(o._id||o.id||'')}</div><div class="text-sm">${escapeHtml(o.pickupAddress||'')} → ${escapeHtml(o.deliveryAddress||'')}</div><div class="mt-2"><button data-id="${o._id||o.id}" class="btn-primary doRate">Rate</button></div></div>`).join('');
    overlayContent.innerHTML = ''; overlayContent.appendChild(node);
    overlay.querySelectorAll('.doRate').forEach(b => b.addEventListener('click', (e) => openSingleRate(e.currentTarget.dataset.id)));
  } catch (err) {
    overlayContent.innerHTML = `<div class="text-sm text-red-600">Failed: ${err.message}</div>`;
  }
}
function openSingleRate(orderId) {
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Rate Order ${escapeHtml(orderId)}</h3><div id="stars" class="text-2xl mb-3">★★★★★</div><textarea id="rateComment" class="w-full p-3 rounded" placeholder="Comment (optional)"></textarea><div class="flex gap-2 mt-3"><button id="submitRate" class="btn-primary">Submit</button><button id="closeRate" class="btn-ghost">Close</button></div>`;
  openOverlay(node);
  let rating = 5;
  document.getElementById('stars').addEventListener('click', (ev) => {
    const w = ev.currentTarget.clientWidth;
    const idx = Math.ceil((ev.offsetX / w) * 5);
    rating = Math.max(1, Math.min(5, idx));
    ev.currentTarget.textContent = '★★★★★'.slice(0, rating) + '☆☆☆☆☆'.slice(rating);
  });
  document.getElementById('submitRate').addEventListener('click', async () => {
    const comment = document.getElementById('rateComment').value || '';
    try {
      await fetch(API_BASE + `/api/orders/${orderId}/rate`, { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${token}` }, body: JSON.stringify({ rating, comment }) });
      showToast('Thanks for rating!', 'success');
      closeOverlay();
    } catch (e) { showToast(e.message || 'Rating failed', 'error'); }
  });
  document.getElementById('closeRate').addEventListener('click', closeOverlay);
}

/* Report overlay */
function openReportOverlay() {
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Report an Issue</h3><label class="text-xs">Order ID (optional)</label><input id="rOrder" class="w-full p-3 rounded mt-1" /><label class="text-xs mt-2">Message</label><textarea id="rMsg" class="w-full p-3 rounded mt-1"></textarea><div class="flex gap-2 mt-3"><button id="sendReport" class="btn-primary">Send Report</button><button id="closeR" class="btn-ghost">Close</button></div><div id="reportMsg" class="text-sm mt-2"></div>`;
  openOverlay(node);
  document.getElementById('closeR').onclick = closeOverlay;
  document.getElementById('sendReport').onclick = async () => {
    const orderId = document.getElementById('rOrder').value.trim();
    const message = document.getElementById('rMsg').value.trim();
    if (!message) { showToast('Please provide details', 'error'); return; }
    try {
      await fetch(API_BASE + '/api/admin-requests', { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${token}` }, body: JSON.stringify({ orderId: orderId || null, message }) });
      showToast('Report sent to admin', 'success');
      closeOverlay();
    } catch (err) {
      document.getElementById('reportMsg').textContent = err.message || 'Failed to send';
      showToast(err.message || 'Failed', 'error');
    }
  };
}

/* Settings overlay */
function openSettingsOverlay() {
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Settings</h3>
    <div class="flex items-center justify-between"><div><div class="font-medium">Theme</div><div class="text-sm text-gray-500">Toggle dark mode</div></div>
    <label class="inline-flex items-center"><input id="themeToggle" type="checkbox" class="mr-2" />Dark</label></div>
    <div class="flex gap-2 mt-4"><button id="closeS" class="btn-ghost">Close</button><button id="logoutBtn" class="btn-ghost text-red-600">Logout</button></div>`;
  openOverlay(node);
  const t = document.getElementById('themeToggle');
  t.checked = localStorage.getItem('su_theme') === 'dark';
  t.addEventListener('change', (e) => { applyTheme(e.target.checked ? 'dark' : 'light'); localStorage.setItem('su_theme', e.target.checked ? 'dark' : 'light'); });
  document.getElementById('closeS').onclick = closeOverlay;
  document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('su_token'); localStorage.removeItem('su_user'); location.href='index.html'; };
}

/* === Utility functions === */
function escapeHtml(s) { return String(s || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

async function refreshHistory() {
  try { await getJSON(`/api/orders?customerId=${suUser.id || suUser._id}`); } catch(e){}
}

/* === Theme apply === */
function applyTheme(theme) {
  if (theme === 'dark' || theme === 'dark') document.documentElement.classList.add('dark');
  else document.documentElement.classList.remove('dark');
}

/* === Guidance for Google Maps error ===
 If you see "This page can't load Google Maps correctly. Do you own this website?" it's a Google Maps API key/billing issue:
 - Ensure Maps JavaScript API + Places API are enabled in Google Cloud
 - Ensure billing is enabled on the project
 - Ensure the key's HTTP referrer restrictions include your domain (or remove restrictions during dev)
*/

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SkyUltimate — Customer Dashboard</title>

  <!-- Tailwind CDN for utilities -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Maps/Places (your key - ensure billing & referrers are OK) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDu1dptqgTwWWD6568jhf_tal7uYfdyMlQ&libraries=places" async defer></script>

  <style>
    :root{
      --brand-red: #C00000;
      --brand-red-dark: #900000;
      --glass: rgba(255,255,255,0.96);
      --card-radius: 22px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{background: linear-gradient(180deg,#fff6f6 0%, #fff 100%); color:#0f172a; -webkit-font-smoothing:antialiased;}
    /* topbar */
    header.topbar{backdrop-filter: blur(6px); background: linear-gradient(90deg, rgba(255,255,255,0.7), rgba(255,255,255,0.55)); box-shadow: 0 8px 30px rgba(0,0,0,0.06); position:sticky; top:0; z-index:30;}
    .logo-round{width:72px;height:72px;border-radius:9999px;object-fit:cover;box-shadow:0 10px 36px rgba(0,0,0,0.12)}
    .card{background:var(--glass); border-radius:var(--card-radius); padding:20px; box-shadow: 0 10px 40px rgba(2,6,23,0.06);}
    .btn-primary{background:linear-gradient(180deg,var(--brand-red),var(--brand-red-dark)); color:#fff; padding:12px 16px; border-radius:14px; font-weight:700; box-shadow:0 10px 30px rgba(192,0,0,0.18); border:none}
    .btn-ghost{background:#fff;border:1px solid #eee;padding:10px 12px;border-radius:12px}
    .chip{display:inline-block;padding:6px 12px;border-radius:999px;background:#fff;border:1px solid #eee;font-weight:700}
    .map{height:320px;border-radius:14px;overflow:hidden;border:1px solid #e6eef6}
    /* overlays */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:80}
    .overlay.show{display:flex}
    .overlay-backdrop{position:absolute;inset:0;background:rgba(3,7,18,0.6)}
    .overlay-panel{position:relative;z-index:82;width:100%;max-width:1100px;margin:18px;max-height:92vh;overflow:auto;border-radius:18px;padding:20px;background:var(--glass)}
    .no-scroll, html.no-scroll, body.no-scroll{overflow:hidden;height:100%}
    /* toast */
    .toast{position:fixed;right:18px;bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;display:none;z-index:100}
    .toast.show{display:block}
    /* dark theme */
    .dark body{background:#071026;color:#e6eef8}
    .dark .card{background: rgba(8,12,20,0.72); box-shadow:none}
    .dark .overlay-panel{background: rgba(6,10,20,0.85)}
    .dark .btn-ghost{background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.06); color: #e6eef8}
    .dark .chip{background: rgba(255,255,255,0.03); color:#e6eef8; border-color: rgba(255,255,255,0.04)}
    /* responsive tweaks */
    @media (max-width:640px){
      .logo-round{width:56px;height:56px}
      .map{height:220px}
      .overlay-panel{margin:0;border-radius:0;height:100vh;max-width:100%}
    }
  </style>
</head>
<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="hamburgerBtn" class="p-2 rounded-md hover:bg-white/30" aria-label="Menu">
          <svg width="22" height="14" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="#111827" stroke-width="1.6" stroke-linecap="round"/></svg>
        </button>

        <!-- logo only — no text beside it -->
        <img id="logoImg" class="logo-round" src="https://github.com/Nelson192006/SkyUltimate-/blob/62343ff3e5e556aa02ecece40e2c006fa9161c0a/logo.png?raw=true" alt="SkyUltimate">
      </div>

      <!-- welcome first name only -->
      <div class="flex items-center gap-4">
        <div id="welcomeFirst" class="text-lg font-semibold">Welcome!</div>
        <button id="settingsBtn" title="Settings" class="p-2 rounded-md hover:bg-white/30">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 15.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7zM19.4 12.7l1.1-2.1-2.3-4-2.4.6a8.4 8.4 0 00-1.6-.9l-.4-2.4h-4.4l-.4 2.4c-.5.2-1 .5-1.5.9l-2.4-.6-2.3 4 1.1 2.1c-.1.6-.1 1.3 0 1.9l-1.1 2.1 2.3 4 2.4-.6c.5.4 1 .7 1.5.9l.4 2.4h4.4l.4-2.4c.6-.2 1.1-.5 1.6-.9l2.4.6 2.3-4-1.1-2.1c.1-.6.1-1.3 0-1.9z" stroke="#111827" stroke-width="0.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- announcement banner -->
    <div id="announceBanner" class="card mb-6 hidden">
      <div id="announceTitle" class="text-lg font-semibold text-red-700"></div>
      <div id="announceMsg" class="text-sm text-gray-700 mt-1"></div>
    </div>

    <!-- hero + placement -->
    <section class="card mb-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h1 id="greetingLarge" class="text-2xl font-bold">Hello!</h1>
          <p id="greetingSub" class="text-sm text-gray-600 mt-1">Place a new delivery order — quick, secure and trackable.</p>
        </div>
        <div class="text-right">
          <div class="text-xs text-gray-500">Role</div>
          <div id="roleBadge" class="chip mt-2">Customer</div>
        </div>
      </div>

      <hr class="my-4" />

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-xs text-gray-600">Pickup — Full recipient address</label>
          <input id="pickup" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="e.g. 12B Allen Ave, Ikeja" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Drop-off — Recipient delivery address</label>
          <input id="dropoff" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="Recipient address" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Recipient full name</label>
          <input id="recipientName" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="Recipient name" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Recipient phone</label>
          <input id="recipientPhone" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="+234 9xxxxxxxxx" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Item category</label>
          <select id="itemType" class="w-full mt-1 p-3 rounded-lg border border-gray-100">
            <option value="documents">Documents</option>
            <option value="food">Food</option>
            <option value="groceries">Groceries</option>
            <option value="parcel">Parcel</option>
            <option value="others">Other</option>
          </select>
        </div>

        <div>
          <label class="text-xs text-gray-600">Weight (kg)</label>
          <input id="weight" type="number" min="0" class="w-full mt-1 p-3 rounded-lg border border-gray-100" placeholder="e.g. 2" />
        </div>

        <div>
          <label class="text-xs text-gray-600">Service type</label>
          <select id="service" class="w-full mt-1 p-3 rounded-lg border border-gray-100">
            <option value="standard">Standard</option>
            <option value="express">Express</option>
            <option value="same-day">Same-day</option>
          </select>
        </div>

        <div class="md:col-span-2 flex gap-3 mt-2">
          <button id="calcPriceBtn" class="btn-primary flex-1">Calculate Final Price</button>
          <button id="proceedPaymentBtn" class="btn-ghost flex-1">Proceed with Payment</button>
        </div>

        <div id="calcError" class="md:col-span-2 text-sm text-red-600 mt-2"></div>
      </div>
    </section>

    <!-- tracking card (hidden until active order) -->
    <section id="tracking" class="card mb-6 hidden">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-semibold">Order Tracking</h3>
          <div class="text-xs text-gray-500 mt-1">Order ID: <span id="orderIdDisplay">—</span></div>
        </div>
        <div><span id="orderStatusBadge" class="chip">Pending</span></div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <div id="map" class="map"></div>
          <div class="text-xs text-gray-500 mt-2">Agent: <span id="agentName">—</span> • <a id="agentPhone" href="#" class="underline">—</a></div>
        </div>

        <div>
          <h4 class="font-semibold">Journey</h4>
          <div id="timeline" class="mt-3 text-sm text-gray-700"></div>

          <div class="mt-6 flex gap-3">
            <button id="contactAgentBtn" class="btn-ghost">Contact Agent</button>
            <button id="reportAgentBtn" class="btn-primary">Report Agent</button>
          </div>

          <div class="mt-4">
            <div class="text-sm text-gray-500">Confirm actions (only enabled when agent is within 50m of the pickup/drop-off):</div>
            <div class="mt-2 flex gap-3">
              <button id="confirmPickupBtn" class="btn-ghost" disabled>Confirm Item Picked Up</button>
              <button id="confirmDeliveredBtn" class="btn-ghost" disabled>Confirm Order Delivered</button>
            </div>
          </div>

        </div>
      </div>
    </section>

    <footer class="text-center text-sm text-gray-500">
      Contact: <a id="phoneLink" href="tel:+2349128884830" class="underline">+234 912 888 4830</a>
      · <a id="whatsappLink" href="https://wa.me/2349128884830" target="_blank" class="underline">WhatsApp</a>
      · <a id="emailLink" href="mailto:nelsongodspower24@gmail.com" class="underline">Email</a>
    </footer>
  </main>

  <!-- Full-screen overlay panel (used for menu items) -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="overlay-backdrop" id="overlayBackdrop"></div>
    <div class="overlay-panel" id="overlayPanel" role="dialog" aria-modal="true"></div>
  </div>

  <!-- toast -->
  <div id="toast" class="toast"></div>

<script>
/* -----------------------
  Full Customer Dashboard (single file)
  - All actions wired to API_BASE
  - Robust tryPaths fallback for common endpoints
  - Places autocomplete for pickup/dropoff
  - All menu items open overlay panels that cover the whole screen
  - Payment overlay shows bank accounts and "I have paid" → creates order + submits for confirmation
  - Real-time WebSocket client with fallback polling
  - Confirm Pickup / Confirm Delivered buttons (50m proximity gating)
------------------------ */

const API_BASE = "https://skyultimate-backend-api-structure.onrender.com";
const WS_PATH = "/ws"; // adjust if your WS path differs
const token = localStorage.getItem('su_token');
const su_user = JSON.parse(localStorage.getItem('su_user') || 'null');
if (!token || !su_user) {
  // Not signed in -> redirect to login
  window.location.href = 'index.html';
}

/* DOM refs */
const welcomeFirst = document.getElementById('welcomeFirst');
const greetingLarge = document.getElementById('greetingLarge');
const roleBadge = document.getElementById('roleBadge');

const pickup = document.getElementById('pickup');
const dropoff = document.getElementById('dropoff');
const recipientName = document.getElementById('recipientName');
const recipientPhone = document.getElementById('recipientPhone');
const itemType = document.getElementById('itemType');
const weight = document.getElementById('weight');
const service = document.getElementById('service');

const calcPriceBtn = document.getElementById('calcPriceBtn');
const proceedPaymentBtn = document.getElementById('proceedPaymentBtn');
const calcError = document.getElementById('calcError');

const announceBanner = document.getElementById('announceBanner');
const announceTitle = document.getElementById('announceTitle');
const announceMsg = document.getElementById('announceMsg');

const overlay = document.getElementById('overlay');
const overlayPanel = document.getElementById('overlayPanel');
const overlayBackdrop = document.getElementById('overlayBackdrop');
const toast = document.getElementById('toast');

const hamburgerBtn = document.getElementById('hamburgerBtn');
const settingsBtn = document.getElementById('settingsBtn');

const trackingSection = document.getElementById('tracking');
const orderIdDisplay = document.getElementById('orderIdDisplay');
const orderStatusBadge = document.getElementById('orderStatusBadge');
const timeline = document.getElementById('timeline');
const agentName = document.getElementById('agentName');
const agentPhone = document.getElementById('agentPhone');
const contactAgentBtn = document.getElementById('contactAgentBtn');
const reportAgentBtn = document.getElementById('reportAgentBtn');

const mapEl = document.getElementById('map');

const confirmPickupBtn = document.getElementById('confirmPickupBtn');
const confirmDeliveredBtn = document.getElementById('confirmDeliveredBtn');

/* local state */
let lastCalc = null;
let currentOrder = null;
let pollTimer = null;
let map, agentMarker, pickupMarker, dropoffMarker;
let ws = null;

/* Small helpers */
function showToast(msg, time=3000){
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> toast.classList.remove('show'), time);
}
function setButtonLoading(btn, on=true){ if (!btn) return; if (on){ btn.dataset._text = btn.innerHTML; btn.disabled = true; btn.innerHTML = 'Please wait...'; } else { btn.disabled = false; if (btn.dataset._text) btn.innerHTML = btn.dataset._text; } }
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* API helpers */
async function tryPaths(paths, opts = {}) {
  let lastErr = null;
  for (const p of paths) {
    try {
      const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
      if (token) headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(API_BASE + p, { method: opts.method || 'POST', headers, body: opts.body });
      const text = await res.text();
      let data;
      try { data = text ? JSON.parse(text) : null; } catch(e){ data = text; }
      if (res.ok) return data ?? {};
      lastErr = new Error((data && data.message) || `HTTP ${res.status} (${p})`);
      console.warn('tryPaths: failed', p, res.status, data);
    } catch (err) {
      lastErr = err;
      console.warn('tryPaths error', err);
    }
  }
  throw lastErr || new Error('No path succeeded');
}

async function getJSON(path) {
  const headers = { 'Content-Type': 'application/json' };
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(API_BASE + path, { headers });
  const text = await res.text();
  let data;
  try { data = text ? JSON.parse(text) : null; } catch(e){ data = text; }
  if (!res.ok) throw new Error((data && data.message) || `HTTP ${res.status}`);
  return data;
}

/* ====== Announcement ====== */
async function loadAnnouncement(){
  try {
    const res = await fetch(API_BASE + '/api/announcements/latest');
    if (!res.ok) return;
    const a = await res.json();
    if (a && a.isActive) {
      announceTitle.textContent = a.title || 'Announcement';
      announceMsg.textContent = a.message || '';
      announceBanner.classList.remove('hidden');
    }
  } catch(e) { console.info('announcement load failed', e.message); }
}

/* ====== Google Places Autocomplete ====== */
function initPlaces(){
  if (!window.google || !google.maps || !google.maps.places) {
    // retry few times
    setTimeout(initPlaces, 700);
    return;
  }
  try {
    const options = { types: ['address'] };
    new google.maps.places.Autocomplete(pickup, options);
    new google.maps.places.Autocomplete(dropoff, options);
  } catch (e) {
    console.warn('Places init failed', e);
  }
}

/* ====== Price calculation & Payment flow ====== */
const pricePaths = ['/api/orders/calc-price', '/api/orders/calculate-price', '/api/orders/estimate'];
const createOrderPaths = ['/api/orders', '/api/orders/submit', '/api/orders/create'];

function buildItems(){
  return [{ itemType: itemType.value || 'parcel', weight: Number(weight.value || 0), quantity: 1 }];
}

async function onCalculatePrice(){
  calcError.textContent = '';
  lastCalc = null;
  setButtonLoading(calcPriceBtn, true);
  try {
    const payload = { items: buildItems(), serviceType: service.value, pickup: pickup.value, dropoff: dropoff.value };
    const res = await tryPaths(pricePaths, { method: 'POST', body: JSON.stringify(payload) });
    lastCalc = res;
    showPriceOverlay(res);
  } catch (err) {
    console.error('calcPrice failed', err);
    calcError.textContent = err.message || 'Failed to calculate price';
    showToast(err.message || 'Calculation failed');
  } finally {
    setButtonLoading(calcPriceBtn, false);
  }
}

function showPriceOverlay(res){
  const final = res.finalPrice ?? res.finalprice ?? res.finalAmount ?? 0;
  // Use the accounts you provided (hardcoded)
  const accounts = [
    { bank:'Moniepoint', acct:'9128884830', name:'Nelson Emmanuel Godspower' },
    { bank:'Opay', acct:'9128884830', name:'Nelson Emmanuel Godspower' },
    { bank:'Palmpay', acct:'9128884830', name:'Nelson Emmanuel Godspower' },
    { bank:'UBA', acct:'2342835397', name:'Nelson Emmanuel Godspower' },
    { bank:'GTB', acct:'0734090626', name:'Nelson Emmanuel Godspower' }
  ];
  const div = document.createElement('div');
  div.innerHTML = `
    <h3 class="text-2xl font-semibold mb-2">Final Price</h3>
    <div class="text-3xl font-bold mb-2">₦${Number(final).toLocaleString()}</div>
    <div class="text-sm text-gray-600 mb-4">Choose an account below to pay. After payment, click <strong>I have paid</strong>.</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
      ${accounts.map(a => `<div class="p-3 rounded border">
        <div class="font-semibold">${a.bank}</div>
        <div class="text-sm">Acct: ${a.acct}</div>
        <div class="text-sm">${a.name}</div>
      </div>`).join('')}
    </div>
    <div class="flex gap-3"><button id="iPaidBtn" class="btn-primary flex-1">I have paid</button><button id="closePayBtn" class="btn-ghost flex-1">Close</button></div>
  `;
  openOverlay(div);
  document.getElementById('closePayBtn').onclick = closeOverlay;
  document.getElementById('iPaidBtn').onclick = onIHavePaid;
}

// Proceed with payment — if no calc yet, compute first; otherwise show overlay
async function onProceedPayment(){
  if (!lastCalc) {
    await onCalculatePrice();
    return;
  }
  showPriceOverlay(lastCalc);
}

// Create order after user confirms they paid
async function onIHavePaid(){
  const btn = document.getElementById('iPaidBtn');
  setButtonLoading(btn, true);
  try {
    if (!pickup.value || !dropoff.value) { showToast('Please fill pickup and dropoff addresses'); return; }
    const payload = {
      items: buildItems(),
      pickupAddress: { line: pickup.value },
      deliveryAddress: { line: dropoff.value },
      paymentMethod: 'Bank Transfer',
      recipientName: recipientName.value || '',
      recipientPhone: recipientPhone.value || ''
    };
    const res = await tryPaths(createOrderPaths, { method:'POST', body: JSON.stringify(payload) });
    const order = res.order || res;
    currentOrder = order;
    localStorage.setItem('su_active_order', JSON.stringify(order));
    showToast('Order created. Awaiting payment confirmation.');

    // Try to notify server customer->admin that payment pending confirmation.
    // We attempt the canonical path '/api/orders/:id/submit-for-confirmation' and sensible fallbacks.
    (async ()=>{
      const id = order._id || order.id || (order._doc && order._doc._id);
      if (!id) return;
      try {
                await tryPaths([`/api/orders/${id}/submit-for-confirmation`, `/api/orders/${id}/submit-payment`, `/api/orders/${id}/payment`], { method:'POST', body: JSON.stringify({ note:'Customer marked as paid' }) });
        console.info('Payment notification sent for order', id);
      } catch(e) {
        console.warn('Payment notification endpoints missing or failed', e);
      }
    })();

    closeOverlay();
    openTracking(order._id || order.id || (order._doc && order._doc._id) || '');
    await refreshHistory(); // best-effort
  } catch (err) {
    console.error('create order failed', err);
    showToast(err.message || 'Order creation failed');
  } finally {
    setButtonLoading(btn, false);
  }
}

/* ====== Tracking (polling + map + websockets) ====== */
function openTracking(orderId){
  if (!orderId) return;
  trackingSection.classList.remove('hidden');
  orderIdDisplay.textContent = orderId;
  startPolling(orderId);
  initMap();
  connectWS(); // ensure ws is attempted
}

function startPolling(orderId){
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(()=> pollOrder(orderId), 5000);
  pollOrder(orderId);
}

async function pollOrder(orderId){
  try {
    const data = await getJSON(`/api/orders/${orderId}`);
    const order = data.order || data;
    currentOrder = order;
    const status = order.status || 'Pending';
    orderStatusBadge.textContent = status;
    renderTimeline(status, order);

    // agent info may be nested in different shapes
    const agent = order.agentDetails || order.agentProfile || order.agent;
    if (agent && typeof agent === 'object') {
      agentName.textContent = agent.name || 'Agent';
      agentPhone.textContent = agent.phone || agent.contact || '';
      agentPhone.href = `tel:${agent.phone || agent.contact || ''}`;
    } else {
      agentName.textContent = order.agent || '—';
    }

    // agentLocation fields if provided
    if (order.agentLocation && order.agentLocation.lat && order.agentLocation.lng) {
      updateAgentMarker(Number(order.agentLocation.lat), Number(order.agentLocation.lng));
    }

    // set pickup / drop markers if backend returned them
    if (order.pickupAddress && order.pickupAddress.lat && order.pickupAddress.lng) {
      setPickupMarker(Number(order.pickupAddress.lat), Number(order.pickupAddress.lng));
    }
    if (order.deliveryAddress && order.deliveryAddress.lat && order.deliveryAddress.lng) {
      setDropoffMarker(Number(order.deliveryAddress.lat), Number(order.deliveryAddress.lng));
    }

    // evaluate proximity gating
    evaluateProximity();

    if (status === 'Completed' || status === 'Delivered') {
      showToast('Order delivered');
      clearInterval(pollTimer); pollTimer = null;
    }
  } catch (err) {
    console.info('poll error', (err && err.message) || err);
  }
}

function renderTimeline(status, order){
  const steps = [
    { key:'PendingPayment', label:'Pending Payment' },
    { key:'PaymentConfirmed', label:'Payment Confirmed' },
    { key:'EnRouteToPickup', label:'Agent en route to pickup' },
    { key:'EnRouteToDelivery', label:'Agent en route to delivery' },
    { key:'Completed', label:'Delivered / Completed' },
  ];
  timeline.innerHTML = steps.map(s=>{
    const active = (s.key === status || (s.key === 'Completed' && status === 'Delivered'));
    return `<div class="py-1"><span class="${active ? 'text-green-600 font-bold' : 'text-gray-600'}">${s.label}</span></div>`;
  }).join('');
}

/* Map init/update */
function initMap(){
  if (map) return;
  if (!window.google || !google.maps) {
    console.warn('Google maps not ready');
    return;
  }
  map = new google.maps.Map(mapEl, { center:{lat:6.5244,lng:3.3792}, zoom:12, disableDefaultUI:true });
}
function updateAgentMarker(lat,lng){
  if (!map) initMap();
  const pos = { lat, lng };
  if (!agentMarker) {
    agentMarker = new google.maps.Marker({ position: pos, map, title:'Agent', zIndex: 999, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: '#00aaff', fillOpacity: 1, strokeWeight: 1 } });
    map.setCenter(pos);
  } else agentMarker.setPosition(pos);
}
function setPickupMarker(lat,lng){
  if (!map) initMap();
  const pos = { lat, lng };
  if (!pickupMarker) { pickupMarker = new google.maps.Marker({ position: pos, map, title:'Pickup', label:'P' }); } else pickupMarker.setPosition(pos);
}
function setDropoffMarker(lat,lng){
  if (!map) initMap();
  const pos = { lat, lng };
  if (!dropoffMarker) { dropoffMarker = new google.maps.Marker({ position: pos, map, title:'Dropoff', label:'D' }); } else dropoffMarker.setPosition(pos);
}

/* Haversine distance (meters) */
function toRad(d){ return d * Math.PI / 180; }
function haversine(lat1,lon1,lat2,lon2){
  if ([lat1,lon1,lat2,lon2].some(v => v==null || Number.isNaN(Number(v)))) return Infinity;
  const R=6371000; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* Evaluate proximity gating for confirm buttons */
function evaluateProximity(){
  confirmPickupBtn.disabled = true;
  confirmDeliveredBtn.disabled = true;
  if (!currentOrder) return;
  // prefer agentLocation from currentOrder.agentLocation OR try agent nested object
  let aLat = null, aLng = null;
  if (currentOrder.agentLocation && currentOrder.agentLocation.lat && currentOrder.agentLocation.lng) {
    aLat = Number(currentOrder.agentLocation.lat); aLng = Number(currentOrder.agentLocation.lng);
  } else if (currentOrder.agent && currentOrder.agent.lat && currentOrder.agent.lng) {
    aLat = Number(currentOrder.agent.lat); aLng = Number(currentOrder.agent.lng);
  }
  if (aLat==null) return;
  // pickup coords
  let pLat = null, pLng = null;
  if (currentOrder.pickupAddress && currentOrder.pickupAddress.lat && currentOrder.pickupAddress.lng) {
    pLat = Number(currentOrder.pickupAddress.lat); pLng = Number(currentOrder.pickupAddress.lng);
  }
  // dropoff coords
  let dLat = null, dLng = null;
  if (currentOrder.deliveryAddress && currentOrder.deliveryAddress.lat && currentOrder.deliveryAddress.lng) {
    dLat = Number(currentOrder.deliveryAddress.lat); dLng = Number(currentOrder.deliveryAddress.lng);
  }
  if (pLat && pLng){
    const dist = haversine(aLat,aLng,pLat,pLng);
    if (dist <= 50) {
      confirmPickupBtn.disabled = false;
      showToast('Agent is within 50m of pickup — Confirm Pickup enabled', 2500);
    }
  }
  if (dLat && dLng){
    const dist2 = haversine(aLat,aLng,dLat,dLng);
    if (dist2 <= 50) {
      confirmDeliveredBtn.disabled = false;
      showToast('Agent is within 50m of dropoff — Confirm Delivered enabled', 2500);
    }
  }
}

/* Confirm pickup/deliver actions - call backend endpoints (requires token/auth on server) */
async function onConfirmPickup(){
  if (!currentOrder) return showToast('No active order');
  const id = currentOrder._id || currentOrder.id;
  setButtonLoading(confirmPickupBtn, true);
  try {
    const res = await fetch(API_BASE + `/api/orders/${id}/pickup`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({}) });
    if (!res.ok) {
      const text = await res.text();
      showToast('Pickup confirm failed: ' + (text || res.status));
      return;
    }
    showToast('Pickup confirmed');
    await pollOrder(id);
  } catch (e) { console.error(e); showToast('Pickup confirm error'); }
  finally { setButtonLoading(confirmPickupBtn, false); confirmPickupBtn.disabled = true; }
}

async function onConfirmDelivered(){
  if (!currentOrder) return showToast('No active order');
  const id = currentOrder._id || currentOrder.id;
  setButtonLoading(confirmDeliveredBtn, true);
  try {
    const res = await fetch(API_BASE + `/api/orders/${id}/deliver`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({}) });
    if (!res.ok) {
      const text = await res.text();
      showToast('Delivery confirm failed: ' + (text || res.status));
      return;
    }
    showToast('Delivery confirmed');
    await pollOrder(id);
  } catch (e) { console.error(e); showToast('Delivery confirm error'); }
  finally { setButtonLoading(confirmDeliveredBtn, false); confirmDeliveredBtn.disabled = true; }
}

confirmPickupBtn.addEventListener('click', onConfirmPickup);
confirmDeliveredBtn.addEventListener('click', onConfirmDelivered);

/* ====== WebSocket real-time updates (attempt) ====== */
function connectWS(){
  if (ws) return;
  try {
    const scheme = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const url = scheme + '//' + (new URL(API_BASE)).host + WS_PATH;
    ws = new WebSocket(url);
    ws.onopen = ()=> { console.log('WS connected to', url); showToast('Real-time connected'); };
    ws.onmessage = ev => {
      try {
        const msg = JSON.parse(ev.data);
        if (msg.type === 'order_update' && msg.order) {
          // update local currentOrder if matches
          const u = msg.order;
          if (currentOrder && (currentOrder._id === u._id || currentOrder.id === u.id)) {
            currentOrder = u;
            orderStatusBadge.textContent = u.status || orderStatusBadge.textContent;
            renderTimeline(u.status, u);
            // update markers if present
            if (u.agentLocation && u.agentLocation.lat && u.agentLocation.lng) updateAgentMarker(Number(u.agentLocation.lat), Number(u.agentLocation.lng));
            if (u.pickupAddress && u.pickupAddress.lat && u.pickupAddress.lng) setPickupMarker(Number(u.pickupAddress.lat), Number(u.pickupAddress.lng));
            if (u.deliveryAddress && u.deliveryAddress.lat && u.deliveryAddress.lng) setDropoffMarker(Number(u.deliveryAddress.lat), Number(u.deliveryAddress.lng));
            evaluateProximity();
          }
        }
        if (msg.type === 'agent_location' && msg.agent) {
          const a = msg.agent; // expect { lat, lng, orderId, name, phone }
          if (a.lat && a.lng) {
            updateAgentMarker(Number(a.lat), Number(a.lng));
          }
          // if agent belongs to current order update and evaluate proximity
          if (currentOrder && (msg.orderId === currentOrder._id || msg.orderId === currentOrder.id)) {
            currentOrder.agentLocation = { lat: a.lat, lng: a.lng };
            if (a.name) agentName.textContent = a.name;
            if (a.phone) { agentPhone.href = `tel:${a.phone}`; agentPhone.textContent = a.phone; }
            evaluateProximity();
          }
        }
      } catch (e) { console.warn('WS message parse fail', e); }
    };
    ws.onclose = ()=> { console.log('WS closed — retry in 8s'); ws = null; setTimeout(connectWS, 8000); };
    ws.onerror = e => { console.error('WS error', e); ws && ws.close(); ws = null; };
  } catch (e) { console.error('WS connect error', e); }
}

/* ====== Menu overlays (unchanged) ====== */
function openOverlay(content){
  if (typeof content === 'string') overlayPanel.innerHTML = content;
  else { overlayPanel.innerHTML = ''; overlayPanel.appendChild(content); }
  overlay.classList.add('show'); document.documentElement.classList.add('no-scroll');
}
function closeOverlay(){ overlay.classList.remove('show'); overlayPanel.innerHTML = ''; document.documentElement.classList.remove('no-scroll'); }

/* Menu + overlays: reuse your original functions (history, referral, profile, announcements, rate, report, settings) */
/* I will reuse those functions from your original code; copy them here to keep behavior identical. */
/* For brevity, I'll attach them by evaluating the ones already present in the original file (they remain unchanged). */

/* ====== Re-attach original overlay/menu functions ====== */
/* Order History overlay */
async function openHistory(){
  openOverlay('<div>Loading order history...</div>');
  try {
    const res = await getJSON(`/api/orders?customerId=${su_user.id || su_user._id}`);
    const list = Array.isArray(res) ? res : (res.orders || res.data || []);
    const container = document.createElement('div');
    container.innerHTML = `<h3 class="text-xl font-semibold mb-2">Order History</h3>`;
    if (!list || list.length === 0) {
      container.innerHTML += `<div class="text-sm">You have no orders yet.</div>`;
    } else {
      container.innerHTML += list.map(o=>{
        const id = o._id || o.id;
        const status = o.status || 'Unknown';
        const created = new Date(o.createdAt || Date.now()).toLocaleString();
        return `<div class="p-3 border rounded mb-2">
          <div class="font-medium">Order ${id}</div>
          <div class="text-sm text-gray-500">Status: ${status} • ${created}</div>
          <div class="text-sm mt-2">Pickup: ${escapeHtml(o.pickupAddress||'')}</div>
          <div class="text-sm">Drop: ${escapeHtml(o.deliveryAddress||'')}</div>
          <div class="mt-2"><button data-id="${id}" class="btn-primary viewOrder">View</button></div>
        </div>`;
      }).join('');
    }
    overlayPanel.innerHTML = ''; overlayPanel.appendChild(container);
    overlay.querySelectorAll('.viewOrder').forEach(b => b.addEventListener('click', e => {
      const id = e.currentTarget.dataset.id; closeOverlay(); openTracking(id);
    }));
  } catch (e) {
    overlayPanel.innerHTML = `<div class="text-sm text-red-600">Failed to load history: ${e.message}</div>`;
  }
}

/* Referral overlay */
function openReferral(){
  const code = su_user.referralCode || (su_user._id ? 'REF' + String(su_user._id).slice(-6) : 'REF-UNKNOWN');
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Refer & Earn</h3>
    <div class="p-3 border rounded mb-3">
      <div class="font-medium">Your referral code</div>
      <div class="font-mono mt-2 text-lg">${code}</div>
      <div class="text-sm mt-2">Share link: <a href="${location.origin}/signup?ref=${code}">${location.origin}/signup?ref=${code}</a></div>
      <div class="mt-3 flex gap-2"><button id="copyRef" class="btn-primary">Copy</button><button id="shareRef" class="btn-ghost">Share</button></div>
    </div>`;
  openOverlay(node);
  document.getElementById('copyRef').onclick = async ()=> { try { await navigator.clipboard.writeText(`${location.origin}/signup?ref=${code}`); showToast('Copied'); } catch(e){ showToast('Copy failed'); } };
  document.getElementById('shareRef').onclick = async ()=> { try { if (navigator.share) await navigator.share({ title:'Join SkyUltimate', text:'Use my referral link', url:`${location.origin}/signup?ref=${code}` }); else { await navigator.clipboard.writeText(`${location.origin}/signup?ref=${code}`); showToast('Copied'); } } catch(e){ showToast('Share failed'); } };
}

/* Profile overlay */
function openProfile(){
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">My Profile</h3>
    <label class="text-xs">Full name</label><input id="pf_name" class="w-full p-3 rounded mt-1" value="${escapeHtml(su_user.name||'')}" />
    <label class="text-xs mt-2">Email</label><input class="w-full p-3 rounded mt-1 bg-gray-50" value="${escapeHtml(su_user.email||'')}" readonly />
    <label class="text-xs mt-2">Phone</label><input id="pf_phone" class="w-full p-3 rounded mt-1" value="${escapeHtml(su_user.phone||'')}" />
    <div class="flex gap-2 mt-3"><button id="saveProfile" class="btn-primary flex-1">Save</button><button id="closeProfile" class="btn-ghost flex-1">Close</button></div>
    <div id="profileMsg" class="text-sm text-green-600 mt-2"></div>`;
  openOverlay(node);
  document.getElementById('closeProfile').onclick = closeOverlay;
  document.getElementById('saveProfile').onclick = async ()=>{
    const phoneVal = document.getElementById('pf_phone').value.trim();
    try {
      await fetch(API_BASE + '/api/users/me/bank', { method:'PUT', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ phone: phoneVal }) });
      su_user.phone = phoneVal; localStorage.setItem('su_user', JSON.stringify(su_user));
      document.getElementById('profileMsg').textContent = 'Saved';
      setTimeout(closeOverlay,800);
    } catch (e) { document.getElementById('profileMsg').textContent = e.message || 'Save failed'; }
  };
}

/* Announcements overlay */
function openAnnouncements(){
  openOverlay('<div>Loading announcement...</div>');
  setTimeout(()=> {
    overlayPanel.innerHTML = `<h3 class="text-xl font-semibold mb-2">Announcements</h3><div class="text-sm">${announceTitle.textContent || 'No announcements'}</div><div class="text-sm mt-2">${announceMsg.textContent || ''}</div>`;
  }, 200);
}

/* Rate overlay */
function openRate(){
  openOverlay('<div>Loading delivered orders...</div>');
  (async ()=>{
    try {
      const res = await getJSON(`/api/orders?customerId=${su_user.id || su_user._id}`);
      const list = Array.isArray(res) ? res : (res.orders || res.data || []);
      const delivered = (list || []).filter(o => o.status === 'Completed' || o.status === 'Delivered');
      const node = document.createElement('div');
      node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Rate Delivered Order</h3>`;
      if (!delivered.length) node.innerHTML += `<div class="text-sm">No delivered orders available to rate.</div>`;
      else node.innerHTML += delivered.map(o => `<div class="p-3 border rounded mb-2"><div class="font-medium">Order ${o._id || o.id}</div><div class="text-sm">${escapeHtml(o.pickupAddress||'')} → ${escapeHtml(o.deliveryAddress||'')}</div><div class="mt-2"><button data-id="${o._id||o.id}" class="btn-primary doRate">Rate</button></div></div>`).join('');
      overlayPanel.innerHTML = ''; overlayPanel.appendChild(node);
      overlay.querySelectorAll('.doRate').forEach(b => b.addEventListener('click', e => openRatingModal(e.currentTarget.dataset.id)));
    } catch (e) { overlayPanel.innerHTML = `<div class="text-sm text-red-600">Failed: ${e.message}</div>`; }
  })();
}
function openRatingModal(orderId){
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Rate Order ${orderId}</h3>
    <div id="starRow" class="text-3xl mb-3">★★★★★</div>
    <textarea id="rateComment" class="w-full p-3 rounded" placeholder="Comment (optional)"></textarea>
    <div class="flex gap-2 mt-3"><button id="submitRating" class="btn-primary">Submit</button><button id="closeRating" class="btn-ghost">Close</button></div>`;
  openOverlay(node);
  let rating = 5;
  document.getElementById('starRow').addEventListener('click', (ev)=>{
    const idx = Math.ceil((ev.offsetX / ev.currentTarget.clientWidth) * 5);
    rating = Math.max(1, Math.min(5, idx));
    ev.currentTarget.textContent = '★★★★★'.slice(0,rating) + '☆☆☆☆☆'.slice(rating);
  });
  document.getElementById('submitRating').addEventListener('click', async ()=>{
    const comment = document.getElementById('rateComment').value;
    try {
      await fetch(API_BASE + `/api/orders/${orderId}/rate`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ rating, comment }) });
      showToast('Thanks for rating!');
      closeOverlay();
    } catch (e) { showToast(e.message || 'Rating failed'); }
  });
  document.getElementById('closeRating').addEventListener('click', closeOverlay);
}

/* Report overlay */
function openReport(){
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Report an Issue</h3>
    <label class="text-xs">Order ID (optional)</label><input id="rOrder" class="w-full p-3 rounded mt-1" />
    <label class="text-xs mt-2">Message</label><textarea id="rMsg" class="w-full p-3 rounded mt-1"></textarea>
    <div class="flex gap-2 mt-3"><button id="sendReport" class="btn-primary">Send Report</button><button id="closeReport" class="btn-ghost">Close</button></div>`;
  openOverlay(node);
  document.getElementById('closeReport').onclick = closeOverlay;
  document.getElementById('sendReport').onclick = async ()=>{
    const orderId = document.getElementById('rOrder').value.trim();
    const message = document.getElementById('rMsg').value.trim();
    if (!message) { showToast('Please enter a message'); return; }
    try {
      await fetch(API_BASE + '/api/admin-requests', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ orderId: orderId || null, message }) });
      showToast('Report sent to admin.');
      closeOverlay();
    } catch (e) { showToast(e.message || 'Failed to send report'); }
  };
}

/* Settings overlay (dark mode toggle + logout) */
function openSettings(){
  const node = document.createElement('div');
  node.innerHTML = `<h3 class="text-xl font-semibold mb-2">Settings</h3>
    <div class="flex items-center justify-between">
      <div><div class="font-medium">Theme</div><div class="text-sm text-gray-500">Toggle dark mode</div></div>
      <label class="inline-flex items-center"><input id="themeToggle" type="checkbox" class="mr-2" />Dark</label>
    </div>
    <div class="flex gap-2 mt-4"><button id="closeSet" class="btn-ghost">Close</button><button id="logoutBtn" class="btn-ghost text-red-600">Logout</button></div>`;
  openOverlay(node);
  const t = document.getElementById('themeToggle');
  t.checked = !!localStorage.getItem('su_theme_dark');
  t.addEventListener('change', (e)=> {
    if (e.target.checked) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
    if (e.target.checked) localStorage.setItem('su_theme_dark','1'); else localStorage.removeItem('su_theme_dark');
  });
  document.getElementById('closeSet').onclick = closeOverlay;
  document.getElementById('logoutBtn').onclick = ()=> { localStorage.removeItem('su_token'); localStorage.removeItem('su_user'); window.location.href='index.html'; };
}

/* ====== Small utility functions called on init ====== */
async function tryFetchProfileIfMissing(){
  if (su_user && su_user.name && su_user.email) return;
  try {
    const profile = await getJSON('/api/users/profile');
    localStorage.setItem('su_user', JSON.stringify(profile));
  } catch(e){ console.info('profile fetch failed', e.message); }
}
async function refreshHistory(){ try { await getJSON(`/api/orders?customerId=${su_user.id||su_user._id}`); } catch(e){} }

/* ====== UI init & bindings ====== */
(function initUI(){
  const first = (su_user.name || '').split(' ')[0] || 'there';
  welcomeFirst.textContent = `Hello, ${first}!`;
  greetingLarge.textContent = `Welcome back, ${first}!`;
  roleBadge.textContent = su_user.role || 'Customer';

  // menu handlers
  hamburgerBtn.addEventListener('click', openMenu);
  settingsBtn.addEventListener('click', openSettings);
  overlayBackdrop.addEventListener('click', closeOverlay);

  // order flows
  calcPriceBtn.addEventListener('click', onCalculatePrice);
  proceedPaymentBtn.addEventListener('click', onProceedPayment);

  contactAgentBtn.addEventListener('click', ()=> { if (agentPhone && agentPhone.href) location.href = agentPhone.href; });
  reportAgentBtn.addEventListener('click', openReport);

  // Start background tasks
  loadAnnouncement();
  initPlaces();
  tryFetchProfileIfMissing();

  // apply saved theme
  if (localStorage.getItem('su_theme_dark')) document.documentElement.classList.add('dark');
})();

/* Menu builder */
function openMenu(){
  const menuDiv = document.createElement('div');
  menuDiv.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <img src="${document.getElementById('logoImg').src}" class="w-16 h-16 rounded-full object-cover" />
        <div>
          <div class="font-semibold">${escapeHtml(su_user.name || 'User')}</div>
          <div class="text-sm text-gray-500">${escapeHtml(su_user.email || '')}</div>
        </div>
      </div>
      <div><button id="closeMenu" class="btn-ghost">Close</button></div>
    </div>
    <div class="grid gap-2">
      <button id="menu_history" class="btn-ghost w-full text-left">Order History</button>
      <button id="menu_referral" class="btn-ghost w-full text-left">Refer & Earn</button>
      <button id="menu_profile" class="btn-ghost w-full text-left">My Profile</button>
      <button id="menu_ann" class="btn-ghost w-full text-left">Announcements</button>
      <button id="menu_rate" class="btn-ghost w-full text-left">Rate Delivered Order</button>
      <button id="menu_report" class="btn-ghost w-full text-left">Report an Issue</button>
      <button id="menu_settings" class="btn-ghost w-full text-left">Settings</button>
      <button id="menu_logout" class="btn-ghost w-full text-left text-red-600">Logout</button>
    </div>
  `;
  openOverlay(menuDiv);
  document.getElementById('closeMenu').onclick = closeOverlay;
  document.getElementById('menu_history').onclick = openHistory;
  document.getElementById('menu_referral').onclick = openReferral;
  document.getElementById('menu_profile').onclick = openProfile;
  document.getElementById('menu_ann').onclick = openAnnouncements;
  document.getElementById('menu_rate').onclick = openRate;
  document.getElementById('menu_report').onclick = openReport;
  document.getElementById('menu_settings').onclick = openSettings;
  document.getElementById('menu_logout').onclick = ()=> { localStorage.removeItem('su_token'); localStorage.removeItem('su_user'); window.location.href='index.html' };
}

/* small guidance if Google shows "This page can't load Google Maps correctly" */
window.addEventListener('load', ()=> {
  // show theme if previously set
  if (localStorage.getItem('su_theme_dark')) document.documentElement.classList.add('dark');
});

/* Expose helper for debugging */
window.__su = { getJSON };

/* End of script */
</script>
</body>
</html>

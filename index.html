<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SkyUltimate ‚Äî Login & Registration</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    body { background:#ef4444; min-height:100vh; display:flex; align-items:center; justify-content:center; font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; }
    .fade-in { animation: fadeIn 0.45s ease forwards; opacity: 0; }
    @keyframes fadeIn { to { opacity: 1; } }
    .card { width:100%; max-width:420px; border-radius:18px; padding:28px; box-shadow:0 12px 30px rgba(0,0,0,0.14); backdrop-filter: blur(6px); }
    .logo-wrap { display:flex; align-items:center; gap:12px; justify-content:center; margin-bottom:10px; }
    .logo-img { width:86px; height:86px; border-radius:9999px; object-fit:cover; border:4px solid rgba(255,255,255,0.25); background:#fff; }
    .logo-title { font-weight:700; color:#b91c1c; font-size:20px; }
    .tab-active { border-bottom-width:2px; border-color:#b91c1c; color:#111827; }
    .tab-inactive { color:#6b7280; }
    .rounded-btn { border-radius:9999px; }
    select:invalid { color:#9ca3af; }
  </style>
</head>
<body>

  <!-- Splash -->
  <div id="splash" class="fixed inset-0 flex items-center justify-center z-50">
    <div class="text-center">
      <img src="https://github.com/Nelson192006/SkyUltimate-/blob/62343ff3e5e556aa02ecece40e2c006fa9161c0a/logo.png?raw=true"
           alt="SkyUltimate" class="logo-img fade-in" style="width:140px;height:140px;">
      <div style="color:#fff; margin-top:18px; font-weight:700; font-size:22px;">SkyUltimate</div>
      <div style="color:#fee2e2; margin-top:6px; font-size:13px;">Deliveries. Simplified.</div>
    </div>
  </div>

  <!-- Auth card -->
  <div id="authCard" class="hidden card bg-white/90">
    <div class="logo-wrap">
      <img src="https://github.com/Nelson192006/SkyUltimate-/blob/62343ff3e5e556aa02ecece40e2c006fa9161c0a/logo.png?raw=true"
           alt="logo" class="logo-img">
      <div class="logo-title">SkyUltimate</div>
    </div>

    <!-- tabs -->
    <div class="flex justify-between mb-4">
      <button id="loginTab" class="tab-active px-3 py-2 text-sm">Login</button>
      <button id="registerTab" class="tab-inactive px-3 py-2 text-sm">Register</button>
    </div>

    <div id="formsContainer">
      <!-- LOGIN -->
      <form id="loginForm" class="space-y-3">
        <label class="block text-sm text-gray-600">Select role</label>
        <select id="loginRole" class="w-full border rounded-md px-3 py-2" required>
          <option value="" disabled selected>Select role</option>
          <!-- Options populated after flags fetch -->
        </select>

        <label class="block text-sm text-gray-600">Name</label>
        <input id="loginName" placeholder="Your full name" class="w-full border rounded-md px-3 py-2" required>

        <label class="block text-sm text-gray-600">Password</label>
        <div class="relative">
          <input id="loginPassword" type="password" placeholder="Password" class="w-full border rounded-md px-3 py-2 pr-10" required>
          <button type="button" id="loginTogglePassword" class="absolute right-2 top-2 text-gray-500">üëÅÔ∏è</button>
        </div>

        <div class="flex justify-between items-center">
          <a href="#" id="forgotPasswordLink" class="text-sm text-red-700 hover:underline">Forgot password?</a>
        </div>

        <button id="loginBtn" class="w-full bg-red-600 text-white py-2 rounded-btn">Login</button>
        <p id="loginError" class="text-red-600 text-sm"></p>
      </form>

      <!-- REGISTER -->
      <form id="registerForm" class="space-y-3 hidden">
        <label class="block text-sm text-gray-600">Full name</label>
        <input id="registerName" placeholder="John Doe" class="w-full border rounded-md px-3 py-2" required>

        <label class="block text-sm text-gray-600">Select role</label>
        <select id="registerRole" class="w-full border rounded-md px-3 py-2" required>
          <option value="" disabled selected>Select role</option>
          <!-- populated dynamically -->
        </select>

        <label class="block text-sm text-gray-600">Email</label>
        <input id="registerEmail" type="email" placeholder="you@example.com" class="w-full border rounded-md px-3 py-2" required>

        <label class="block text-sm text-gray-600">Password</label>
        <div class="relative">
          <input id="registerPassword" type="password" placeholder="Create password" class="w-full border rounded-md px-3 py-2 pr-10" required>
          <button type="button" id="registerTogglePassword" class="absolute right-2 top-2 text-gray-500">üëÅÔ∏è</button>
        </div>

        <!-- bank fields (for agent/admin) -->
        <div id="bankFields" class="hidden space-y-2">
          <label class="block text-sm text-gray-600">Bank Name</label>
          <input id="bankName" placeholder="Bank name" class="w-full border rounded-md px-3 py-2">
          <label class="block text-sm text-gray-600">Account Number</label>
          <input id="accountNumber" placeholder="Account number" class="w-full border rounded-md px-3 py-2">
          <label class="block text-sm text-gray-600">Account Holder</label>
          <input id="accountHolderName" placeholder="Account holder name" class="w-full border rounded-md px-3 py-2">
          <label class="block text-sm text-gray-600">Phone</label>
          <input id="phone" placeholder="Phone number" class="w-full border rounded-md px-3 py-2">
        </div>

        <button id="registerBtn" class="w-full bg-red-600 text-white py-2 rounded-btn">Register</button>
        <p id="registerError" class="text-red-600 text-sm"></p>
      </form>

      <!-- forgot placeholder -->
      <div id="forgotForm" class="hidden">
        <p class="text-sm text-gray-700">Password reset feature coming soon.</p>
        <input id="forgotEmail" placeholder="Email" class="w-full border rounded-md px-3 py-2 mt-2">
        <div class="flex gap-2 mt-3">
          <button id="sendReset" class="bg-red-600 text-white px-4 py-2 rounded-btn">Send Reset</button>
          <button id="backToAuth" class="border px-4 py-2 rounded-btn">Back</button>
        </div>
        <p id="forgotMsg" class="text-green-600 text-sm mt-2"></p>
      </div>
    </div>
  </div>

<script>
/*
  Wiring notes:
  - API_BASE must point to your backend root (no trailing slash)
  - This file expects these endpoints:
    GET  /api/public/flags
    POST /api/auth/register
    POST /api/auth/login
*/

const API_BASE = "https://skyultimate-backend-api-structure.onrender.com";

// helper that handles JSON or non-JSON error pages gracefully
async function apiFetch(path, opts = {}) {
  const token = localStorage.getItem("su_token");
  const headers = opts.headers || {};
  headers["Content-Type"] = "application/json";
  if (token) headers["Authorization"] = `Bearer ${token}`;
  let res;
  try {
    res = await fetch(API_BASE + path, {...opts, headers});
  } catch (e) {
    throw new Error("Network error: " + (e.message || e));
  }
  const text = await res.text().catch(() => "");
  // try parse
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch (e) {
    if (!res.ok) {
      // include snippet to console for debugging
      console.error("Non-JSON server response:", text.slice(0,1200));
      throw new Error(`Server returned non-JSON response (status ${res.status}). See console.`);
    }
    return text;
  }
  if (!res.ok) {
    const msg = (data && (data.message || data.error)) || `API error ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

// UI elements
const splash = document.getElementById('splash');
const authCard = document.getElementById('authCard');
const loginTab = document.getElementById('loginTab');
const registerTab = document.getElementById('registerTab');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const forgotForm = document.getElementById('forgotForm');

const loginRole = document.getElementById('loginRole');
const registerRole = document.getElementById('registerRole');

const loginName = document.getElementById('loginName');
const loginPassword = document.getElementById('loginPassword');
const registerName = document.getElementById('registerName');
const registerEmail = document.getElementById('registerEmail');
const registerPassword = document.getElementById('registerPassword');

const bankFields = document.getElementById('bankFields');
const bankName = document.getElementById('bankName');
const accountNumber = document.getElementById('accountNumber');
const accountHolderName = document.getElementById('accountHolderName');
const phone = document.getElementById('phone');

const loginError = document.getElementById('loginError');
const registerError = document.getElementById('registerError');

// splash -> show card after 3s
window.addEventListener('load', async () => {
  setTimeout(() => {
    splash.classList.add('hidden');
    authCard.classList.remove('hidden');
  }, 3000);

  // get flags to populate role dropdowns
  try {
    const flags = await apiFetch('/api/public/flags');
    populateRoleOptions(flags);
  } catch (err) {
    console.error("Flags fetch failed:", err);
    // fallback: default roles (hide superadmin if not explicitly allowed)
    populateRoleOptions({ adminRegistrationEnabled: false, allowSuperAdminRegistration: false });
  }
});

function populateRoleOptions(flags = {}) {
  const allowedAdmin = !!flags.adminRegistrationEnabled;
  const allowSuper = !!flags.allowSuperAdminRegistration;

  // roles preference order: Customer, Agent, Admin (optional), SuperAdmin (if allowed)
  const roles = ["Customer","Agent"];
  if (allowedAdmin) roles.push("Admin");
  if (allowSuper) roles.push("SuperAdmin");

  // fill login & register selects
  [loginRole, registerRole].forEach(sel => {
    // remove existing options and add placeholder
    sel.innerHTML = '<option value="" disabled selected>Select role</option>';
    roles.forEach(r => {
      const o = document.createElement('option');
      o.value = r;
      o.textContent = r;
      sel.appendChild(o);
    });
  });
}

// tab switching
loginTab.addEventListener('click', () => {
  loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); forgotForm.classList.add('hidden');
  loginTab.classList.add('tab-active'); loginTab.classList.remove('tab-inactive');
  registerTab.classList.remove('tab-active'); registerTab.classList.add('tab-inactive');
});
registerTab.addEventListener('click', () => {
  registerForm.classList.remove('hidden'); loginForm.classList.add('hidden'); forgotForm.classList.add('hidden');
  registerTab.classList.add('tab-active'); registerTab.classList.remove('tab-inactive');
  loginTab.classList.remove('tab-active'); loginTab.classList.add('tab-inactive');
});

// password toggles
document.getElementById('loginTogglePassword').addEventListener('click', () => {
  loginPassword.type = loginPassword.type === 'password' ? 'text' : 'password';
});
document.getElementById('registerTogglePassword').addEventListener('click', () => {
  registerPassword.type = registerPassword.type === 'password' ? 'text' : 'password';
});

// show bank fields when selecting Agent or Admin in register
registerRole.addEventListener('change', (e) => {
  const v = e.target.value;
  if (v === 'Agent' || v === 'Admin') bankFields.classList.remove('hidden');
  else bankFields.classList.add('hidden');
});

// FORGOT placeholder
document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
  e.preventDefault();
  loginForm.classList.add('hidden');
  forgotForm.classList.remove('hidden');
});
document.getElementById('backToAuth').addEventListener('click', () => {
  forgotForm.classList.add('hidden');
  loginForm.classList.remove('hidden');
});
document.getElementById('sendReset').addEventListener('click', () => {
  document.getElementById('forgotMsg').innerText = "Feature coming soon.";
});

// ------------------ REGISTER ------------------
document.getElementById('registerBtn').addEventListener('click', async (e) => {
  e.preventDefault();
  registerError.innerText = "";

  const name = registerName.value.trim();
  const role = registerRole.value;
  const email = registerEmail.value.trim();
  const password = registerPassword.value;

  if (!name || !role || !email || !password) {
    registerError.innerText = "Please fill all required fields.";
    return;
  }

  const payload = { name, role, email, password };
  if (role === 'Agent' || role === 'Admin') {
    if (!bankName.value || !accountNumber.value || !accountHolderName.value) {
      registerError.innerText = "Please provide bank details for Agent/Admin.";
      return;
    }
    // backend accepts flat bank fields (getBankDetailsFromBody handles it)
    payload.bankName = bankName.value;
    payload.accountNumber = accountNumber.value;
    payload.accountHolderName = accountHolderName.value;
    if (phone.value) payload.phone = phone.value;
  }

  try {
    const res = await apiFetch('/api/auth/register', {
      method: 'POST',
      body: JSON.stringify(payload)
    });

    // backend returns message and user (no token), so switch to login and prefill name
    // If your backend returns token, this will still work because we check res.token below.
    if (res.token) {
      localStorage.setItem('su_token', res.token);
      localStorage.setItem('su_user', JSON.stringify(res.user || {}));
      window.location.href = 'home.html';
      return;
    }

    // show success and switch to login tab
    registerError.style.color = "green";
    registerError.innerText = (res.message || "Registration successful! Please login.");
    // switch to login tab & prefill name
    loginTab.click();
    loginName.value = name;
    loginPassword.value = "";
    setTimeout(() => { registerError.style.color="red"; registerError.innerText=""; }, 6000);
  } catch (err) {
    console.error("Register error:", err);
    registerError.style.color = "red";
    registerError.innerText = err.message || "Registration failed.";
  }
});

// ------------------ LOGIN (name + password) ------------------
document.getElementById('loginBtn').addEventListener('click', async (e) => {
  e.preventDefault();
  loginError.innerText = "";

  const role = loginRole.value;
  const name = loginName.value.trim();
  const password = loginPassword.value;

  if (!role || !name || !password) {
    loginError.innerText = "Please pick a role and fill name & password.";
    return;
  }

  try {
    // login endpoint expects { name, password } per your authroutes.js
    const res = await apiFetch('/api/auth/login', {
      method: 'POST',
      body: JSON.stringify({ name, password })
    });

    if (!res.token) {
      loginError.innerText = res.message || "Login failed.";
      return;
    }

    // store token + user and redirect to home
    localStorage.setItem('su_token', res.token);
    localStorage.setItem('su_user', JSON.stringify(res.user || { id:res.id, name: res.name, role: res.role }));
    // go to universal home
    window.location.href = 'home.html';
  } catch (err) {
    console.error("Login error:", err);
    loginError.innerText = err.message || "Login failed.";
  }
});

</script>
</body>
        </html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SkyUltimate</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    form { margin-bottom: 20px; }
    input { display: block; margin: 5px 0; padding: 8px; width: 250px; }
    button { padding: 8px 15px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>SkyUltimate</h1>

  <!-- Register -->
  <h2>Register</h2>
  <form id="register-form">
    <input type="text" name="name" placeholder="Full Name" required />
    <input type="email" name="email" placeholder="Email" required />
    <input type="password" name="password" placeholder="Password" required />
    <button type="submit">Register</button>
  </form>

  <!-- Login -->
  <h2>Login</h2>
  <form id="login-form">
    <input type="email" name="email" placeholder="Email" required />
    <input type="password" name="password" placeholder="Password" required />
    <button type="submit">Login</button>
  </form>

  <!-- Dashboard/Profile -->
  <button id="dashboard-btn" disabled>View Dashboard</button>
  <button id="logout-btn">Logout</button>

  <!-- Estimator -->
  <h2>Delivery Estimator</h2>
  <form id="estimator-form">
    <input type="text" name="pickup" placeholder="Pickup Location" required />
    <input type="text" name="dropoff" placeholder="Dropoff Location" required />
    <input type="number" name="weight" placeholder="Weight (kg)" required />
    <button type="submit">Estimate</button>
  </form>

  <div id="output"></div>

  <script>
    const API_BASE = "https://skyultimate-backend-api-structure.onrender.com";
    let authToken = localStorage.getItem("authToken") || null;

    function showOutput(message) {
      document.getElementById("output").innerText = message;
    }

    // --- REGISTER ---
    async function registerUser(name, email, password, role = "Customer") {
      try {
        const res = await fetch(`${API_BASE}/users/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email, password, role }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Registration failed");
        showOutput("Registration successful! Please log in.");
      } catch (err) {
        showOutput(err.message);
      }
    }

    // --- LOGIN ---
    async function loginUser(email, password) {
      try {
        const res = await fetch(`${API_BASE}/users/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Login failed");

        authToken = data.token;
        localStorage.setItem("authToken", authToken);
        showOutput("Login successful! Token saved.");
        document.querySelector("#dashboard-btn").disabled = false;
      } catch (err) {
        showOutput(err.message);
      }
    }

    // --- LOGOUT ---
    function logoutUser() {
      authToken = null;
      localStorage.removeItem("authToken");
      showOutput("You have logged out.");
      document.querySelector("#dashboard-btn").disabled = true;
    }

    // --- FETCH DASHBOARD (Protected) ---
    async function fetchDashboard() {
      if (!authToken) return showOutput("Please log in first.");
      try {
        const res = await fetch(`${API_BASE}/users/me`, {
          headers: { Authorization: `Bearer ${authToken}` },
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Failed to fetch dashboard");
        showOutput(`Welcome ${data.name}, Role: ${data.role}`);
      } catch (err) {
        showOutput(err.message);
      }
    }

    // --- ESTIMATOR ---
    async function estimateOrder(pickup, dropoff, weight) {
      try {
        const res = await fetch(`${API_BASE}/orders/estimate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pickup, dropoff, weight }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Failed to estimate order");
        showOutput(`Estimated Price: ${data.price}`);
      } catch (err) {
        showOutput(err.message);
      }
    }

    // --- HOOK UP FORMS ---
    document.addEventListener("DOMContentLoaded", () => {
      // register
      document.querySelector("#register-form").addEventListener("submit", (e) => {
        e.preventDefault();
        const { name, email, password } = e.target;
        registerUser(name.value, email.value, password.value);
      });

      // login
      document.querySelector("#login-form").addEventListener("submit", (e) => {
        e.preventDefault();
        const { email, password } = e.target;
        loginUser(email.value, password.value);
      });

      // logout
      document.querySelector("#logout-btn").addEventListener("click", logoutUser);

      // dashboard
      document.querySelector("#dashboard-btn").addEventListener("click", fetchDashboard);

      // estimator
      document.querySelector("#estimator-form").addEventListener("submit", (e) => {
        e.preventDefault();
        const { pickup, dropoff, weight } = e.target;
        estimateOrder(pickup.value, dropoff.value, weight.value);
      });

      // restore login state
      if (authToken) {
        document.querySelector("#dashboard-btn").disabled = false;
      }
    });
  </script>
</body>
</html>

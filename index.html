<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SkyUltimate — Onboarding</title>
<style>
  :root{
    --brand-red:#d72638;
    --brand-gold:#ffcc66;
    --cream:#fbf6ef;
    --card-bg: rgba(255,255,255,0.95);
    --shadow: 0 8px 30px rgba(0,0,0,0.12);
    --radius: 14px;
  }

  /* page bg gradient */
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  body{
    background: linear-gradient(135deg, #fef3ea 0%, #fff8ef 40%, #fff3e6 100%);
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* SPLASH full-screen */
  #splash{
    position:fixed;inset:0;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    background: linear-gradient(180deg, var(--brand-red), #b71c1c);
    z-index:9999;
    color:white;
    overflow:hidden;
  }
  #splash .logo{
    width:230px; max-width:70%;
    opacity:0; transform:translateY(30px) scale(.98);
    animation:logoIn 1.6s cubic-bezier(.2,.9,.25,1) forwards;
    filter: drop-shadow(0 6px 12px rgba(0,0,0,0.25));
  }
  #splash .tag{
    margin-top:18px;font-weight:600;letter-spacing:.3px;opacity:0;
    color: rgba(255,255,255,0.95);
    animation:tagIn 1.2s ease 0.45s forwards;
  }
  @keyframes logoIn{to{opacity:1;transform:translateY(0) scale(1)}}
  @keyframes tagIn{to{opacity:1;transform:translateY(0)}}

  /* main app card */
  .app{
    width: min(420px, 96vw);
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    display: none; /* shown after splash */
    transition: transform .35s ease, opacity .35s ease;
  }

  .brand{
    display:flex;align-items:center;gap:12px;justify-content:center;margin-bottom:8px;
  }
  .brand img{ width:120px; max-width:48%; }

  .role-row{ display:flex; gap:12px; align-items:center; justify-content:center; margin:8px 0 14px; }
  .role-select{ padding:10px 12px; border-radius:10px; border:1px solid #e6e6e6; background:#fff; width:100%; max-width:260px; font-size:15px; }

  /* mode toggle */
  .mode-toggle{ display:flex; justify-content:center; gap:12px; margin-bottom:14px; }
  .mode-btn{
    padding:8px 16px; border-radius:999px; cursor:pointer; border:1px solid rgba(0,0,0,0.06);
    background:transparent; font-weight:600; color:#222;
    transition:all .24s ease;
  }
  .mode-btn.active{ background:var(--brand-red); color:white; box-shadow: 0 6px 18px rgba(215,25,30,0.15); transform:translateY(-2px); }

  /* form wrapper with slide effect */
  .forms{
    width:200%; display:flex; transition:transform .42s cubic-bezier(.2,.9,.25,1);
  }
  form{ width:50%; padding:0 10px; box-sizing:border-box; display:flex; flex-direction:column; gap:10px; opacity:0; transform:translateY(6px); transition:opacity .28s ease, transform .28s ease; }
  form.active{ opacity:1; transform:translateY(0); }

  label{ font-size:13px; color:#333; margin-left:6px; margin-top:6px; }
  .input{
    position:relative;
    display:flex;
    align-items:center;
  }
  input[type="text"],input[type="email"],input[type="password"],input[type="tel"],select{
    width:100%; padding:12px 44px 12px 14px; border-radius:10px; border:1px solid #e6e6e6; font-size:15px;
    outline:none; transition:box-shadow .16s ease, border-color .16s ease; background:white;
  }
  input:focus{ box-shadow:0 6px 18px rgba(0,0,0,0.06); border-color:rgba(215,25,30,0.25); }
  .eye{
    position:absolute; right:10px; cursor:pointer; font-size:14px; color:#666; padding:6px; border-radius:6px;
  }

  .small{ font-size:13px; color:#666; margin-top:6px; text-align:left; }

  .pw-strength{ font-weight:700; font-size:12px; padding:6px 10px; border-radius:8px; display:inline-block; }
  .strength-weak{ background:#ffdede; color:#b52020; }
  .strength-medium{ background:#fff2d8; color:#b86c00; }
  .strength-strong{ background:#e6ffef; color:#1b7a3a; }

  .btn{
    margin-top:8px; padding:12px; border-radius:999px; border:none; cursor:pointer; font-weight:700; font-size:16px;
    background: linear-gradient(180deg,var(--brand-red), #b71c1c); color:white; box-shadow: 0 10px 24px rgba(215,25,30,0.12);
    position:relative; overflow:hidden;
  }
  /* ripple */
  .btn:after{ content:""; position:absolute; border-radius:50%; transform:scale(0); opacity:0.5; transition:transform .6s, opacity .8s; background:rgba(255,255,255,0.15); }
  .ripple{ transform:scale(3); opacity:0; transition:transform .6s, opacity .8s; }

  .muted-link{ color:var(--brand-red); cursor:pointer; font-weight:600; text-decoration:underline; margin-top:8px; display:block; }

  /* dashboard */
  #dashboard{ display:none; width:min(780px,96vw); max-width:1000px; margin:20px auto; }
  .dash-card{ background:var(--card-bg); padding:18px; border-radius:12px; box-shadow:var(--shadow); text-align:left; }

  /* small screens */
  @media (max-width:420px){
    .brand img{ width:100px; }
    input[type="text"],input[type="email"],input[type="password"]{ padding-right:44px; }
  }

  /* helper message */
  .message{ margin-top:10px; font-size:14px; color:#0a0; }
  .error{ color:#b71c1c; font-weight:700; }
</style>
</head>
<body>

  <!-- full-screen splash: covers entire window -->
  <div id="splash">
    <img id="splashLogo" class="logo" alt="SkyUltimate" src="https://raw.githubusercontent.com/Nelson192006/SkyUltimate-/main/logo.png">
    <div class="tag">Taking Delivery to New Heights.</div>
  </div>

  <!-- main single-file app -->
  <div id="app" class="app" role="application" aria-label="SkyUltimate auth app" style="display:none;">
    <div class="brand">
      <img id="topLogo" src="https://raw.githubusercontent.com/Nelson192006/SkyUltimate-/main/logo.png" alt="SkyUltimate logo">
    </div>

    <div style="display:flex;flex-direction:column;align-items:center;">
      <!-- Mode toggle -->
      <div class="mode-toggle" role="tablist" aria-label="Auth mode toggle">
        <button class="mode-btn active" data-mode="register" id="btnRegister">Register</button>
        <button class="mode-btn" data-mode="login" id="btnLogin">Login</button>
      </div>

      <!-- Role selection -->
      <div class="role-row">
        <select id="roleSelect" class="role-select" aria-label="Select role">
          <option value="customer">Customer</option>
          <option value="agent">Agent</option>
          <option value="superadmin">Super Admin</option>
        </select>
      </div>

      <!-- forms area (two forms side-by-side inside sliding container) -->
      <div style="width:100%; overflow:hidden;">
        <div class="forms" id="forms">
          <!-- Register form -->
          <form id="form-register" class="active" data-type="register" autocomplete="off" onsubmit="return false;">
            <!-- fields injected dynamically -->
            <div id="regFields"></div>
            <div style="display:flex;gap:10px;">
              <button class="btn" id="registerBtn">Register</button>
            </div>
            <div class="small" id="regMsg"></div>
          </form>

          <!-- Login form -->
          <form id="form-login" data-type="login" autocomplete="off" onsubmit="return false;">
            <div id="loginFields"></div>
            <div style="display:flex;gap:10px;">
              <button class="btn" id="loginBtn">Login</button>
            </div>
            <div class="small" id="loginMsg"></div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- dashboard placeholders (single-page dashboards) -->
  <div id="dashboard" style="display:none;">
    <div class="dash-card" id="dashContent">
      <!-- injected -->
    </div>
    <div style="margin-top:12px; text-align:center;">
      <button class="btn" id="logoutBtn" style="width:220px;">Logout</button>
    </div>
  </div>

<script>
/*
  SkyUltimate single-file app logic
  - Stores user records in localStorage (key 'sky_users') with hashed password (SHA-256)
  - Demo only: localStorage is not secure for real apps; use a server for production
*/

/* ---------- Utilities ---------- */
const RAW_LOGO = "https://raw.githubusercontent.com/Nelson192006/SkyUltimate-/main/logo.png";
const app = document.getElementById('app');
const splash = document.getElementById('splash');
const formsContainer = document.getElementById('forms');

const roleSelect = document.getElementById('roleSelect');
const modeRegisterBtn = document.getElementById('btnRegister');
const modeLoginBtn = document.getElementById('btnLogin');
const regFields = document.getElementById('regFields');
const loginFields = document.getElementById('loginFields');
const registerBtn = document.getElementById('registerBtn');
const loginBtn = document.getElementById('loginBtn');
const regMsg = document.getElementById('regMsg');
const loginMsg = document.getElementById('loginMsg');

const DASH = document.getElementById('dashboard');
const DASHCONTENT = document.getElementById('dashContent');
const LOGOUTBTN = document.getElementById('logoutBtn');

function showApp(){ splash.style.display='none'; app.style.display='block'; renderForms(); }
function showSplash(){ splash.style.display='flex'; app.style.display='none'; }

/* simple DOM helper */
function el(tag, attrs={}, children=null){
  const e = document.createElement(tag);
  Object.keys(attrs||{}).forEach(k => {
    if(k==='class') e.className = attrs[k];
    else if(k==='html') e.innerHTML = attrs[k];
    else e.setAttribute(k, attrs[k]);
  });
  if(children){
    if(Array.isArray(children)) children.forEach(c => e.appendChild(c));
    else e.appendChild(children);
  }
  return e;
}

/* localStorage users */
const USERS_KEY = 'sky_users_v1';
function getUsers(){ try{ return JSON.parse(localStorage.getItem(USERS_KEY)||'[]'); }catch(e){ return []; } }
function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
function findUserByRoleAndIdentifier(role, identifier){
  const users = getUsers();
  return users.find(u => u.role===role && (u.email===identifier || u.username===identifier));
}

/* hash function (SHA-256) */
async function hashPassword(password){
  const enc = new TextEncoder();
  const data = enc.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hex = hashArray.map(b=>b.toString(16).padStart(2,'0')).join('');
  return hex;
}

/* mask bank account - show last 4 digits */
function maskAccount(acc){
  if(!acc) return '';
  const s = String(acc);
  if(s.length <= 4) return '****' + s;
  return '****' + s.slice(-4);
}

/* flash message */
function flash(elem, text, isErr=false){
  elem.textContent = text;
  elem.classList.toggle('error', !!isErr);
  if(text){
    setTimeout(() => { elem.textContent=''; elem.classList.remove('error'); }, 4000);
  }
}

/* ------------ UI RENDER ------------- */

/* If superadmin exists -> remove that option from dropdown to enforce one-time setup */
function checkSuperAdminOption(){
  const users = getUsers();
  const hasSuper = users.some(u=>u.role==='superadmin');
  const option = Array.from(roleSelect.options).find(o=>o.value==='superadmin');
  if(hasSuper){
    if(option) option.remove();
  } else {
    if(!option){
      const opt = el('option',{value:'superadmin'});
      opt.textContent = 'Super Admin';
      roleSelect.appendChild(opt);
    }
  }
}

/* Render registration fields depending on role */
function buildRegisterFields(role){
  regFields.innerHTML = '';
  // Common: name/email/password/confirm
  if(role === 'customer'){
    regFields.appendChild(el('label',{}, document.createTextNode('Full Name')));
    regFields.appendChild(el('div',{class:'input'}, el('input',{type:'text',id:'reg_name',placeholder:'Full name',required:true})));

    regFields.appendChild(el('label',{}, document.createTextNode('Email')));
    regFields.appendChild(el('div',{class:'input'}, el('input',{type:'email',id:'reg_email',placeholder:'Email',required:true})));

    regFields.appendChild(el('label',{}, document.createTextNode('Phone (optional)')));
    regFields.appendChild(el('div',{class:'input'}, el('input',{type:'tel',id:'reg_phone',placeholder:'Phone number'})));
  } else if(role === 'agent'){
    regFields.appendChild(el('label',{},document.createTextNode('Full Name')));
    regFields.appendChild(el('div',{class:'input'}, el('input',{type:'text',id:'reg_name',placeholder:'Full name',required:true})));

    regFields.appendChild(el('label',{},document.createTextNode('Email')));
    regFields.appendChild(el('div',{class:'input'}, el('input',{type:'email',id:'reg_email',placeholder:'Email',required:true})));

    regFields.appendChild(el('label',{},document.createTextNode('Phone')));
    regFields.appendChild(el('div',{class:'input'}, el('input',{type:'tel',id:'reg_phone',placeholder:'Phone number',required:true})));

    regFields.appendChild(el('label',{},document.createTextNode('Address')));
    regFields.appendChild(el('div',{class:'input'}, el('input',{type:'text',id:'reg_address',placeholder:'Address',required:true})));

    regFields.appendChild(el('label',{},document.createTextNode('Upload ID (image)')));
    const fileInput = el('input',{type:'file',id:'reg_id',accept:'image/*'});
    regFields.appendChild(el('div',{class:'input'}, fileInput));

    regFields.appendChild(el('label',{},document.createTextNode('Bank Name')));
    regFields.appendChild(el('div',{class:'input'}, el('input',{type:'text',id:'reg_bank',placeholder:'Bank name'})));

    regFields.appendChild(el('label',{},document.createTextNode('Account Holder Name')));
    regFields.appendChild(el('div',{class:'input'}, el('input',{type:'text',id:'reg_accholder',placeholder:'Account holder'})));

    regFields.appendChild(el('label',{},document.createTextNode('Account Number')));
    regFields.appendChild(el('div',{class:'input'}, el('input',{type:'text',id:'reg_accnum',placeholder:'Account number'})));

    regFields.appendChild(el('label',{},document.createTextNode('Routing / Swift')));
    regFields.appendChild(el('div',{class:'input'}, el('input',{type:'text',id:'reg_routing',placeholder:'Routing or SWIFT code'})));
  } else if(role === 'superadmin'){
    // Initial super admin setup (one-time)
    regFields.appendChild(el('label',{},document.createTextNode('Username')));
    regFields.appendChild(el('div',{class:'input'}, el('input',{type:'text',id:'reg_username',placeholder:'Username',required:true})));

    regFields.appendChild(el('label',{},document.createTextNode('Initial Password')));
    regFields.appendChild(wrapPasswordInput('reg_password'));

    regFields.appendChild(el('label',{},document.createTextNode('Confirm Password')));
    regFields.appendChild(wrapPasswordInput('reg_confirm'));
  }

  // For all except SuperAdmin add password fields at end
  if(role !== 'superadmin'){
    regFields.appendChild(el('label',{},document.createTextNode('Password')));
    regFields.appendChild(wrapPasswordInput('reg_password'));

    regFields.appendChild(el('label',{},document.createTextNode('Confirm Password')));
    regFields.appendChild(wrapPasswordInput('reg_confirm'));
  }

  // password strength hint
  const pwHint = el('div',{id:'pwStrength',class:'small'}); regFields.appendChild(pwHint);

  // add pw listeners
  const pwInput = document.getElementById('reg_password');
  if(pwInput){
    pwInput.addEventListener('input', () => {
      const s = passwordStrength(pwInput.value);
      pwHint.textContent = s.text;
      pwHint.className = 'pw-strength ' + s.cls;
    });
  }

  // add eye toggle behavior for any password fields
  setTimeout(()=>{ addPasswordToggles(); }, 50);
}

/* Wrap a password input with eye toggle and return container element */
function wrapPasswordInput(id){
  const div = el('div',{class:'input'});
  const input = el('input',{type:'password',id:id,placeholder:'Password',required:true});
  const eye = el('span',{class:'eye', role:'button', tabindex:0});
  eye.innerHTML = '👁️';
  eye.addEventListener('click', ()=> toggleEye(id));
  eye.addEventListener('keydown', (e)=>{ if(e.key==='Enter') toggleEye(id); });
  div.appendChild(input); div.appendChild(eye);
  return div;
}
function addPasswordToggles(){
  document.querySelectorAll('.eye').forEach(eye=>{
    const parent = eye.parentElement;
    const input = parent.querySelector('input[type="password"],input[type="text"]');
    eye.onclick = ()=> {
      if(!input) return;
      const isPw = input.type === 'password';
      input.type = isPw ? 'text' : 'password';
      eye.textContent = isPw ? '🙈' : '👁️';
    };
  });
}
function toggleEye(id){
  const input = document.getElementById(id);
  if(!input) return;
  const isPw = input.type === 'password';
  input.type = isPw ? 'text' : 'password';
  const eye = input.parentElement.querySelector('.eye');
  if(eye) eye.textContent = isPw ? '🙈' : '👁️';
}

/* Build login fields depending on role */
function buildLoginFields(role){
  loginFields.innerHTML = '';
  if(role === 'customer' || role === 'agent'){
    loginFields.appendChild(el('label',{},document.createTextNode('Email')));
    loginFields.appendChild(el('div',{class:'input'}, el('input',{type:'email',id:'login_email',placeholder:(role==='agent' ? 'Agent email' : 'Email'), required:true})));
  } else {
    loginFields.appendChild(el('label',{},document.createTextNode('Username')));
    loginFields.appendChild(el('div',{class:'input'}, el('input',{type:'text',id:'login_username',placeholder:'Username',required:true})));
  }
  loginFields.appendChild(el('label',{},document.createTextNode('Password')));
  loginFields.appendChild(wrapPasswordInput('login_password'));
  setTimeout(()=> addPasswordToggles(),50);
}

/* Password strength scoring */
function passwordStrength(pw){
  if(!pw) return {text:'', cls:''};
  let score = 0;
  if(pw.length >= 8) score++;
  if(/[A-Z]/.test(pw)) score++;
  if(/\d/.test(pw)) score++;
  if(/[^A-Za-z0-9]/.test(pw)) score++;
  if(score<=1) return {text:'Weak', cls:'strength-weak'};
  if(score===2 || score===3) return {text:'Medium', cls:'strength-medium'};
  return {text:'Strong', cls:'strength-strong'};
}

/* on role change */
roleSelect.addEventListener('change', ()=>{
  renderForms();
});

/* mode toggle */
modeRegisterBtn.addEventListener('click', ()=> setMode('register'));
modeLoginBtn.addEventListener('click', ()=> setMode('login'));

function setMode(mode){
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode===mode));
  const idx = mode==='register' ? 0 : 1;
  formsContainer.style.transform = `translateX(-${idx*50}%)`;
  // set active class to corresponding form for fade
  document.querySelectorAll('form').forEach((f,i)=> f.classList.toggle('active', i===idx));
  // autofocus first input
  setTimeout(()=> {
    const first = (idx===0 ? document.querySelector('#form-register input') : document.querySelector('#form-login input'));
    if(first) first.focus();
  }, 260);
}

/* render forms according to role and mode */
function renderForms(){
  checkSuperAdminOption();
  const role = roleSelect.value;
  buildRegisterFields(role);
  buildLoginFields(role);
  setMode('register');
}

/* handle file input to base64 (for ID image) */
function fileToBase64(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = ()=> rej('file-read-error');
    fr.readAsDataURL(file);
  });
}

/* ---------- Register action ---------- */
registerBtn.addEventListener('click', async (ev)=>{
  ev.preventDefault();
  registerBtn.disabled = true;
  registerBtn.classList.add('active');
  // small ripple
  createRipple(registerBtn, ev);

  const role = roleSelect.value;
  // read fields
  if(role === 'customer'){
    const name = document.getElementById('reg_name')?.value?.trim() || '';
    const email = document.getElementById('reg_email')?.value?.trim() || '';
    const phone = document.getElementById('reg_phone')?.value?.trim() || '';
    const pw = document.getElementById('reg_password')?.value || '';
    const confirm = document.getElementById('reg_confirm')?.value || '';

    if(!name || !email || !pw || !confirm){ flash(regMsg, 'Please fill all required fields', true); registerBtn.disabled=false; return; }
    if(pw !== confirm){ flash(regMsg, 'Passwords do not match', true); registerBtn.disabled=false; return; }
    if(pw.length < 6){ flash(regMsg, 'Password must be at least 6 characters', true); registerBtn.disabled=false; return; }

    // check duplicate email for same role
    const users = getUsers();
    if(users.some(u=>u.role==='customer' && u.email===email)){ flash(regMsg,'Email already registered for customer',true); registerBtn.disabled=false; return; }

    const hashed = await hashPassword(pw);
    const user = { id:Date.now(), role:'customer', name, email, phone, passHash:hashed, createdAt:new Date().toISOString() };
    users.push(user); saveUsers(users);
    flash(regMsg, 'Registered successfully! Please login.');
    // switch to login and prefill
    setTimeout(()=>{ setMode('login'); document.getElementById('login_email').value = email; }, 800);
  }
  else if(role === 'agent'){
    // required checks
    const name = document.getElementById('reg_name')?.value?.trim() || '';
    const email = document.getElementById('reg_email')?.value?.trim() || '';
    const phone = document.getElementById('reg_phone')?.value?.trim() || '';
    const address = document.getElementById('reg_address')?.value?.trim() || '';
    const idFile = document.getElementById('reg_id')?.files?.[0];
    const bank = document.getElementById('reg_bank')?.value?.trim() || '';
    const accHolder = document.getElementById('reg_accholder')?.value?.trim() || '';
    const accNum = document.getElementById('reg_accnum')?.value?.trim() || '';
    const routing = document.getElementById('reg_routing')?.value?.trim() || '';
    const pw = document.getElementById('reg_password')?.value || '';
    const confirm = document.getElementById('reg_confirm')?.value || '';

    if(!name||!email||!phone||!address||!idFile||!bank||!accHolder||!accNum||!routing||!pw||!confirm){
      flash(regMsg,'Please fill all required agent fields', true); registerBtn.disabled=false; return;
    }
    if(pw !== confirm){ flash(regMsg, 'Passwords do not match', true); registerBtn.disabled=false; return; }

    // read ID file
    let idBase64 = '';
    try{ idBase64 = await fileToBase64(idFile); }catch(e){ flash(regMsg, 'Failed to read ID image', true); registerBtn.disabled=false; return; }

    const users = getUsers();
    if(users.some(u=>u.role==='agent' && u.email===email)){ flash(regMsg,'Agent email already registered',true); registerBtn.disabled=false; return; }

    const hashed = await hashPassword(pw);
    const user = { id:Date.now(), role:'agent', name, email, phone, address, idImage:idBase64, bank, accHolder, accNum, routing, passHash:hashed, createdAt:new Date().toISOString() };
    users.push(user); saveUsers(users);
    flash(regMsg, 'Agent registered! Please login.');
    setTimeout(()=>{ setMode('login'); document.getElementById('login_email').value = email; }, 800);
  }
  else if(role === 'superadmin'){
    const username = document.getElementById('reg_username')?.value?.trim() || '';
    const pw = document.getElementById('reg_password')?.value || '';
    const confirm = document.getElementById('reg_confirm')?.value || '';
    if(!username||!pw||!confirm){ flash(regMsg,'Please fill required fields',true); registerBtn.disabled=false; return; }
    if(pw !== confirm){ flash(regMsg,'Passwords do not match',true); registerBtn.disabled=false; return; }

    // check one-time
    const users = getUsers();
    if(users.some(u=>u.role==='superadmin')){ flash(regMsg,'Super Admin already exists',true); registerBtn.disabled=false; return; }

    const hashed = await hashPassword(pw);
    const user = { id:Date.now(), role:'superadmin', username, passHash:hashed, createdAt:new Date().toISOString() };
    users.push(user); saveUsers(users);
    flash(regMsg, 'Super Admin set up. Please login.');
    // remove option
    checkSuperAdminOption();
    setTimeout(()=>{ setMode('login'); document.getElementById('login_username').value = username; }, 800);
  }

  registerBtn.disabled = false;
});

/* ---------- Login action ---------- */
loginBtn.addEventListener('click', async (ev)=>{
  ev.preventDefault();
  loginBtn.disabled = true;
  createRipple(loginBtn, ev);

  const role = roleSelect.value;
  const password = document.getElementById('login_password')?.value || '';
  if(!password){ flash(loginMsg,'Enter your password', true); loginBtn.disabled=false; return; }

  let identifier = '';
  if(role === 'customer' || role==='agent') identifier = document.getElementById('login_email')?.value?.trim() || '';
  else identifier = document.getElementById('login_username')?.value?.trim() || '';

  if(!identifier){ flash(loginMsg,'Please enter your login identifier', true); loginBtn.disabled=false; return; }

  const hashed = await hashPassword(password);
  const users = getUsers();
  const user = users.find(u => u.role === role && ((role==='superadmin' && u.username===identifier) || (role!=='superadmin' && u.email===identifier)));
  if(!user){ flash(loginMsg,'No account found for provided details', true); loginBtn.disabled=false; return; }
  if(user.passHash !== hashed){ flash(loginMsg,'Incorrect password', true); loginBtn.disabled=false; return; }

  // success -> open dashboard
  openDashboard(user);
  loginBtn.disabled=false;
});

/* create ripple effect for buttons */
function createRipple(el, e){
  const rect = el.getBoundingClientRect();
  const ripple = document.createElement('span');
  const size = Math.max(rect.width, rect.height);
  ripple.style.width = ripple.style.height = size + 'px';
  ripple.style.left = ( (e.clientX || (rect.left + rect.width/2)) - rect.left - size/2 ) + 'px';
  ripple.style.top  = ( (e.clientY || (rect.top + rect.height/2)) - rect.top - size/2 ) + 'px';
  ripple.style.position = 'absolute';
  ripple.style.borderRadius = '50%';
  ripple.style.background = 'rgba(255,255,255,0.18)';
  ripple.style.transform = 'scale(0)';
  ripple.style.opacity = '1';
  ripple.style.transition = 'transform .6s ease, opacity .8s ease';
  el.appendChild(ripple);
  setTimeout(()=>{ ripple.style.transform = 'scale(3)'; ripple.style.opacity = '0'; },20);
  setTimeout(()=> ripple.remove(),900);
}

/* ---------- Dashboard ---------- */
function openDashboard(user){
  // hide auth
  app.style.display = 'none';
  DASH.style.display = 'block';
  // build content
  let html = `<h2 style="color:${'var(--brand-red)'}">Welcome, ${user.name||user.username||user.email}</h2>`;
  html += `<p style="color:#444;margin-top:6px">Role: <strong>${user.role}</strong></p>`;
  // role specific details
  if(user.role === 'customer'){
    html += `<hr/><p><strong>Full Name:</strong> ${user.name || ''}</p>`;
    html += `<p><strong>Email:</strong> ${user.email || ''}</p>`;
    html += `<p><strong>Phone:</strong> ${user.phone || '—'}</p>`;
  } else if(user.role === 'agent'){
    html += `<hr/><p><strong>Full Name:</strong> ${user.name}</p>`;
    html += `<p><strong>Email:</strong> ${user.email}</p>`;
    html += `<p><strong>Phone:</strong> ${user.phone}</p>`;
    html += `<p><strong>Address:</strong> ${user.address}</p>`;
    html += `<p><strong>Bank:</strong> ${user.bank} — ${maskAccount(user.accNum)}</p>`;
    // show ID image thumbnail if present
    if(user.idImage){
      html += `<p style="margin-top:12px"><strong>ID Image:</strong></p><img src="${user.idImage}" alt="ID" style="max-width:220px;border-radius:8px;border:1px solid #eee;margin-top:8px"/>`;
    }
  } else if(user.role === 'superadmin'){
    html += `<hr/><p>Super Admin account created at: ${new Date(user.createdAt).toLocaleString()}</p>`;
  }

  html += `<p style="margin-top:16px;color:#777">This is a demo dashboard. In production you'd be redirected to a secured dashboard page.</p>`;
  DASHCONTENT.innerHTML = html;
}

/* logout */
LOGOUTBTN.addEventListener('click', ()=>{
  DASH.style.display = 'none';
  app.style.display = 'block';
  setMode('login');
});

/* initial startup: show splash then app */
window.addEventListener('load', ()=>{
  // ensure top logos point to raw link
  document.getElementById('splashLogo').src = RAW_LOGO;
  document.getElementById('topLogo').src = RAW_LOGO;

  // determine if superadmin exists already and remove option if so
  checkSuperAdminOption();

  // splash duration 3s then show app
  setTimeout(()=>{
    // slide splash up visually (quick fade)
    splash.style.transition = 'opacity .5s ease, transform .6s ease';
    splash.style.transform = 'translateY(-18px)';
    splash.style.opacity = '0';
    setTimeout(()=> splash.style.display = 'none', 600);
    // show app
    app.style.display = 'block';
    renderForms();
    // initial mode
    setMode('register');
  }, 3000);
});
</script>

</body>
</html>

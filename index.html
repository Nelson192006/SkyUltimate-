<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SkyUltimate Delivery - Login / Register</title>
<style>
    /* --- Global Styles --- */
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', system-ui, -apple-system, "Helvetica Neue", Arial, sans-serif; }
    html,body { width:100%; height:100%; background:#C00000; color:#111; }
    a { text-decoration:none; color:inherit; }
    button { cursor:pointer; border:none; outline:none; }

    /* --- Splash Screen --- */
    #splash {
        position:fixed; top:0; left:0; width:100%; height:100%;
        background:#C00000; display:flex; justify-content:center; align-items:center;
        z-index:20; transition: opacity 0.8s ease;
    }
    #splash img { width:150px; height:150px; border-radius:50%; opacity:0; animation: fadeIn 0.5s forwards; }

    @keyframes fadeIn { to { opacity:1; } }

    /* --- Layout --- */
    #main-container { display:none; width:100%; height:100%; background:#C00000; display:flex; justify-content:center; align-items:center; }
    .card {
        background: rgba(255,255,255,0.98); border-radius: 15px; padding: 30px; width: 380px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2); position: relative;
    }

    .tabs { display:flex; margin-bottom:20px; cursor:pointer; }
    .tab { flex:1; text-align:center; padding:10px; font-weight:bold; position:relative; color:#444; }
    .tab.active::after {
        content:""; position:absolute; bottom:0; left:0; width:100%; height:4px; background:#C00000; border-radius:4px 4px 0 0;
    }

    input, select { width:100%; padding:10px 12px; margin-bottom:12px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
    .input-group { position:relative; }
    .input-group img.left-icon { position:absolute; top:50%; left:10px; transform:translateY(-50%); width:18px; opacity:0.6; }
    .input-group input { padding-left:40px; }
    .eye-icon { position:absolute; top:50%; right:10px; transform: translateY(-50%); cursor:pointer; width:20px; opacity:0.6; }

    .btn { width:100%; padding:12px; border-radius:10px; background:#C00000; color:white; font-weight:700; margin-top:10px; transition: 0.18s; }
    .btn:hover { transform:translateY(-1px); }

    .error-msg { color:#b00000; font-size:0.9rem; margin-top:8px; display:none; text-align:center; }
    .info-msg { color:#0a662a; font-size:0.9rem; margin-top:8px; display:none; text-align:center; }
    .small { font-size:13px; color:#666; margin-top:8px; text-align:center; }

    .forgot { text-align:right; font-size:0.85rem; color:#C00000; cursor:pointer; margin-bottom:12px; }

    /* --- Modal / Panels --- */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:40; justify-content:center; align-items:center; padding:20px; }
    .modal .panel { background:white; color:#C00000; padding:18px; border-radius:10px; width:100%; max-width:420px; }
    .modal .panel input { margin-bottom:10px; }
    .modal .panel .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }

    /* Reset form */
    #reset-wrapper { display:none; width:100%; height:100%; background:#C00000; display:flex; justify-content:center; align-items:center; padding:20px; }
    .reset-card { background:white; padding:24px; border-radius:12px; width:380px; color:#C00000; box-shadow:0 8px 20px rgba(0,0,0,0.15); }
</style>
</head>
<body>

<!-- Splash -->
<div id="splash">
    <img src="https://raw.githubusercontent.com/Nelson192006/SkyUltimate-/fdf409b0e40dfbd432afd277b20ddb8965600fc7/logo.png" alt="SkyUltimate Logo">
</div>

<!-- Main -->
<div id="main-container" aria-hidden="true">
    <div class="card" role="main">
        <div class="tabs" role="tablist" aria-label="auth tabs">
            <div class="tab active" id="login-tab" role="tab" aria-selected="true">Login</div>
            <div class="tab" id="register-tab" role="tab" aria-selected="false">Register</div>
        </div>

        <!-- LOGIN -->
        <div id="login-form" role="region">
            <select id="login-role" aria-label="select role (login)">
                <option value="">Select your role</option>
                <option value="customer">Customer</option>
                <option value="agent">Agent</option>
                <option value="admin">Admin</option>
                <option value="superadmin">Super-admin</option>
            </select>

            <div class="input-group">
                <img class="left-icon" src="https://img.icons8.com/ios-filled/50/000000/new-post.png" alt="">
                <input type="email" id="login-email" placeholder="Email" autocomplete="username">
            </div>

            <div class="input-group">
                <img class="left-icon" src="https://img.icons8.com/ios-filled/50/000000/key.png" alt="">
                <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
                <img src="https://img.icons8.com/ios-glyphs/30/000000/eye.png" class="eye-icon" id="toggle-login-password" alt="toggle">
            </div>

            <div class="forgot" id="forgot-password">Forgot Password?</div>
            <button class="btn" id="login-btn">Login</button>
            <div class="error-msg" id="login-error"></div>
            <div class="info-msg" id="login-info"></div>
        </div>

        <!-- REGISTER -->
        <div id="register-form" style="display:none;" role="region">
            <select id="register-role" aria-label="select role (register)">
                <option value="">Select your role</option>
                <option value="customer">Customer</option>
                <option value="agent">Agent</option>
                <!-- Super-admin option will be dynamically shown only if allowed -->
            </select>

            <input type="text" id="register-fullname" placeholder="Full Name" autocomplete="name">
            <input type="email" id="register-email" placeholder="Email" autocomplete="email">

            <div class="input-group">
                <input type="password" id="register-password" placeholder="Password" autocomplete="new-password">
                <img src="https://img.icons8.com/ios-glyphs/30/000000/eye.png" class="eye-icon" id="toggle-register-password" alt="toggle">
            </div>

            <input type="text" id="register-phone" placeholder="Phone Number">
            <input type="text" id="register-bank-name" placeholder="Bank Name (agents only)">
            <input type="text" id="register-account-number" placeholder="Account Number (agents only)">
            <input type="text" id="register-account-holder" placeholder="Account Holder Name (agents only)">

            <button class="btn" id="register-btn">Register</button>
            <div class="error-msg" id="register-error"></div>
            <div class="info-msg small" id="register-info">If you're the platform owner and this is the first-time setup, select <strong>Super-admin</strong> during registration.</div>
        </div>
    </div>
</div>

<!-- Forgot Password Modal -->
<div id="forgot-modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="panel">
        <h3 style="margin-bottom:8px;color:#C00000;">Reset Password</h3>
        <p style="font-size:13px;margin-bottom:8px;color:#444;">Enter the email for the account you want to reset.</p>
        <input id="forgot-email" placeholder="Email" type="email">
        <select id="forgot-role" style="margin-bottom:8px;">
            <option value="">Select role</option>
            <option value="customer">Customer</option>
            <option value="agent">Agent</option>
            <option value="admin">Admin</option>
            <option value="superadmin">Super-admin</option>
        </select>
        <div style="display:flex;gap:8px;justify-content:flex-end;" class="actions">
            <button id="forgot-cancel" style="background:#eee;padding:10px;border-radius:8px;">Cancel</button>
            <button id="forgot-send" style="background:#C00000;color:white;padding:10px;border-radius:8px;">Send Reset Link</button>
        </div>
        <div class="error-msg" id="forgot-error" style="margin-top:10px;"></div>
        <div class="info-msg" id="forgot-info" style="margin-top:10px;"></div>
    </div>
</div>

<!-- Reset Password Inline (if reset token present) -->
<div id="reset-wrapper" role="main" aria-hidden="true">
    <div class="reset-card">
        <h3 style="margin-bottom:8px;">Create a new password</h3>
        <p style="margin-bottom:12px;font-size:14px;color:#444;">Enter your new password to finish the reset.</p>
        <input id="reset-email" type="email" placeholder="Email (auto-filled if provided)" style="margin-bottom:10px;">
        <input id="reset-password" type="password" placeholder="New password" style="margin-bottom:10px;">
        <input id="reset-password-confirm" type="password" placeholder="Confirm password" style="margin-bottom:10px;">
        <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button id="reset-cancel" style="background:#eee;padding:10px;border-radius:8px;">Cancel</button>
            <button id="reset-submit" style="background:#C00000;color:white;padding:10px;border-radius:8px;">Set Password</button>
        </div>
        <div class="error-msg" id="reset-error" style="margin-top:10px;"></div>
        <div class="info-msg" id="reset-info" style="margin-top:10px;"></div>
    </div>
</div>

<script>
/* ------------- Configuration ------------- */
const API_BASE = 'https://skyultimate-backend-api-structure.onrender.com'; // <-- change to include /api if your backend uses that prefix
const RETRY_ENDPOINTS = [
  // fallback order if you want to try alternate prefixes (not used directly but here for reference)
  `${API_BASE}`,
  `${API_BASE}/api`
];

/* ------------- Utilities ------------- */
function show(el){ if(el) el.style.display = 'block'; }
function hide(el){ if(el) el.style.display = 'none'; }
function setError(el, msg){ if(!el) return; el.style.display='block'; el.textContent=msg; }
function setInfo(el, msg){ if(!el) return; el.style.display='block'; el.textContent=msg; }
function clearMsg(el){ if(!el) return; el.style.display='none'; el.textContent=''; }

// generic fetch wrapper with JSON body
async function apiFetch(path, options = {}) {
    const url = `${API_BASE}${path.startsWith('/') ? path : '/' + path}`;
    const headers = options.headers || {};
    if(options.body && !(options.body instanceof FormData)) headers['Content-Type'] = 'application/json';
    if(sessionStorage.getItem('token')) headers['Authorization'] = `Bearer ${sessionStorage.getItem('token')}`;
    try{
        const res = await fetch(url, {...options, headers});
        const text = await res.text();
        let data = {};
        try{ data = text? JSON.parse(text) : {}; } catch(e){ data = { raw: text }; }
        return { ok: res.ok, status: res.status, data };
    }catch(err){
        return { ok:false, status:0, error: err.message || String(err) };
    }
}

/* ------------- UI Elements ------------- */
const splash = document.getElementById('splash');
const mainContainer = document.getElementById('main-container');
const loginTab = document.getElementById('login-tab');
const registerTab = document.getElementById('register-tab');
const loginForm = document.getElementById('login-form');
const registerForm = document.getElementById('register-form');

const loginBtn = document.getElementById('login-btn');
const registerBtn = document.getElementById('register-btn');

const loginError = document.getElementById('login-error');
const loginInfo = document.getElementById('login-info');
const registerError = document.getElementById('register-error');
const registerInfo = document.getElementById('register-info');

const forgotModal = document.getElementById('forgot-modal');
const forgotSend = document.getElementById('forgot-send');
const forgotCancel = document.getElementById('forgot-cancel');
const forgotPasswordLink = document.getElementById('forgot-password');
const forgotError = document.getElementById('forgot-error');
const forgotInfo = document.getElementById('forgot-info');

const resetWrapper = document.getElementById('reset-wrapper');
const resetSubmit = document.getElementById('reset-submit');
const resetCancel = document.getElementById('reset-cancel');
const resetError = document.getElementById('reset-error');
const resetInfo = document.getElementById('reset-info');

const loginRoleSelect = document.getElementById('login-role');
const registerRoleSelect = document.getElementById('register-role');

/* ------------- Splash & Init ------------- */
window.addEventListener('load', async () => {
    // show splash for 3s
    setTimeout(()=> {
        splash.style.opacity='0';
        setTimeout(()=> {
            splash.style.display='none';
            mainContainer.style.display='flex';
            mainContainer.setAttribute('aria-hidden','false');
        },800);
    },3000);

    // check if reset token present in URL
    const url = new URL(window.location.href);
    const resetToken = url.searchParams.get('resetToken') || url.searchParams.get('token');
    const resetEmail = url.searchParams.get('email');
    if(resetToken){
        // show reset UI
        document.getElementById('reset-email').value = resetEmail || '';
        showResetPanel(resetToken);
    }

    // check if a super admin already exists (one-time registration logic)
    await checkSuperadminExistence();
});

/* ------------- Tab switching ------------- */
loginTab.addEventListener('click', () => {
    loginTab.classList.add('active');
    registerTab.classList.remove('active');
    loginForm.style.display = 'block';
    registerForm.style.display = 'none';
});
registerTab.addEventListener('click', () => {
    registerTab.classList.add('active');
    loginTab.classList.remove('active');
    loginForm.style.display = 'none';
    registerForm.style.display = 'block';
});

/* ------------- Password toggles ------------- */
document.getElementById('toggle-login-password').addEventListener('click', ()=>{
    const p = document.getElementById('login-password');
    p.type = p.type === 'password' ? 'text' : 'password';
});
document.getElementById('toggle-register-password').addEventListener('click', ()=>{
    const p = document.getElementById('register-password');
    p.type = p.type === 'password' ? 'text' : 'password';
});

/* ------------- Super-admin existence check (one-time registration) ------------- */
let superadminExists = null;
async function checkSuperadminExistence(){
    // Try a couple of plausible endpoints. Backend may expose any of these; we stop on the first successful info.
    const tries = [
        '/auth/superadmin-exists',      // common custom
        '/auth/superadmin',             // possible
        '/auth/superadmin/status',      // possible
        '/auth/check-superadmin',       // possible
        '/api/auth/superadmin-exists'   // fallback with /api prefix
    ];
    for(const p of tries){
        const r = await apiFetch(p, { method: 'GET' });
        if(r.ok && r.data){
            // Expect { exists: true } or { exists: false } or {count:0}
            if(typeof r.data.exists === 'boolean'){
                superadminExists = r.data.exists;
                break;
            } else if(typeof r.data.count === 'number'){
                superadminExists = r.data.count > 0;
                break;
            } else if(typeof r.data.hasSuperAdmin === 'boolean'){
                superadminExists = r.data.hasSuperAdmin;
                break;
            } else {
                // If response contains any truthy value that suggests super admin exists
                const vals = Object.values(r.data);
                if(vals.some(v => v === true || v === 'true' || v > 0)){
                    superadminExists = true;
                    break;
                } else {
                    superadminExists = false;
                    break;
                }
            }
        }
    }

    // If still null, assume backend does not provide an endpoint; be permissive but warn user
    if(superadminExists === null){
        // We cannot be certain — allow Super-admin to be shown but add a warning
        superadminExists = false;
        registerInfo.textContent = 'Warning: system could not verify Super-admin existence. If a Super-admin already exists, backend will reject duplicate creation.';
        registerInfo.style.display = 'block';
    }

    // Show or hide superadmin option in register dropdown
    const existsOption = document.createElement('option'); existsOption.value = 'superadmin'; existsOption.textContent = 'Super-admin';
    if(!superadminExists){
        // add superadmin option if not present
        if(!Array.from(registerRoleSelect.options).some(o=>o.value==='superadmin')){
            registerRoleSelect.appendChild(existsOption);
        }
    } else {
        // remove if present
        Array.from(registerRoleSelect.options).forEach(o=>{ if(o.value==='superadmin') o.remove(); });
    }
}

/* ------------- Login ------------- */
loginBtn.addEventListener('click', async ()=>{
    clearMsg(loginError); clearMsg(loginInfo);
    const role = document.getElementById('login-role').value.trim();
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value.trim();

    if(!role || !email || !password){ setError(loginError, 'Please fill in all fields'); return; }

    // Call backend login
    const res = await apiFetch('/auth/login', {
        method:'POST',
        body: JSON.stringify({ role, email, password })
    });

    if(res.ok){
        const token = res.data.token || res.data.accessToken || res.data.authToken;
        const roleReturned = res.data.role || role;
        const fullName = res.data.fullName || res.data.name || res.data.user?.fullName || '';
        if(token){
            sessionStorage.setItem('token', token);
            sessionStorage.setItem('role', roleReturned);
            sessionStorage.setItem('name', fullName || '');
            // redirect according to role (you can change or centralize routing)
            window.location.href = 'home.html';
        } else {
            setError(loginError, 'Login succeeded but token missing in response. Check backend response shape.');
        }
    } else {
        const msg = (res.data && (res.data.message || res.data.error || JSON.stringify(res.data))) || `Login failed (status ${res.status})`;
        setError(loginError, msg);
    }
});

/* ------------- Register ------------- */
registerBtn.addEventListener('click', async ()=>{
    clearMsg(registerError); clearMsg(registerInfo);

    const role = document.getElementById('register-role').value.trim();
    const fullName = document.getElementById('register-fullname').value.trim();
    const email = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value.trim();
    const phone = document.getElementById('register-phone').value.trim();
    const bankName = document.getElementById('register-bank-name').value.trim();
    const accountNumber = document.getElementById('register-account-number').value.trim();
    const accountHolder = document.getElementById('register-account-holder').value.trim();

    if(!role || !fullName || !email || !password){ setError(registerError, 'Please fill all required fields'); return; }

    // Prevent registering superadmin if backend claimed one exists
    if(role === 'superadmin' && superadminExists){
        setError(registerError, 'A Super-admin already exists on this platform. You cannot create another.');
        return;
    }

    // Build payload
    const payload = { role, fullName, email, password };
    if(phone) payload.phone = 

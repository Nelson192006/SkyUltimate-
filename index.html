<script>
const API_BASE = "https://skyultimate-backend-api-structure.onrender.com";
let authToken = localStorage.getItem("authToken") || null;

// --- REGISTER ---
async function registerUser(name, email, password, role = "Customer") {
  try {
    const res = await fetch(`${API_BASE}/users/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, email, password, role }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Registration failed");
    alert("Registration successful! Please log in.");
    return data;
  } catch (err) {
    alert(err.message);
  }
}

// --- LOGIN ---
async function loginUser(email, password) {
  try {
    const res = await fetch(`${API_BASE}/users/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Login failed");

    authToken = data.token;
    localStorage.setItem("authToken", authToken);
    alert("Login successful!");

    document.querySelector("#dashboard-btn").disabled = false;
    return data;
  } catch (err) {
    alert(err.message);
  }
}

// --- LOGOUT ---
function logoutUser() {
  authToken = null;
  localStorage.removeItem("authToken");
  alert("You have logged out.");
  document.querySelector("#dashboard-btn").disabled = true;
}

// --- FETCH DASHBOARD (Protected) ---
async function fetchDashboard() {
  if (!authToken) return alert("Please log in first.");
  try {
    const res = await fetch(`${API_BASE}/users/me`, {
      headers: { Authorization: `Bearer ${authToken}` },
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Failed to fetch dashboard");
    console.log("Dashboard Data:", data);
    alert(`Welcome ${data.name}, role: ${data.role}`);
  } catch (err) {
    alert(err.message);
  }
}

// --- ESTIMATOR ---
async function estimateOrder(pickup, dropoff, weight) {
  try {
    const res = await fetch(`${API_BASE}/orders/estimate`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pickup, dropoff, weight }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Failed to estimate order");
    alert(`Estimated Price: ${data.price}`);
    return data;
  } catch (err) {
    alert(err.message);
  }
}

// --- UI HOOKUP ---
document.addEventListener("DOMContentLoaded", () => {
  // register
  document.querySelector("#register-form")?.addEventListener("submit", (e) => {
    e.preventDefault();
    const name = e.target.name.value;
    const email = e.target.email.value;
    const password = e.target.password.value;
    registerUser(name, email, password);
  });

  // login
  document.querySelector("#login-form")?.addEventListener("submit", (e) => {
    e.preventDefault();
    const email = e.target.email.value;
    const password = e.target.password.value;
    loginUser(email, password);
  });

  // logout
  document.querySelector("#logout-btn")?.addEventListener("click", logoutUser);

  // dashboard
  document.querySelector("#dashboard-btn")?.addEventListener("click", fetchDashboard);

  // estimator
  document.querySelector("#estimator-form")?.addEventListener("submit", (e) => {
    e.preventDefault();
    const pickup = e.target.pickup.value;
    const dropoff = e.target.dropoff.value;
    const weight = e.target.weight.value;
    estimateOrder(pickup, dropoff, weight);
  });

  // disable dashboard if not logged in
  if (!authToken) {
    document.querySelector("#dashboard-btn").disabled = true;
  }
});
    </script>

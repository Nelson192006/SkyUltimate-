<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SkyUltimate ‚Äî Login & Registration</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Animations */
    .fade-in { animation: fadeIn 0.5s ease forwards; opacity: 0; }
    @keyframes fadeIn { to { opacity: 1; } }

    .cross-fade-enter { opacity: 0; transition: opacity 0.4s ease; }
    .cross-fade-enter-active { opacity: 1; }
    .cross-fade-leave { opacity: 1; transition: opacity 0.4s ease; }
    .cross-fade-leave-active { opacity: 0; }

    /* Input with icon inside */
    .input-with-icon { position: relative; }
    .input-icon { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); cursor: pointer; }

    /* Slight glass card backdrop */
    .glass-card { background: rgba(255,255,255,0.85); backdrop-filter: blur(6px); }

    /* Make splash logo bigger on larger screens */
    #splashLogo { width: 36vmin; max-width: 220px; min-width: 120px; border-radius: 9999px; }

    /* Nice shadow for card */
    .card-shadow { box-shadow: 0 10px 30px rgba(0,0,0,0.15); }

    /* keep buttons rounded and roomy */
    .rounded-btn { border-radius: 14px; padding-top: 0.6rem; padding-bottom: 0.6rem; }

    /* small text color */
    .muted { color: #6b7280; }

    /* mobile tweaks */
    @media (max-width: 640px) {
      #splashLogo { width: 48vmin; }
      .card-width { width: 92vw; }
    }
  </style>
</head>
<body class="bg-red-600 min-h-screen flex items-center justify-center">

  <!-- Splash -->
  <div id="splash" class="absolute inset-0 flex items-center justify-center z-50">
    <div class="text-center">
      <img id="splashLogo" src="https://github.com/Nelson192006/SkyUltimate-/blob/62343ff3e5e556aa02ecece40e2c006fa9161c0a/logo.png?raw=true" alt="SkyUltimate Logo" class="mx-auto rounded-full fade-in">
      <h1 class="text-white mt-6 text-2xl font-bold">SkyUltimate Delivery</h1>
      <p class="text-white/90 mt-2 max-w-xs mx-auto">Delivering trust, one parcel at a time.</p>
    </div>
  </div>

  <!-- Auth Card (hidden under splash) -->
  <div id="authWrap" class="hidden w-full min-h-screen flex items-start justify-center pt-12 pb-12">
    <!-- Page container keeps logo on red background -->
    <div class="w-full max-w-4xl mx-auto px-4">
      <!-- Top area: Logo in red background -->
      <div class="bg-red-600 rounded-2xl p-8 flex flex-col items-center justify-center mb-6">
        <img src="https://github.com/Nelson192006/SkyUltimate-/blob/62343ff3e5e556aa02ecece40e2c006fa9161c0a/logo.png?raw=true" alt="Logo" class="w-28 h-28 rounded-full border-4 border-white shadow-sm">
        <h2 class="text-white text-xl md:text-2xl font-extrabold mt-4">SkyUltimate Deliveries</h2>
        <p class="text-white/90 mt-1 max-w-2xl text-center">Fast. Transparent. Reliable ‚Äî track your delivery every step of the way.</p>
      </div>

      <!-- Card -->
      <div class="glass-card card-shadow rounded-2xl p-6 md:p-8 card-width mx-auto max-w-xl">
        <!-- Tabs -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex space-x-2 items-center">
            <button id="tabLogin" class="px-4 py-2 rounded-btn bg-red-600 text-white font-semibold">Login</button>
            <button id="tabRegister" class="px-4 py-2 rounded-btn bg-white text-gray-700 border">Register</button>
          </div>
          <div class="text-sm muted">Welcome ‚Äî choose Login or Register</div>
        </div>

        <!-- Container -->
        <div id="forms" class="mt-2">

          <!-- LOGIN -->
          <form id="loginForm" class="space-y-4">
            <!-- role select on top -->
            <div>
              <label for="loginRole" class="text-sm font-medium block mb-1">Select role</label>
              <select id="loginRole" class="w-full border rounded-lg px-3 py-2 focus:outline-none">
                <option value="Customer">Customer</option>
                <option value="Agent">Agent</option>
                <option value="Admin">Admin</option>
                <option value="SuperAdmin">Super Admin</option>
              </select>
            </div>

            <!-- name -->
            <div>
              <label for="loginName" class="text-sm font-medium block mb-1">Name</label>
              <input id="loginName" type="text" placeholder="Your full name" class="w-full border rounded-lg px-3 py-2 focus:outline-none" required>
            </div>

            <!-- password with icon inside -->
            <div class="input-with-icon">
              <label for="loginPassword" class="text-sm font-medium block mb-1">Password</label>
              <input id="loginPassword" type="password" placeholder="Password" class="w-full border rounded-lg px-3 py-2 pr-10 focus:outline-none" required>
              <span id="loginToggle" class="input-icon text-gray-600" title="Toggle password">üëÅÔ∏è</span>
            </div>

            <div class="flex items-center justify-between">
              <button type="button" id="forgotBtn" class="text-sm text-red-700 hover:underline">Forgot password?</button>
              <button type="submit" class="bg-red-600 text-white rounded-btn px-6 py-2 font-semibold">Login</button>
            </div>

            <p id="loginError" class="text-sm text-red-600"></p>
          </form>

          <!-- REGISTER -->
          <form id="registerForm" class="hidden space-y-4">
            <!-- role select at top (populated from backend flags) -->
            <div>
              <label for="registerRole" class="text-sm font-medium block mb-1">Select role</label>
              <select id="registerRole" class="w-full border rounded-lg px-3 py-2 focus:outline-none">
                <!-- options added by JS after fetching /api/public/flags -->
                <option value="Customer">Customer</option>
                <option value="Agent">Agent</option>
                <!-- Admin and SuperAdmin may be included dynamically -->
              </select>
            </div>

            <div>
              <label for="registerName" class="text-sm font-medium block mb-1">Full name</label>
              <input id="registerName" type="text" placeholder="Full name" class="w-full border rounded-lg px-3 py-2 focus:outline-none" required>
            </div>

            <div>
              <label for="registerEmail" class="text-sm font-medium block mb-1">Email</label>
              <input id="registerEmail" type="email" placeholder="Email address" class="w-full border rounded-lg px-3 py-2 focus:outline-none" required>
            </div>

            <div class="input-with-icon">
              <label for="registerPassword" class="text-sm font-medium block mb-1">Password</label>
              <input id="registerPassword" type="password" placeholder="Create password" class="w-full border rounded-lg px-3 py-2 pr-10 focus:outline-none" required>
              <span id="registerToggle" class="input-icon text-gray-600" title="Toggle password">üëÅÔ∏è</span>
            </div>

            <!-- Agent/Admin extra bank fields -->
            <div id="bankBlock" class="hidden space-y-2">
              <p class="text-sm muted">Account details (required for Agent/Admin)</p>
              <input id="bankName" type="text" placeholder="Bank name" class="w-full border rounded-lg px-3 py-2 focus:outline-none">
              <input id="accountNumber" type="text" placeholder="Account number" class="w-full border rounded-lg px-3 py-2 focus:outline-none">
              <input id="accountHolderName" type="text" placeholder="Account holder name" class="w-full border rounded-lg px-3 py-2 focus:outline-none">
              <input id="phone" type="text" placeholder="Phone number" class="w-full border rounded-lg px-3 py-2 focus:outline-none">
            </div>

            <div class="flex items-center justify-between">
              <button type="button" id="toLoginFromRegister" class="text-sm text-gray-600 hover:underline">Already have an account?</button>
              <button type="submit" class="bg-red-600 text-white rounded-btn px-6 py-2 font-semibold">Register</button>
            </div>

            <p id="registerError" class="text-sm text-red-600"></p>
            <p id="registerSuccess" class="text-sm text-green-600"></p>
          </form>

          <!-- Forgot password pane -->
          <div id="forgotPane" class="hidden">
            <div class="space-y-4">
              <p class="muted text-sm">Enter your email to receive a reset link.</p>
              <input id="forgotEmail" type="email" placeholder="Your email" class="w-full border rounded-lg px-3 py-2 focus:outline-none">
              <div class="flex items-center justify-between">
                <button id="forgotBack" class="text-sm text-gray-600 hover:underline">Back</button>
                <button id="sendReset" class="bg-red-600 text-white rounded-btn px-6 py-2 font-semibold">Send Reset Link</button>
              </div>
              <p id="forgotMsg" class="text-sm"></p>
            </div>
          </div>

        </div>
      </div>

      <!-- small footer -->
      <p class="text-center muted mt-4 text-sm">¬© <span id="year"></span> SkyUltimate. All rights reserved.</p>
    </div>
  </div>

  <script>
    // ============= CONFIG =============
    const API_BASE = "https://skyultimate-backend-api-structure.onrender.com/api"; // change if needed

    // helper: robust fetch handling JSON and non-JSON (HTML) errors
    async function apiFetch(path, opts = {}) {
      const token = localStorage.getItem("su_token");
      const headers = opts.headers || {};
      headers["Content-Type"] = "application/json";
      if (token) headers["Authorization"] = `Bearer ${token}`;

      let res;
      try {
        res = await fetch(API_BASE + path, { ...opts, headers });
      } catch (err) {
        throw new Error("Network error: " + err.message);
      }

      // Read text first to avoid JSON parse errors when server returned HTML (error pages)
      const text = await res.text();
      // attempt parse
      let data = null;
      try {
        data = text ? JSON.parse(text) : null;
      } catch (e) {
        // not JSON
        if (!res.ok) {
          console.error("Server non-JSON response:", text.slice(0, 1000));
          throw new Error(`Server returned an error page (status ${res.status}). Check server logs or console.`);
        }
        // OK but no JSON - return raw text
        return text;
      }

      if (!res.ok) {
        const errMsg = (data && (data.message || data.error)) || `API Error: ${res.status}`;
        throw new Error(errMsg);
      }
      return data;
    }

    // ============= UI refs =============
    const splash = document.getElementById('splash');
    const authWrap = document.getElementById('authWrap');
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');

    const loginForm = document.getElementById('loginForm');
    const loginRole = document.getElementById('loginRole');
    const loginName = document.getElementById('loginName');
    const loginPassword = document.getElementById('loginPassword');
    const loginToggle = document.getElementById('loginToggle');
    const loginError = document.getElementById('loginError');

    const registerForm = document.getElementById('registerForm');
    const registerRole = document.getElementById('registerRole');
    const registerName = document.getElementById('registerName');
    const registerEmail = document.getElementById('registerEmail');
    const registerPassword = document.getElementById('registerPassword');
    const registerToggle = document.getElementById('registerToggle');
    const bankBlock = document.getElementById('bankBlock');
    const bankName = document.getElementById('bankName');
    const accountNumber = document.getElementById('accountNumber');
    const accountHolderName = document.getElementById('accountHolderName');
    const phone = document.getElementById('phone');
    const registerError = document.getElementById('registerError');
    const registerSuccess = document.getElementById('registerSuccess');

    const toLoginFromRegister = document.getElementById('toLoginFromRegister');

    const forgotBtn = document.getElementById('forgotBtn');
    const forgotPane = document.getElementById('forgotPane');
    const forgotBack = document.getElementById('forgotBack');
    const forgotEmail = document.getElementById('forgotEmail');
    const sendReset = document.getElementById('sendReset');
    const forgotMsg = document.getElementById('forgotMsg');

    const yearEl = document.getElementById('year');
    yearEl.textContent = new Date().getFullYear();

    // ============= startup: splash then show auth =============
    window.addEventListener('load', async () => {
      // fetch flags to populate registration dropdown (we do this now to reduce delay)
      try {
        fetchFlagsAndPopulate();
      } catch (e) {
        console.warn("Could not fetch flags yet:", e.message);
      }

      setTimeout(() => {
        splash.classList.add('hidden');
        authWrap.classList.remove('hidden');
      }, 3000);
    });

    // ============= flags -> registration dropdown =============
    async function fetchFlagsAndPopulate() {
      try {
        const flags = await apiFetch('/public/flags', { method: 'GET' });
        // clear registerRole options then fill based on flags
        const existing = Array.from(registerRole.options).map(o => o.value.toLowerCase());
        // keep Customer and Agent always present
        registerRole.innerHTML = '';
        registerRole.add(new Option('Customer', 'Customer'));
        registerRole.add(new Option('Agent', 'Agent'));

        if (flags.adminRegistrationEnabled) {
          registerRole.add(new Option('Admin', 'Admin'));
        }
        if (flags.allowSuperAdminRegistration) {
          // allow super admin to register if this is the first user
          registerRole.add(new Option('SuperAdmin', 'SuperAdmin'));
        }
      } catch (e) {
        console.warn("Flags fetch failed:", e.message);
        // fallback: keep default options (Customer + Agent)
        registerRole.innerHTML = '';
        registerRole.add(new Option('Customer', 'Customer'));
        registerRole.add(new Option('Agent', 'Agent'));
      }
    }

    // ============= tab switching =============
    function showLogin() {
      tabLogin.classList.remove('bg-white', 'text-gray-700');
      tabLogin.classList.add('bg-red-600', 'text-white');
      tabRegister.classList.remove('bg-red-600', 'text-white');
      tabRegister.classList.add('bg-white', 'text-gray-700');

      loginForm.classList.remove('hidden');
      registerForm.classList.add('hidden');
      forgotPane.classList.add('hidden');
      // clear messages
      loginError.textContent = '';
      registerError.textContent = '';
      registerSuccess.textContent = '';
    }
    function showRegister() {
      tabRegister.classList.remove('bg-white', 'text-gray-700');
      tabRegister.classList.add('bg-red-600', 'text-white');
      tabLogin.classList.remove('bg-red-600', 'text-white');
      tabLogin.classList.add('bg-white', 'text-gray-700');

      registerForm.classList.remove('hidden');
      loginForm.classList.add('hidden');
      forgotPane.classList.add('hidden');
      loginError.textContent = '';
      registerError.textContent = '';
      registerSuccess.textContent = '';
    }

    tabLogin.addEventListener('click', showLogin);
    tabRegister.addEventListener('click', async () => {
      await fetchFlagsAndPopulate();
      showRegister();
    });

    // switch to login from register link
    toLoginFromRegister.addEventListener('click', () => {
      showLogin();
    });

    // ============= password toggles ============
    loginToggle.addEventListener('click', () => {
      loginPassword.type = loginPassword.type === 'password' ? 'text' : 'password';
    });
    registerToggle.addEventListener('click', () => {
      registerPassword.type = registerPassword.type === 'password' ? 'text' : 'password';
    });

    // show/hide bank block when role is Agent or Admin
    registerRole.addEventListener('change', () => {
      const r = registerRole.value;
      if (r === 'Agent' || r === 'Admin') bankBlock.classList.remove('hidden');
      else bankBlock.classList.add('hidden');
    });

    // ============= Forgot password UI handlers ============
    forgotBtn.addEventListener('click', () => {
      loginForm.classList.add('hidden');
      registerForm.classList.add('hidden');
      forgotPane.classList.remove('hidden');
    });
    forgotBack.addEventListener('click', () => {
      showLogin();
    });
    sendReset.addEventListener('click', async () => {
      forgotMsg.textContent = '';
      const email = forgotEmail.value.trim();
      if (!email) { forgotMsg.textContent = 'Enter your email'; forgotMsg.className = 'text-sm text-red-600'; return; }
      try {
        await apiFetch('/auth/forgot-password', {
          method: 'POST',
          body: JSON.stringify({ email }),
        });
        forgotMsg.textContent = 'A password reset link has been sent to your email.';
        forgotMsg.className = 'text-sm text-green-600';
      } catch (err) {
        forgotMsg.textContent = err.message || 'Failed to send reset link';
        forgotMsg.className = 'text-sm text-red-600';
      }
    });

    // ============= REGISTER handler ============
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      registerError.textContent = '';
      registerSuccess.textContent = '';

      const name = registerName.value.trim();
      const email = registerEmail.value.trim();
      const password = registerPassword.value;
      const role = registerRole.value;
      const payload = { name, email, password, role };

      if (role === 'Agent' || role === 'Admin') {
        const bName = bankName.value.trim(), acct = accountNumber.value.trim(), acctName = accountHolderName.value.trim();
        if (!bName || !acct || !acctName) {
          registerError.textContent = 'Bank details are required for Agents and Admins';
          return;
        }
        // some backends expect nested bankDetails or flat keys; include both styles
        payload.bankDetails = { bankName: bName, accountNumber: acct, accountHolderName: acctName };
        payload.bankName = bName;
        payload.accountNumber = acct;
        payload.accountHolderName = acctName;
        if (phone.value.trim()) payload.phone = phone.value.trim();
      }

      // basic client validation
      if (!name || !email || !password) {
        registerError.textContent = 'Please fill all required fields';
        return;
      }

      try {
        const res = await apiFetch('/auth/register', {
          method: 'POST',
          body: JSON.stringify(payload),
        });

        // success ‚Äî switch to login tab and prefill name
        registerSuccess.textContent = 'Registration successful. Please login.';
        registerSuccess.className = 'text-sm text-green-600';
        // prefill login name
        loginName.value = name;
        // switch to login view
        showLogin();
      } catch (err) {
        console.error("Register error:", err);
        registerError.textContent = err.message || 'Registration failed';
      }
    });

    // ============= LOGIN handler (by name + password) ============
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.textContent = '';

      const role = loginRole.value;
      const name = loginName.value.trim();
      const password = loginPassword.value;

      if (!name || !password) {
        loginError.textContent = 'All fields required';
        return;
      }
            try {
        // auth route expects { name, password } (role optional)
        const res = await apiFetch('/auth/login', {
          method: 'POST',
          body: JSON.stringify({ name, password }),
        });

        // res should contain token and user info
        if (res.token) {
          localStorage.setItem('su_token', res.token);
          localStorage.setItem('su_user', JSON.stringify(res.user || { name: res.name, role: res.role }));
          // redirect to homepage ‚Äî role-specific navigation happens from home.html via action buttons
          window.location.href = 'home.html';
        } else {
          loginError.textContent = res.message || 'Login failed';
        }
      } catch (err) {
        console.error("Login error:", err);
        loginError.textContent = err.message || 'Invalid name or password';
      }
    });

    // populate login role select with all roles (login should allow SuperAdmin)
    (function initLoginRoles() {
      loginRole.innerHTML = '';
      ['Customer', 'Agent', 'Admin', 'SuperAdmin'].forEach(r => {
        loginRole.add(new Option(r, r));
      });
    })();

    // Extra: try to fetch flags again periodically so admin toggles become available while user is on register tab
    setInterval(fetchFlagsAndPopulate, 30 * 1000); // every 30s

  </script>
</body>
</html>


      

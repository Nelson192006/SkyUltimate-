<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SkyUltimate ‚Ä¢ Login & Registration</title>
  <style>
    /* ============ RESET / BASE ============ */
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Arial, sans-serif; }
    html, body { height:100%; background:#C00000; }
    a { color:inherit; text-decoration:none; }
    button { cursor:pointer; border:none; outline:none; }

    /* ============ SPLASH ============ */
    #splash {
      position:fixed; inset:0; background:#C00000;
      display:flex; align-items:center; justify-content:center;
      transition:opacity .6s ease, visibility .6s ease;
      z-index:9999;
    }
    #splash img { width:140px; height:140px; border-radius:50%; opacity:0; transform:scale(.96); animation:logoFade 800ms ease forwards 400ms; }
    @keyframes logoFade { to { opacity:1; transform:scale(1); } }
    .hidden { opacity:0; visibility:hidden; }

    /* ============ PAGE LAYOUT ============ */
    #container {
      width:100%; min-height:100%;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:24px 16px;
      position:relative;
    }

    /* Logo above card (keeps brand continuity from splash) */
    #brand { display:flex; flex-direction:column; align-items:center; margin-bottom:14px; }
    #brand img { width:96px; height:96px; border-radius:50%; margin-bottom:10px; }
    #brand h1 { color:#fff; font-size:1.1rem; font-weight:600; opacity:.95; }

    /* ============ AUTH CARD ============ */
    .card {
      width:100%; max-width:460px; background:#fff; color:#C00000;
      border-radius:16px; padding:18px 18px 22px; box-shadow:0 8px 30px rgba(0,0,0,.25);
      transition:opacity .35s ease, transform .35s ease;
    }
    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tab {
      flex:1; text-align:center; padding:10px 14px; border-radius:10px;
      background:#f2f2f2; color:#C00000; font-weight:700;
    }
    .tab.active { background:#C00000; color:#fff; }
    .hint { font-size:.85rem; color:#7a7a7a; margin:6px 2px 10px; }

    .form-group { margin-bottom:12px; }
    label { display:block; margin-bottom:6px; font-weight:700; color:#9b0000; }
    input, select, textarea {
      width:100%; padding:12px; border-radius:10px; border:1px solid #ddd; outline:none;
      transition:border-color .2s ease, box-shadow .2s ease;
    }
    input:focus, select:focus, textarea:focus { border-color:#C00000; box-shadow:0 0 0 3px rgba(192,0,0,.1); }
    .pwd-wrap { position:relative; }
    .toggle-eye {
      position:absolute; right:10px; top:50%; transform:translateY(-50%);
      font-size:1rem; color:#C00000; opacity:.8; cursor:pointer; user-select:none;
    }

    .btn-primary {
      width:100%; padding:13px 16px; border-radius:12px; background:#C00000; color:#fff; font-weight:800;
      transition:filter .2s ease, transform .02s ease;
    }
    .btn-primary:active { transform:scale(.995); }
    .btn-primary:disabled { background:#bbb; cursor:not-allowed; }

    .row { display:flex; justify-content:space-between; align-items:center; margin-top:8px; }
    .row a { font-size:.9rem; color:#C00000; font-weight:700; }

    .error { margin-top:8px; color:#b00020; background:#ffe8ec; padding:8px 10px; border-radius:8px; font-size:.9rem; display:none; }
    .success { margin-top:8px; color:#0b7a2a; background:#e8ffee; padding:8px 10px; border-radius:8px; font-size:.9rem; display:none; }

    /* ============ MODALS (Forgot Password) ============ */
    .modal {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); z-index:10000;
    }
    .modal .modal-content {
      width:92%; max-width:420px; background:#fff; color:#C00000; border-radius:16px; padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      animation:pop .15s ease;
    }
    @keyframes pop { from { transform:scale(.98); opacity:.7; } to { transform:scale(1); opacity:1; } }
    .modal .actions { display:flex; gap:10px; margin-top:10px; }
    .btn-ghost { flex:1; padding:11px; border-radius:12px; background:#f2f2f2; color:#C00000; font-weight:800; }
    .btn-danger { flex:1; padding:11px; border-radius:12px; background:#C00000; color:#fff; font-weight:800; }

    /* ============ RESPONSIVE ============ */
    @media (max-width:480px){
      #brand img { width:82px; height:82px; }
      .card { border-radius:14px; padding:14px 14px 18px; }
    }
  </style>
</head>
<body>
  <!-- SPLASH -->
  <div id="splash">
    <img src="https://raw.githubusercontent.com/Nelson192006/SkyUltimate-/fdf409b0e40dfbd432afd277b20ddb8965600fc7/logo.png" alt="SkyUltimate Logo"/>
  </div>

  <!-- UNAUTH CONTAINER -->
  <div id="container" style="opacity:0; transform:translateY(8px); transition:opacity .5s ease .1s, transform .5s ease .1s;">
    <div id="brand">
      <img src="https://raw.githubusercontent.com/Nelson192006/SkyUltimate-/fdf409b0e40dfbd432afd277b20ddb8965600fc7/logo.png" alt="Logo"/>
      <h1>Welcome to SkyUltimate</h1>
    </div>

    <div class="card" id="authCard">
      <!-- Tabs -->
      <div class="tabs" role="tablist" aria-label="Authentication">
        <button class="tab active" id="tabLogin" aria-selected="true">Login</button>
        <button class="tab" id="tabRegister" aria-selected="false">Register</button>
      </div>

      <!-- LOGIN -->
      <form id="loginForm" autocomplete="on" novalidate>
        <div class="form-group">
          <label for="loginRole">Role</label>
          <select id="loginRole" required>
            <option value="">Select your role</option>
            <option value="customer">Customer</option>
            <option value="agent">Agent</option>
            <option value="admin" id="loginAdminOpt">Admin</option>
            <option value="superadmin" id="loginSuperOpt">Super-Admin</option>
          </select>
        </div>
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input id="loginEmail" type="email" placeholder="name@email.com" required/>
        </div>
        <div class="form-group pwd-wrap">
          <label for="loginPassword">Password</label>
          <input id="loginPassword" type="password" placeholder="Enter password" required/>
          <span class="toggle-eye" data-target="loginPassword">üëÅÔ∏è</span>
        </div>
        <button class="btn-primary" id="loginBtn" type="submit">Login</button>
        <div class="row">
          <span class="hint">Forgot your password?</span>
          <a href="#" id="forgotLink">Reset it</a>
        </div>
        <div class="error" id="loginError"></div>
      </form>

      <!-- REGISTER -->
      <form id="registerForm" style="display:none;" autocomplete="on" novalidate>
        <div class="hint">Select role first ‚Äî fields may change based on your selection.</div>
        <div class="form-group">
          <label for="regRole">Register as</label>
          <select id="regRole" required>
            <option value="">Choose role</option>
            <option value="customer">Customer</option>
            <option value="agent">Agent</option>
            <option value="admin" id="regAdminOpt">Admin</option>
            <option value="superadmin" id="regSuperOpt">Super-Admin (first time only)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="regName">Full Name</label>
          <input id="regName" type="text" placeholder="Full Name" required/>
        </div>

        <div class="form-group">
          <label for="regEmail">Email</label>
          <input id="regEmail" type="email" placeholder="name@email.com" required/>
        </div>

        <div class="form-group pwd-wrap">
          <label for="regPassword">Password (min 6 chars)</label>
          <input id="regPassword" type="password" placeholder="Create password" minlength="6" required/>
          <span class="toggle-eye" data-target="regPassword">üëÅÔ∏è</span>
        </div>

        <!-- Role-conditional fields go here -->
        <div id="roleExtra"></div>

        <button class="btn-primary" id="registerBtn" type="submit">Create Account</button>
        <div class="error" id="registerError"></div>
        <div class="success" id="registerSuccess"></div>
      </form>
    </div>
  </div>

  <!-- FORGOT PASSWORD MODAL -->
  <div class="modal" id="forgotModal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="fpTitle">
      <h3 id="fpTitle">Reset your password</h3>
      <p class="hint">Enter your account email. We‚Äôll send a password reset link.</p>
      <div class="form-group">
        <label for="fpEmail">Email</label>
        <input id="fpEmail" type="email" placeholder="name@email.com" />
      </div>
      <div class="actions">
        <button class="btn-ghost" id="fpCancel">Cancel</button>
        <button class="btn-danger" id="fpSend">Send Reset Link</button>
      </div>
      <div class="error" id="fpError"></div>
      <div class="success" id="fpSuccess"></div>
    </div>
  </div>

  <script>
    /* ================= CONFIG ================= */
    const API = 'https://skyultimate-backend-api-structure.onrender.com';
    // If your backend uses different routes for these 2 checks, just change them here:
    const SUPER_CHECK_URL = API + '/check-for-super-admin';               // -> { exists: boolean }
    const ADMIN_ENABLE_URL = API + '/config/admin-registration-enabled'; // -> { enabled: boolean }

    /* ================= SPLASH FLOW ================= */
    const splash = document.getElementById('splash');
    const container = document.getElementById('container');
    // Cross-fade after 3 seconds (preload perception)
    window.addEventListener('load', () => {
      setTimeout(() => {
        splash.classList.add('hidden');
        container.style.opacity = '1';
        container.style.transform = 'translateY(0)';
      }, 3000);
      // Pre-check flags while splash is visible
      initRoleAvailability();
    });

    /* ================= UI HELPERS ================= */
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    // Tabs
    const tabLogin = $('#tabLogin');
    const tabRegister = $('#tabRegister');
    const loginForm = $('#loginForm');
    const registerForm = $('#registerForm');

    tabLogin.addEventListener('click', () => {
      tabLogin.classList.add('active'); tabRegister.classList.remove('active');
      loginForm.style.display = 'block'; registerForm.style.display = 'none';
    });
    tabRegister.addEventListener('click', () => {
      tabRegister.classList.add('active'); tabLogin.classList.remove('active');
      registerForm.style.display = 'block'; loginForm.style.display = 'none';
    });

    // Password visibility toggles
    $$('.toggle-eye').forEach(el => {
      el.addEventListener('click', () => {
        const id = el.dataset.target;
        const input = document.getElementById(id);
        input.type = input.type === 'password' ? 'text' : 'password';
      });
    });

    /* ================= DYNAMIC ROLE VISIBILITY =================
       - Hide Super-Admin if one already exists
       - Hide Admin registration unless Super-Admin enabled it
    ============================================================ */
    async function initRoleAvailability(){
      try {
        // Check if Super-Admin exists already
        const sRes = await fetch(SUPER_CHECK_URL);
        const sJson = await sRes.json();
        const superExists = !!(sJson && (sJson.exists === true || sJson.hasSuperAdmin === true));

        // Hide/show Super-Admin option
        const superLoginOpt = $('#loginSuperOpt');
        const superRegOpt   = $('#regSuperOpt');
        if (superExists) {
          if (superLoginOpt) superLoginOpt.remove(); // Super-Admin still can login via role? If you want to keep login, comment this out.
          if (superRegOpt) superRegOpt.remove();     // Registration for Super-Admin disappears forever after first one
        }

        // Check if Admin registration is enabled
        const aRes = await fetch(ADMIN_ENABLE_URL);
        const aJson = await aRes.json();
        const adminEnabled = !!(aJson && (aJson.enabled === true));
        const adminRegOpt = $('#regAdminOpt');
        if (!adminEnabled && adminRegOpt) adminRegOpt.remove();

      } catch(err){
        // Fail-safe: leave all options visible if checks fail, but log it.
        console.warn('Role availability checks failed:', err);
      }
    }

    /* ================= AUTH FLOWS ================= */
    const loginBtn = $('#loginBtn');
    const loginError = $('#loginError');

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.style.display = 'none';
      const role = $('#loginRole').value.trim();
      const email = $('#loginEmail').value.trim();
      const password = $('#loginPassword').value;

      if (!role || !email || !password) {
        showError(loginError, 'Please fill in all fields (including Role).');
        return;
      }

      try {
        const res = await fetch(API + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ role, email, password })
        });
        const json = await res.json();

        if (!res.ok) {
          showError(loginError, json?.message || 'Invalid credentials. Please check your role and details.');
          return;
        }

        // Save session
        sessionStorage.setItem('token', json.token);
        sessionStorage.setItem('role', json.user?.role || role);
        sessionStorage.setItem('name', json.user?.name || '');
        sessionStorage.setItem('email', json.user?.email || email);

        // Go to universal home (your existing home.html)
        window.location.href = 'home.html';
      } catch (err){
        showError(loginError, 'Network error. Please try again.');
      }
    });

    // Registration
    const regRole = $('#regRole');
    const roleExtra = $('#roleExtra');
    const registerError = $('#registerError');
    const registerSuccess = $('#registerSuccess');

    // Conditionally render extra fields by role (purely frontend UX)
    const renderRoleFields = (role) => {
      roleExtra.innerHTML = '';
      if (!role) return;

      if (role === 'agent') {
        roleExtra.innerHTML = `
          <div class="form-group">
            <label for="regPhone">Phone Number</label>
            <input id="regPhone" type="tel" placeholder="e.g. 0912 888 4830" required/>
          </div>
          <div class="form-group">
            <label for="regVehicle">Vehicle / Delivery Method</label>
            <input id="regVehicle" type="text" placeholder="Bike / Car / Foot, etc." required/>
          </div>
          <div class="form-group">
            <label for="regBank">Payout Bank Details</label>
            <textarea id="regBank" placeholder="Bank Name, Account Number"></textarea>
          </div>
        `;
      } else if (role === 'admin') {
        roleExtra.innerHTML = `
          <div class="form-group">
            <label for="regAdminCode">Admin Invite/Code (if required)</label>
            <input id="regAdminCode" type="text" placeholder="Optional unless your policy requires it"/>
          </div>
        `;
      } else if (role === 'superadmin') {
        roleExtra.innerHTML = `
          <div class="form-group">
            <label>One-Time Super-Admin Setup</label>
            <div class="hint">This will create the first and only Super-Admin. After this, the option disappears.</div>
          </div>
        `;
      }
    };
    regRole.addEventListener('change', () => renderRoleFields(regRole.value));

    $('#registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      registerError.style.display = 'none';
      registerSuccess.style.display = 'none';

      const role = $('#regRole').value.trim();
      const name = $('#regName').value.trim();
      const email = $('#regEmail').value.trim();
      const password = $('#regPassword').value;

      if (!role || !name || !email || !password) {
        showError(registerError, 'Please complete all required fields.');
        return;
      }
      if (password.length < 6) {
        showError(registerError, 'Password must be at least 6 characters.');
        return;
      }

      // Collect optional extras
      const extras = {};
      if (role === 'agent') {
        extras.phone = ($('#regPhone')?.value || '').trim();
        extras.vehicle = ($('#regVehicle')?.value || '').trim();
        extras.bank = ($('#regBank')?.value || '').trim();
      }
      if (role === 'admin') {
        extras.adminCode = ($('#regAdminCode')?.value || '').trim();
      }

      try {
        const res = await fetch(API + '/auth/register', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ role, name, email, password, ...extras })
        });
        const json = await res.json();

        if (!res.ok) {
          // Common: email exists, role disabled, etc.
          showError(registerError, json?.message || 'Registration failed.');
          return;
        }

        // Success UX: either auto-login or ask user to login
        showSuccess(registerSuccess, 'Registration successful! You can now log in.');
        // If your backend returns token/user on register and you want auto-login:
        // sessionStorage.setItem('token', json.token);
        // sessionStorage.setItem('role', json.user?.role || role);
        // sessionStorage.setItem('name', json.user?.name || name);
        // sessionStorage.setItem('email', json.user?.email || email);
        // window.location.href = 'home.html';

        // Return to login tab automatically after a short delay
        setTimeout(() => { tabLogin.click(); }, 1200);

        // If this was Super-Admin registration, hide the option forever (frontend)
        if (role === 'superadmin') {
          $('#regSuperOpt')?.remove();
          $('#loginSuperOpt')?.remove(); // if you DO want Super-Admin to still login via role, comment this line
        }
      } catch (err){
        showError(registerError, 'Network error. Please try again.');
      }
    });

    /* ================= FORGOT PASSWORD ================= */
    const forgotModal = $('#forgotModal');
    const forgotLink = $('#forgotLink');
    const fpCancel = $('#fpCancel');
    const fpSend = $('#fpSend');
    const fpEmail = $('#fpEmail');
    const fpError = $('#fpError');
    const fpSuccess = $('#fpSuccess');

    const openForgot = () => { forgotModal.style.display = 'flex'; fpError.style.display='none'; fpSuccess.style.display='none'; fpEmail.value=''; };
    const closeForgot = () => { forgotModal.style.display = 'none'; };

    forgotLink.addEventListener('click', (e) => { e.preventDefault(); openForgot(); });
    fpCancel.addEventListener('click', closeForgot);
    forgotModal.addEventListener('click', (e) => { if(e.target === forgotModal) closeForgot(); });

    fpSend.addEventListener('click', async () => {
      fpError.style.display='none'; fpSuccess.style.display='none';
      const email = fpEmail.value.trim();
      if(!email){ showError(fpError, 'Please enter your email.'); return; }

      try {
        const res = await fetch(API + '/auth/forgot-password', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ email })
        });
        const json = await res.json();
        if(!res.ok){
          showError(fpError, json?.message || 'Unable to send reset email.');
          return;
        }
        showSuccess(fpSuccess, 'Password reset link sent! Check your email.');
      } catch (err){
        showError(fpError, '

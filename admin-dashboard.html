<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:Arial,sans-serif; }
  body, html { min-height:100vh; background-color:#C00000; color:white; }
  #container { max-width:1000px; margin:auto; padding:20px; }
  #logo { width:140px; height:140px; border-radius:50%; display:block; margin:20px auto; }
  h2 { text-align:center; margin-bottom:20px; }

  .section { background: rgba(255,255,255,0.95); color: #C00000; padding:20px; border-radius:12px; margin-bottom:20px; }

  input, select, textarea { width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc; }

  button { padding:10px 15px; border:none; border-radius:8px; background:#C00000; color:white; cursor:pointer; margin-right:5px; }
  button:disabled { background: grey; cursor:not-allowed; }

  .list-item { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #ccc; }

  /* Hamburger menu */
  #hamburger { position:absolute; top:20px; left:20px; font-size:30px; cursor:pointer; }
  #side-menu { position:fixed; top:0; left:-250px; width:250px; height:100%; background:#fff; color:#C00000;
    box-shadow:3px 0 10px rgba(0,0,0,0.3); transition:0.3s; padding-top:60px; z-index:100; }
  #side-menu a { display:block; padding:15px 20px; text-decoration:none; color:#C00000; font-weight:bold; }
  #side-menu a:hover { background:#f0f0f0; }

  /* Modal */
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:200;
    color:white; justify-content:center; align-items:center; padding:20px; overflow:auto; }
  .modal-content { background:white; color:#C00000; padding:20px; border-radius:10px; max-width:500px; width:100%; }
  .modal-content h3 { margin-bottom:15px; }
</style>
</head>
<body>

<div id="hamburger">&#9776;</div>
<div id="side-menu">
  <a href="#" onclick="showSection('live-dashboard')">Live Dashboard</a>
  <a href="#" onclick="showSection('user-lookup')">User Lookup</a>
  <a href="#" onclick="showSection('issue-center')">Issue Resolution Center</a>
  <a href="#" onclick="logout()">Logout</a>
</div>

<div id="container">
  <img id="logo" src="https://raw.githubusercontent.com/Nelson192006/SkyUltimate-/fdf409b0e40dfbd432afd277b20ddb8965600fc7/logo.png" alt="Logo">
  <h2>Operations Hub</h2>

  <!-- Sections -->
  <div id="live-dashboard" class="section">
    <h3>Live Orders</h3>
    <div id="orders-list"></div>
  </div>

  <div id="user-lookup" class="section" style="display:none;">
    <h3>User Lookup</h3>
    <input type="text" id="user-search" placeholder="Search by name or email">
    <div id="user-results"></div>
  </div>

  <div id="issue-center" class="section" style="display:none;">
    <h3>Open Tickets</h3>
    <div id="tickets-list"></div>
  </div>
</div>

<!-- Order Details Modal -->
<div id="order-modal" class="modal">
  <div class="modal-content">
    <h3>Order Details</h3>
    <div id="order-info"></div>
    <button onclick="closeModal('order-modal')">Close</button>
  </div>
</div>

<!-- Action Request Modal -->
<div id="action-modal" class="modal">
  <div class="modal-content">
    <h3>Request Action from Super Admin</h3>
    <select id="action-type">
      <option value="">Select Action Type</option>
      <option value="suspend">Suspend User</option>
      <option value="delete">Delete User</option>
    </select>
    <textarea id="action-reason" placeholder="Reason"></textarea>
    <button onclick="submitAction()">Submit Request</button>
    <button onclick="closeModal('action-modal')">Close</button>
  </div>
</div>

<!-- Ticket Modal -->
<div id="ticket-modal" class="modal">
  <div class="modal-content">
    <h3>Ticket Details</h3>
    <div id="ticket-info"></div>
    <button onclick="closeModal('ticket-modal')">Close</button>
  </div>
</div>

<script>
const API_BASE = 'https://skyultimate-backend-api-structure.onrender.com';
const token = sessionStorage.getItem('token');

// Hamburger toggle
const hamburger = document.getElementById('hamburger');
const sideMenu = document.getElementById('side-menu');
let menuOpen = false;
hamburger.onclick = () => {
  sideMenu.style.left = menuOpen ? '-250px' : '0';
  menuOpen = !menuOpen;
};

// Section switch
function showSection(id){
  ['live-dashboard','user-lookup','issue-center'].forEach(sec=>{
    document.getElementById(sec).style.display = sec===id?'block':'none';
  });
  if(id==='live-dashboard') fetchOrders();
  if(id==='user-lookup') document.getElementById('user-search').value='';
  if(id==='issue-center') fetchTickets();
}

// Fetch live orders
async function fetchOrders(){
  try {
    const res = await fetch(`${API_BASE}/orders`,{headers:{'Authorization':`Bearer ${token}`}});
    const orders = await res.json();
    const list = document.getElementById('orders-list');
    list.innerHTML='';
    orders.forEach(order=>{
      const div = document.createElement('div');
      div.className='list-item';
      div.innerHTML=`<span>${order.itemType} - ${order.weight}kg</span>`;
      const btn = document.createElement('button');
      btn.textContent='View Details';
      btn.onclick=()=> viewOrderDetails(order.id);
      div.appendChild(btn);
      list.appendChild(div);
    });
  } catch(err){ console.error(err); }
}

// View Order Modal
async function viewOrderDetails(orderId){
  try {
    const res = await fetch(`${API_BASE}/orders/${orderId}`,{headers:{'Authorization':`Bearer ${token}`}});
    const data = await res.json();
    document.getElementById('order-info').innerHTML = `
      <p>Item: ${data.itemType}</p>
      <p>Weight: ${data.weight}kg</p>
      <p>Pickup: ${data.pickup}</p>
      <p>Delivery: ${data.delivery}</p>
      <p>Status: ${data.status}</p>
    `;
    document.getElementById('order-modal').style.display='flex';
  } catch(err){ console.error(err); }
}

// User search
const userSearch = document.getElementById('user-search');
userSearch.addEventListener('input', async ()=>{
  const query = userSearch.value.trim();
  const resultsDiv = document.getElementById('user-results');
  if(!query){ resultsDiv.innerHTML=''; return; }
  try {
    const res = await fetch(`${API_BASE}/users/search?query=${query}`,{headers:{'Authorization':`Bearer ${token}`}});
    const users = await res.json();
    resultsDiv.innerHTML='';
    users.forEach(user=>{
      const div = document.createElement('div');
      div.className='list-item';
      div.innerHTML=`<span>${user.fullName} (${user.role})</span>`;
      const btn = document.createElement('button');
      btn.textContent='Request Action';
      btn.onclick=()=> showModalAction(user.id);
      div.appendChild(btn);
      resultsDiv.appendChild(div);
    });
  } catch(err){ console.error(err); }
});

// Show Action Modal
let actionUserId=null;
function showModalAction(userId){
  actionUserId=userId;
  document.getElementById('action-modal').style.display='flex';
}

// Submit Action
async function submitAction(){
  const type = document.getElementById('action-type').value;
  const reason = document.getElementById('action-reason').value.trim();
  if(!type||!reason){ alert('Please fill all fields'); return; }
  try{
    const res = await fetch(`${API_BASE}/admin/request-action`,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},
      body: JSON.stringify({userId:actionUserId,type,reason})
    });
    const data = await res.json();
    alert(data.message||'Request submitted');
    closeModal('action-modal');
  } catch(err){ console.error(err); }
}

// Issue Resolution
async function fetchTickets(){
  try{
    const res = await fetch(`${API_BASE}/tickets/open`,{headers:{'Authorization':`Bearer ${token}`}});
    const tickets = await res.json();
    const list = document.getElementById('tickets-list');
    list.innerHTML='';
    tickets.forEach(ticket=>{
      const div = document.createElement('div');
      div.className='list-item';
      div.innerHTML=`<span>${ticket.title}</span>`;
      const viewBtn = document.createElement('button');
      viewBtn.textContent='View Ticket';
      viewBtn.onclick=()=> viewTicket(ticket.id);
      const resolveBtn = document.createElement('button');
      resolveBtn.textContent='Mark as Resolved';
      resolveBtn.onclick=()=> markResolved(ticket.id, div);
      div.appendChild(viewBtn);
      div.appendChild(resolveBtn);
      list.appendChild(div);
    });
  } catch(err){ console.error(err); }
}

async function viewTicket(ticketId){
  try{
    const res = await fetch(`${API_BASE}/tickets/${ticketId}`,{headers:{'Authorization':`Bearer ${token}`}});
    const data = await res.json();
    document.getElementById('ticket-info').innerHTML = `<p>${data.history}</p>`;
    document.getElementById('ticket-modal').style.display='flex';
  } catch(err){ console.error(err); }
}

async function markResolved(ticketId, element){
  try{
    const res = await fetch(`${API_BASE}/tickets/resolve/${ticketId}`,{method:'POST',headers:{'Authorization':`Bearer ${token}`}});
    if(res.ok){ element.remove(); alert('Ticket marked resolved'); }
  } catch(err){ console.error(err); }
}

// Modal helpers
function closeModal(id){ document.getElementById(id).style.display='none'; }

function logout(){
  sessionStorage.clear();
  window.location.href='home.html';
}
</script>
</body>
</html>

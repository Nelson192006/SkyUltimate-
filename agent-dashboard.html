<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Dashboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
  body, html { min-height: 100vh; background-color: #C00000; color: white; }
  #container { max-width: 900px; margin: auto; padding: 20px; }
  #logo { width: 140px; height: 140px; border-radius: 50%; display: block; margin: 20px auto; }
  h2 { text-align: center; margin-bottom: 20px; }

  /* Toggle */
  .toggle-container { display:flex; justify-content:center; align-items:center; margin-bottom:20px; }
  .toggle-container label { margin:0 10px; font-weight:bold; }

  /* Job Card */
  .job-card { background:white; color:#C00000; padding:20px; border-radius:12px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; }
  .job-info { flex: 1; }
  .job-btn { padding: 10px 15px; border:none; border-radius:8px; background:#C00000; color:white; cursor:pointer; }

  /* Hamburger menu */
  #hamburger { position:absolute; top:20px; left:20px; font-size:30px; cursor:pointer; }
  #side-menu { position:fixed; top:0; left:-250px; width:250px; height:100%; background:#fff; color:#C00000;
    box-shadow:3px 0 10px rgba(0,0,0,0.3); transition:0.3s; padding-top:60px; z-index:100; }
  #side-menu a { display:block; padding:15px 20px; text-decoration:none; color:#C00000; font-weight:bold; }
  #side-menu a:hover { background:#f0f0f0; }

  /* Modal */
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:200;
    color:white; justify-content:center; align-items:center; padding:20px; }
  .modal-content { background:white; color:#C00000; padding:20px; border-radius:10px; max-width:400px; width:100%; }
  .modal-content h3 { margin-bottom:15px; }
  .modal-content button { margin-top:10px; }

</style>
</head>
<body>

<div id="hamburger">&#9776;</div>
<div id="side-menu">
  <a href="#" onclick="showOverlay('rate-customer')">Rate Customer</a>
  <a href="#" onclick="showOverlay('report-customer')">Report Customer</a>
  <a href="#" onclick="logout()">Logout</a>
</div>

<div id="container">
  <img id="logo" src="https://raw.githubusercontent.com/Nelson192006/SkyUltimate-/fdf409b0e40dfbd432afd277b20ddb8965600fc7/logo.png" alt="Logo">
  <h2>Delivery Board</h2>

  <div class="toggle-container">
    <label for="status-toggle">Status:</label>
    <select id="status-toggle">
      <option value="offline">OFFLINE</option>
      <option value="online">ONLINE</option>
    </select>
  </div>

  <div id="job-list"></div>
</div>

<!-- Rate Customer Modal -->
<div id="rate-customer" class="modal">
  <div class="modal-content">
    <h3>Rate Customer</h3>
    <select id="customer-rating">
      <option value="1">⭐</option>
      <option value="2">⭐⭐</option>
      <option value="3">⭐⭐⭐</option>
      <option value="4">⭐⭐⭐⭐</option>
      <option value="5">⭐⭐⭐⭐⭐</option>
    </select>
    <textarea id="customer-comment" placeholder="Comment (optional)" style="width:100%;margin-top:10px;"></textarea>
    <button onclick="submitRating()">Submit Rating</button>
    <button onclick="closeModal('rate-customer')">Close</button>
  </div>
</div>

<!-- Report Customer Modal -->
<div id="report-customer" class="modal">
  <div class="modal-content">
    <h3>Report Customer</h3>
    <textarea id="report-comment" placeholder="Describe the issue" style="width:100%;margin-top:10px;"></textarea>
    <button onclick="submitReport()">Submit Report</button>
    <button onclick="closeModal('report-customer')">Close</button>
  </div>
</div>

<script>
  const API_BASE = 'https://skyultimate-backend-api-structure.onrender.com';
  const token = sessionStorage.getItem('token');
  const jobList = document.getElementById('job-list');

  // Hamburger toggle
  const hamburger = document.getElementById('hamburger');
  const sideMenu = document.getElementById('side-menu');
  let menuOpen = false;
  hamburger.onclick = () => {
    sideMenu.style.left = menuOpen ? '-250px' : '0';
    menuOpen = !menuOpen;
  };

  // ONLINE/OFFLINE toggle
  const statusToggle = document.getElementById('status-toggle');
  let online = false;
  let jobPolling;

  statusToggle.addEventListener('change', () => {
    online = statusToggle.value === 'online';
    if(online){
      startPollingJobs();
      console.log('Agent is ONLINE, location updates activated');
    } else {
      stopPollingJobs();
      console.log('Agent is OFFLINE, location updates stopped');
    }
  });

  function startPollingJobs(){
    fetchJobs();
    jobPolling = setInterval(fetchJobs, 5000);
  }

  function stopPollingJobs(){
    clearInterval(jobPolling);
    jobList.innerHTML = '';
  }

  async function fetchJobs(){
    try {
      const res = await fetch(`${API_BASE}/orders/available`,{
        headers: {'Authorization':`Bearer ${token}`}
      });
      const jobs = await res.json();
      jobList.innerHTML = '';
      jobs.forEach(job => {
        const card = document.createElement('div');
        card.className = 'job-card';
        card.innerHTML = `<div class="job-info">
          <strong>${job.itemType}</strong> - ${job.weight}kg<br>
          Pickup: ${job.pickup}<br>
          Delivery: ${job.delivery}
        </div>`;
        const btn = document.createElement('button');
        btn.className='job-btn';
        btn.textContent='ACCEPT ORDER';
        btn.onclick = () => acceptOrder(job.id, card);
        card.appendChild(btn);
        jobList.appendChild(card);
      });
    } catch(err){ console.error(err); }
  }

  async function acceptOrder(orderId, card){
    try {
      const res = await fetch(`${API_BASE}/orders/claim/${orderId}`,{
        method:'POST',
        headers:{ 'Authorization':`Bearer ${token}` }
      });
      const data = await res.json();
      if(res.ok){
        alert('Order accepted! Switching to Active Delivery state...');
        card.innerHTML = `
          <div class="job-info">
            <strong>${data.itemType}</strong> - ${data.weight}kg<br>
            Pickup: ${data.pickup}<br>
            Delivery: ${data.delivery}
          </div>
          <button class="job-btn" onclick="startNavigation('${data.pickup}')">Start Navigation</button>
          <button class="job-btn" onclick="contactCustomer('${data.customerPhone}')">Contact Customer</button>
        `;
      } else {
        alert(data.message || 'Job already taken');
        card.remove();
      }
    } catch(err){ console.error(err); }
  }

  function startNavigation(address){
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      window.open(`https://www.google.com/maps/dir/?api=1&origin=${lat},${lng}&destination=${encodeURIComponent(address)}`,'_blank');
    });
  }

  function contactCustomer(phone){
    window.location.href = `tel:${phone}`;
  }

  // Modal helpers
  function showOverlay(id){ document.getElementById(id).style.display='flex'; }
  function closeModal(id){ document.getElementById(id).style.display='none'; }
  function submitRating(){ alert('Rating submitted'); closeModal('rate-customer'); }
  function submitReport(){ alert('Report submitted'); closeModal('report-customer'); }

  function logout(){
    sessionStorage.clear();
    window.location.href='home.html';
  }
</script>
</body>
                                     </html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SkyUltimate — Agent Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#C00000; }
    .card { background: rgba(255,255,255,0.95); border-radius: 12px; padding: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .btn { background:#C00000;color:#fff;padding:8px 12px;border-radius:10px;font-weight:600; }
    .muted { color:#6b7280; }
    .small { font-size:0.85rem; }
    .drawer { transform: translateX(-100%); transition: transform .25s ease; }
    .drawer.open { transform: translateX(0); }
    .modal-backdrop { background: rgba(0,0,0,0.45); }
  </style>
</head>
<body class="min-h-screen text-gray-900">

<header class="flex items-center justify-between px-4 py-3">
  <div class="flex items-center gap-3">
    <button id="menuBtn" class="p-2 rounded-md bg-white/10 text-white">☰</button>
    <img src="https://github.com/Nelson192006/SkyUltimate-/blob/62343ff3e5e556aa02ecece40e2c006fa9161c0a/logo.png?raw=true" alt="logo" class="w-14 h-14 object-contain">
    <div class="text-white">
      <div id="agentGreeting" class="font-bold text-lg">Hello, Agent</div>
      <div id="agentStatusText" class="text-sm muted">Offline</div>
    </div>
  </div>

  <div class="flex items-center gap-2">
    <label class="text-white small mr-2">Available</label>
    <input id="toggleAvailable" type="checkbox" />
    <button id="logoutBtn" class="text-white px-3 py-1 rounded bg-white/10">Logout</button>
  </div>
</header>

<!-- Drawer -->
<aside id="drawer" class="fixed left-0 top-0 bottom-0 w-72 p-4 drawer z-40">
  <div class="card">
    <div class="flex items-center justify-between mb-3">
      <div>
        <div id="drawerName" class="font-bold"></div>
        <div id="drawerRole" class="text-xs muted"></div>
      </div>
      <button id="closeDrawer">✕</button>
    </div>

    <nav class="space-y-2">
      <button id="navFeed" class="w-full text-left p-2 rounded hover:bg-gray-100">New Orders Feed</button>
      <button id="navActive" class="w-full text-left p-2 rounded hover:bg-gray-100">Active Delivery</button>
      <button id="navEarnings" class="w-full text-left p-2 rounded hover:bg-gray-100">Payouts & Earnings</button>
      <button id="navHistory" class="w-full text-left p-2 rounded hover:bg-gray-100">My History</button>
      <button id="navSupport" class="w-full text-left p-2 rounded hover:bg-gray-100">Contact Support</button>
    </nav>
    <div class="mt-4 text-xs muted">
      Contact: <a href="tel:+2349128884830" class="underline">09128884830</a><br/>
      Email: <a href="mailto:nelsongodspower24@gmail.com" class="underline">nelsongodspower24@gmail.com</a>
    </div>
  </div>
</aside>

<main class="max-w-4xl mx-auto px-4 pb-24">

  <!-- Live Feed -->
  <section id="feedSection" class="my-4">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-white text-xl font-bold">New Orders Feed</h2>
      <div class="text-sm text-white muted">Polling every 8s</div>
    </div>
    <div id="feedList" class="space-y-3"></div>
  </section>

  <!-- Active Order -->
  <section id="activeSection" class="my-4 hidden">
    <div class="card">
      <div class="flex justify-between items-start">
        <div>
          <h3 class="font-bold">Active Delivery</h3>
          <div id="activeId" class="small muted">Order: —</div>
        </div>
        <div id="activeFee" class="font-semibold text-lg">₦0</div>
      </div>

      <div class="mt-3 grid grid-cols-1 gap-2">
        <div><span class="muted small">Pickup:</span> <span id="activePickup"></span></div>
        <div><span class="muted small">Dropoff:</span> <span id="activeDropoff"></span></div>
        <div><span class="muted small">Item:</span> <span id="activeItem"></span></div>
      </div>

      <div class="mt-4 flex gap-2">
        <button id="navToPickup" class="btn">Start Navigation</button>
        <button id="callCustomer" class="border px-3 py-2 rounded">Call Customer</button>
        <button id="acceptComplete" class="bg-green-600 text-white px-3 py-2 rounded hidden">Mark Picked Up</button>
        <button id="markDelivered" class="bg-blue-600 text-white px-3 py-2 rounded hidden">Mark Delivered</button>
      </div>

      <div id="activeMapMsg" class="muted small mt-2">Live location reporting: <span id="locStatus">off</span></div>
    </div>
  </section>

  <!-- Earnings -->
  <section id="earningsSection" class="my-4 hidden">
    <div class="card">
      <h3 class="font-bold">Payouts & Earnings</h3>
      <div class="mt-3 small muted">Pending Payout: <span id="pendingPayout">₦0</span></div>
      <div class="mt-3" id="payoutList"></div>
      <div class="mt-3">
        <button id="editBank" class="border px-3 py-2 rounded">Update Bank Details</button>
      </div>
    </div>
  </section>

  <!-- History -->
  <section id="historySection" class="my-4 hidden">
    <div class="card">
      <h3 class="font-bold">My Delivery History</h3>
      <div id="agentHistory" class="mt-3 space-y-2 text-sm muted">Loading…</div>
    </div>
  </section>

</main>

<!-- Minimal modal for messages -->
<div id="modal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="modal-backdrop absolute inset-0"></div>
  <div class="card z-60 w-11/12 max-w-md">
    <div id="modalContent"></div>
    <div class="mt-4 text-right"><button id="modalClose" class="border px-3 py-1 rounded">Close</button></div>
  </div>
</div>

<script>
/*
  Agent-dashboard.html
  - API_BASE: your live backend
  - Expected auth: localStorage.su_token + localStorage.su_user (must be Agent)
  - Endpoints used (from your controllers):
    PUT  /api/users/agent/availability         (toggle online status)
    GET  /api/orders?status=PaymentConfirmed   (available unassigned orders feed)  <-- assumption (common pattern)
    POST /api/orders/:id/claim                 (claim order by agent)
    GET  /api/orders/:id                       (fetch single order status/details)
    PUT  /api/orders/:id/pickup                (confirm picked up)
    PUT  /api/orders/:id/deliver               (confirm delivered)
    GET  /api/orders?agentId=...               (agent's orders / history)
    GET  /api/payouts?agentId=...              (payout list, optional)
    POST /api/admin-requests                   (report / support) <-- best-effort
    POST /api/agents/location                  (location updates) <-- optional; implement server-side if desired
  - Polling strategy used for feed & active order (upgradeable to WebSocket later)
*/

const API_BASE = "https://skyultimate-backend-api-structure.onrender.com";
const token = localStorage.getItem('su_token');
const me = JSON.parse(localStorage.getItem('su_user') || 'null');
if (!token || !me || !['Agent','agent'].includes(me.role)) {
  alert('Agent authentication required. Redirecting to login.');
  localStorage.removeItem('su_token'); localStorage.removeItem('su_user');
  window.location.href = 'index.html';
}

// simple helpers
const X = id=>document.getElementById(id);
const feedList = X('feedList'), activeSection = X('activeSection'),
      earningsSection = X('earningsSection'), historySection = X('historySection'),
      activePickup = X('activePickup'), activeDropoff = X('activeDropoff'), activeItem = X('activeItem'),
      activeId = X('activeId'), activeFee = X('activeFee'), callCustomer = X('callCustomer'),
      navToPickup = X('navToPickup'), acceptComplete = X('acceptComplete'), markDelivered = X('markDelivered'),
      locStatus = X('locStatus'), pendingPayoutEl = X('pendingPayout'), payoutList = X('payoutList'),
      agentHistory = X('agentHistory'), drawer = document.getElementById('drawer');

X('drawerName').innerText = me.name || 'Agent';
X('drawerRole').innerText = me.role || 'Agent';
X('agentGreeting').innerText = `Hello, ${ (me.name||'').split(' ')[0] }`;

// auth wrapper
async function apiFetch(path, opts={}) {
  opts.headers = opts.headers || {};
  opts.headers['Content-Type'] = 'application/json';
  if (token) opts.headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(API_BASE + path, opts);
  if (res.status === 401) { alert('Session expired'); localStorage.clear(); window.location.href = 'index.html'; throw new Error('unauthorized'); }
  const json = await res.json().catch(()=>null);
  if (!res.ok) throw new Error((json && json.message) || 'Request failed');
  return json;
}

/* ---------- UI wiring ---------- */
document.getElementById('menuBtn').onclick = ()=> drawer.classList.toggle('open');
document.getElementById('closeDrawer').onclick = ()=> drawer.classList.remove('open');
X('navFeed').onclick = ()=> showSection('feed');
X('navActive').onclick = ()=> showSection('active');
X('navEarnings').onclick = ()=> showSection('earnings');
X('navHistory').onclick = ()=> showSection('history');
X('navSupport').onclick = ()=> openSupportPrompt();
X('logoutBtn').onclick = ()=> { localStorage.removeItem('su_token'); localStorage.removeItem('su_user'); window.location.href='index.html'; }

/* availability toggle */
const availableToggle = X('toggleAvailable');
availableToggle.checked = !!me.isAvailable;
updateStatusText(availableToggle.checked);
availableToggle.addEventListener('change', async ()=> {
  const online = availableToggle.checked;
  try {
    // your backend route exists: PUT /api/users/agent/availability
    const res = await apiFetch('/api/users/agent/availability', { method:'PUT', body: JSON.stringify({ online }) });
    updateStatusText(res.online);
    // update local copy
    me.isAvailable = !!res.online;
    localStorage.setItem('su_user', JSON.stringify(me));
  } catch (err) {
    alert('Could not update availability: ' + err.message);
    // revert toggle UI
    availableToggle.checked = !online;
    updateStatusText(availableToggle.checked);
  }
});
function updateStatusText(online) { X('agentStatusText').innerText = online ? 'Online' : 'Offline'; }

/* ---------- Feed (polling) ---------- */
let feedPolling = null;
async function loadFeed() {
  feedList.innerHTML = '<div class="muted small">Loading…</div>';
  try {
    // Common pattern: fetch unassigned orders ready for agents.
    // If your backend exposes a different route, change this path.
    const data = await apiFetch('/api/orders?status=PaymentConfirmed');
    const orders = Array.isArray(data) ? data : (data.orders || data.data || []);
    if (!orders || orders.length === 0) { feedList.innerHTML = '<div class="muted small">No available jobs right now.</div>'; return; }
    feedList.innerHTML = '';
    orders.forEach(o => feedList.appendChild(renderFeedItem(o)));
  } catch (e) {
    feedList.innerHTML = `<div class="muted small">Feed error: ${e.message}</div>`;
  }
}
function renderFeedItem(o) {
  const id = o._id || o.id;
  const el = document.createElement('div'); el.className='card flex justify-between items-start';
  const left = document.createElement('div');
  left.innerHTML = `<div class="font-semibold">Order ${String(id).slice(-6)}</div>
                    <div class="small muted">Pickup: ${o.pickupAddress || o.pickup || '—'}</div>
                    <div class="small muted">Dropoff: ${o.deliveryAddress || o.deliveryAddress || '—'}</div>
                    <div class="small muted">Item: ${o.itemType || (o.items && o.items[0] && o.items[0].itemType) || '—'}</div>`;
  const right = document.createElement('div'); right.className='flex flex-col gap-2';
  const fee = document.createElement('div'); fee.className='font-semibold'; fee.innerText = `₦${(o.finalPrice||o.pricePaid||0).toLocaleString()}`;
  const accept = document.createElement('button'); accept.className='btn'; accept.innerText='Accept';
  const decline = document.createElement('button'); decline.className='border px-3 py-1 rounded'; decline.innerText='Decline';
  accept.onclick = ()=> claimJob(id);
  decline.onclick = ()=> { el.remove(); };
  right.appendChild(fee); right.appendChild(accept); right.appendChild(decline);
  el.appendChild(left); el.appendChild(right);
  return el;
}

async function claimJob(orderId) {
  try {
    // POST /api/orders/:id/claim  (controller provided)
    const res = await apiFetch(`/api/orders/${orderId}/claim`, { method:'POST' });
    alert('Job claimed — now active.');
    const order = res.order || res;
    localStorage.setItem('su_active_order', JSON.stringify(order));
    openActive(order);
    // refresh feed immediately
    await loadFeed();
  } catch (e) {
    alert('Could not claim job: ' + e.message);
    await loadFeed();
  }
}

/* ---------- Active Order handling & status updates ---------- */
function openActive(order) {
  activeSection.classList.remove('hidden');
  showSection('active');
  fillActive(order);
  // start polling active order
  if (activePolling) clearInterval(activePolling);
  activePolling = setInterval(()=> pollActive(order._id || order.id), 5000);
  // start location watch if allowed
  startLocationWatch(order._id || order.id);
}
function fillActive(o) {
  const id = o._id || o.id;
  activeId.innerText = 'Order ' + String(id).slice(-8);
  activePickup.innerText = o.pickupAddress || o.pickup || '—';
  activeDropoff.innerText = o.deliveryAddress || o.deliveryAddress || '—';
  activeItem.innerText = o.itemType || (o.items && o.items[0] && o.items[0].itemType) || '—';
  activeFee.innerText = `₦${(o.finalPrice||o.pricePaid||0).toLocaleString()}`;
  // contact button
  const phone = (o.customer && o.customer.phone) || o.customerPhone || (o.contact && o.contact.phone) || null;
  if (phone) {
    callCustomer.onclick = ()=> window.location.href = `tel:${phone}`;
    callCustomer.classList.remove('opacity-50'); callCustomer.disabled = false;
  } else {
    callCustomer.onclick = ()=> alert('Customer phone not available yet.');
  }
  // navigation deep link
  navToPickup.onclick = ()=> {
    const dest = encodeURIComponent(o.pickupAddress || o.pickup || o.deliveryAddress || '');
    // geo deep link works on most mobile devices
    window.location.href = `geo:0,0?q=${dest}`;
  };
  // show action buttons depending on status
  updateActiveButtons(o.status || o.order?.status);
}

let activePolling = null;
async function pollActive(orderId) {
  try {
    const o = await apiFetch(`/api/orders/${orderId}`);
    fillActive(o);
  } catch (e) {
    console.info('Active poll error', e.message);
  }
}

function updateActiveButtons(status) {
  acceptComplete.classList.add('hidden'); markDelivered.classList.add('hidden');
  if (!status) return;
  // Use the status enum you provided in backend
  if (status === 'EnRouteToPickup' || status === 'EnRouteToDelivery') {
    acceptComplete.classList.remove('hidden'); acceptComplete.innerText = status === 'EnRouteToPickup' ? 'Confirm Picked Up' : 'Confirm Reached';
  }
  if (status === 'EnRouteToDelivery') {
    markDelivered.classList.remove('hidden'); markDelivered.innerText = 'Confirm Delivered';
  }
}

// picked up
acceptComplete.onclick = async ()=> {
  const active = JSON.parse(localStorage.getItem('su_active_order') || 'null');
  const id = active && (active._id||active.id);
  if (!id) return alert('No active order.');
  try {
    await apiFetch(`/api/orders/${id}/pickup`, { method:'PUT' });
    alert('Pickup confirmed.');
    await pollActive(id);
  } catch (e) { alert('Could not confirm pickup: ' + e.message); }
};

// delivered
markDelivered.onclick = async ()=> {
  const active = JSON.parse(localStorage.getItem('su_active_order') || 'null');
  const id = active && (active._id||active.id);
  if (!id) return alert('No active order.');
  try {
    await apiFetch(`/api/orders/${id}/deliver`, { method:'PUT' });
    alert('Delivery confirmed. Payout queued.');
    await pollActive(id);
    // clear active order
    localStorage.removeItem('su_active_order');
  } catch (e) { alert('Could not confirm delivery: ' + e.message); }
};

/* ---------- Live Location reporting ---------- */
let watchId = null;
function startLocationWatch(orderId) {
  if (!navigator.geolocation) { locStatus.innerText = 'unsupported'; return; }
  locStatus.innerText = 'on';
  // watch position and POST to server (best-effort)
  watchId = navigator.geolocation.watchPosition(async pos => {
    const { latitude, longitude } = pos.coords;
    // POST to an endpoint to save location — backend integration required.
    // I couldn't find a matching endpoint in the controllers you pasted; implement one server-side
    // (e.g., POST /api/agents/location or PUT /api/orders/:id/location) and update this URL.
    try {
      await fetch(API_BASE + '/api/agents/location', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', Authorization: `Bearer ${token}` },
        body: JSON.stringify({ agentId: me._id || me.id, orderId, lat: latitude, lng: longitude, ts: Date.now() })
      });
    } catch (err) {
      // ignore failures (server may not support this route). no spam alerts.
      // If you implement a server-side endpoint, this will start reporting live location.
    }
  }, err => {
    console.info('geolocation error', err.message);
    locStatus.innerText = 'denied';
  }, { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 });
}
function stopLocationWatch() {
  if (watchId !== null) navigator.geolocation.clearWatch(watchId);
  locStatus.innerText = 'off';
}

/* ---------- Earnings & History ---------- */
async function loadEarnings() {
  try {
    // Try /api/payouts?agentId=... (admin had /api/admin/payouts but there is a generic /api/payouts router)
    let payouts = [];
    try { payouts = await apiFetch(`/api/payouts?agentId=${me._id||me.id}`); } catch(_) { payouts = []; }
    payoutList.innerHTML = '';
    if (Array.isArray(payouts) && payouts.length) {
      payouts.forEach(p => {
        const el = document.createElement('div'); el.className='p-2 border rounded mb-2';
        el.innerHTML = `<div class="font-semibold">₦${(p.amount||0).toLocaleString()}</div><div class="small muted">${new Date(p.createdAt||p.date||Date.now()).toLocaleString()}</div>`;
        payoutList.appendChild(el);
      });
    } else {
      payoutList.innerHTML = '<div class="muted small">No payouts yet.</div>';
    }

    // Compute pending payouts by summing pendingPayout on user or orders
    try {
      // Try fetching user fresh profile (GET /api/users/profile)
      const profile = await apiFetch('/api/users/profile');
      pendingPayoutEl.innerText = `₦${Math.round(profile.pendingPayout || 0).toLocaleString()}`;
    } catch (_) {
      pendingPayoutEl.innerText = `₦${(me.pendingPayout||0).toLocaleString()}`;
    }
  } catch (e) {
    payoutList.innerHTML = `<div class="muted small">Could not load payouts: ${e.message}</div>`;
  }
}

async function loadHistory() {
  agentHistory.innerHTML = 'Loading…';
  try {
    // GET /api/orders?agentId=...
    const data = await apiFetch(`/api/orders?agentId=${me._id||me.id}`);
    const orders = Array.isArray(data) ? data : (data.orders || data.data || []);
    if (!orders || orders.length === 0) { agentHistory.innerHTML = '<div class="muted small">No deliveries yet.</div>'; return; }
    agentHistory.innerHTML = '';
    orders.slice().reverse().forEach(o=>{
      const el = document.createElement('div'); el.className = 'p-2 border rounded';
      el.innerHTML = `<div class="flex justify-between"><div class="font-semibold">Order ${String(o._id||o.id).slice(-6)}</div><div class="small muted">${o.status||'—'}</div></div>
                      <div class="small muted">₦${(o.finalPrice||o.pricePaid||0).toLocaleString()}</div>`;
      agentHistory.appendChild(el);
    });
  } catch (e) {
    agentHistory.innerHTML = `<div class="muted small">Could not load history: ${e.message}</div>`;
  }
}

/* ---------- Support / Report ---------- */
async function openSupportPrompt() {
  const txt = prompt('Describe your issue for admin support (this creates a ticket):');
  if (!txt) return;
  try {
    // best-effort: POST /api/admin-requests or /api/admin/requests (some apps differ)
    try { await apiFetch('/api/admin-requests', { method:'POST', body: JSON.stringify({ reason: txt }) }); alert('Support ticket created.'); return; } catch(_) {}
    await apiFetch('/api/admin/requests', { method:'POST', body: JSON.stringify({ reason: txt }) });
    alert('Support ticket created.');
  } catch (e) {
    alert('Could not create support ticket: ' + e.message);
  }
}

/* ---------- Helpers & UI flow ---------- */
function showSection(name) {
  feedSection.style.display = 'block';
  activeSection.style.display = 'none';
  earningsSection.style.display = 'none';
  historySection.style.display = 'none';
  if (name === 'feed') { feedSection.style.display = 'block'; }
  if (name === 'active') { activeSection.style.display = 'block'; }
  if (name === 'earnings') { earningsSection.style.display = 'block'; }
  if (name === 'history') { historySection.style.display = 'block'; }
}

// set initial visibility references
const feedSection = document.getElementById('feedSection');
feedSection.style.display='block';
activeSection.style.display='none';
earningsSection.style.display='none';
historySection.style.display='none';

/* ---------- Init: start polling feed, earnings and history ---------- */
let feedInterval = null;
let activeOrder = JSON.parse(localStorage.getItem('su_active_order') || 'null');

(async function init() {
  try {
    await loadFeed();
    feedInterval = setInterval(loadFeed, 8000);

    await loadEarnings();
    await loadHistory();

    if (activeOrder && (activeOrder._id || activeOrder.id)) {
      openActive(activeOrder);
    }
  } catch (e) {
    console.info('init err', e.message);
  }
})();

/* stop location watch when unload */
window.addEventListener('beforeunload', ()=> { if (watchId !== null) navigator.geolocation.clearWatch(watchId); });

</script>
</body>
</html>
